Imports Venus.Application.SystemFiles.System
Imports Venus.Application.SystemFiles.HumanResource
Imports System.Data
Imports System.Web.UI.WebControls
Imports Infragistics.WebUI.UltraWebGrid
Imports Infragistics.Web.UI.GridControls

Partial Class frmDistributedSalary
    Inherits MainPage

#Region "Protected Sub"

    Protected Sub Page_Load(sender As Object, e As System.EventArgs) Handles Me.Load

        If Not IsPostBack Then

            Dim PeriodId As String = Request.QueryString.Item("PeriodId")



            Dim ClsEmployee As New Clshrs_Employees(Page)
            Dim ClsFisicalYearsPeriods As New Clssys_FiscalYearsPeriods(Page)
            Dim ClsWebHandler As New Venus.Shared.Web.WebHandler
            Dim ClsNavigationHandler As New Venus.Shared.Web.NavigationHandler(ClsEmployee.ConnectionString)
            Dim IntSelectedPeriod As Integer = 0
            Dim IntModuleId As Integer = GetModuleID("frmPrepareSalaries")
            Dim clsBranch As New Clssys_Branches(Page)
            Dim ClsObjects As New Clssys_Objects(Page)
            Dim ClsSearchs As New Clssys_Searchs(Page)

            Dim clsSearchsColumns As New Clssys_SearchsColumns(Page)
            If ClsObjects.Find(" Code='" & ClsEmployee.Table.Trim & "'") Then
                If ClsSearchs.Find(" ObjectID='" & ClsObjects.ID & "'") Then
                    Dim IntDimension As Integer = 510
                    Dim UrlString = "'frmModalSearchScreen.aspx?TargetControl=" & txtCode.ID & "&SearchID=" & ClsSearchs.ID & "&'," & IntDimension & ",720,false,'" & txtCode.ClientID & "'"
                    btnSearchCode.ClientSideEvents.Click = "OpenModal1(" & UrlString & ")"
                End If

                Dim clsSponsor As New Clshrs_Sponsors(Page)
                If ClsObjects.Find(" Code='" & clsSponsor.Table.Trim & "'") Then
                    If ClsSearchs.Find(" ObjectID='" & ClsObjects.ID & "'") Then
                        Dim IntDimension As Integer = 510
                        Dim UrlString = "'frmModalSearchScreen.aspx?TargetControl=" & TextBox_Sponsor.ID & "&SearchID=" & ClsSearchs.ID & "&'," & IntDimension & ",720,false,'" & TextBox_Sponsor.ClientID & "'"
                        WebImageButton_Sponsor.ClientSideEvents.Click = "OpenModal1(" & UrlString & ")"
                    End If
                End If

            End If
            Dim ClsEmployeeTransactions As New Clshrs_EmployeesTransactions(Page)
            Dim StrCommandAll = " select et.ID,et.EmployeeID,et.PrepareType,e.Code as Code,(select isnull(count(hrs_EmployeesTransactions.ID),0) from hrs_EmployeesTransactions where hrs_EmployeesTransactions.ID = et.ID and hrs_EmployeesTransactions.PostDate is not null) as Locked,(select isnull(count(hrs_HrsTrans.ID),0) from hrs_HrsTrans where hrs_HrsTrans.RegComputerID = et.ID and hrs_HrsTrans.ProfileHeadID is not null) as GLPosted  from hrs_EmployeesTransactions et inner join hrs_Employees e on e.ID = et.EmployeeID INNER JOIN sys_FiscalYearsPeriodsModules as m ON m.FiscalYearPeriodID=et.FiscalYearPeriodID where e.CancelDate is null and  m.ModuleID=" & GetModuleID("frmPrepareSalaries") & " And IsNull(m.CloseDate,'')='' And et.FiscalYearPeriodID=" & PeriodId
            Dim dsEmployee As New Data.DataSet
            dsEmployee = Microsoft.ApplicationBlocks.Data.SqlHelper.ExecuteDataset(ClsEmployee.ConnectionString, Data.CommandType.Text, StrCommandAll)
            Dim StrIDsArray As String = "0"
            For Each row As DataRow In dsEmployee.Tables(0).Rows
                If row("PrepareType").ToString() = ClsNavigationHandler.SetLanguage(Me, "Select All/تحديد الكل") Then
                    Continue For
                End If

                ClsEmployeeTransactions.Find("ID=" & row("ID").ToString())

                If ClsEmployeeTransactions.ID > 0 Then
                    ' إذا كان مقفل ولم يتم ترحيله
                    If Convert.ToInt32(row("Locked")) = 1 Then ' And Convert.ToInt32(row("GLPosted")) = 0 Then
                        StrIDsArray &= "," & ClsEmployeeTransactions.ID
                    End If
                End If
            Next
            Dim IDs As String = StrIDsArray
            Dim StrCommand As String = "Select distinct TransactionID from hrs_HrsTrans where RegComputerID in (" & IDs & ")"

            Dim dsPatches As New Data.DataSet
            dsPatches = Microsoft.ApplicationBlocks.Data.SqlHelper.ExecuteDataset(ClsEmployee.ConnectionString, Data.CommandType.Text, StrCommand)
            Dim StrIDArray As String = "0"
            If dsPatches.Tables(0).Rows.Count > 0 Then
                For Each drdatarow As Data.DataRow In dsPatches.Tables(0).Rows
                    StrIDArray = StrIDArray & "," & drdatarow("TransactionID")
                Next


            End If

            ddlDepartment.Attributes.Add("OnChange", "ddlDepartment_Change()")
            Dim ClsDepartment As New ClsBasicFiles(Me.Page, "sys_Departments")
            Dim ClsSectors As New ClsBasicFiles(Me.Page, "sys_Sectors")

            ClsDepartment.GetDropDownList(ddlDepartment, True)
            ddlDepartment.Items(0).Text = ClsNavigationHandler.SetLanguage(Page, "[All Departments]/ [ جميع الإدارات]")

            ClsSectors.GetDropDownList(ddlsector, True)
            ddlsector.Items(0).Text = ClsNavigationHandler.SetLanguage(Page, "[All Sectors]/ [ جميع القطاعات]")


            clsBranch.GetDropDownList(ddlBranche, True, "sys_CompaniesBranches.CompanyID=" & clsBranch.MainCompanyID & " And UserID=" & clsBranch.DataBaseUserRelatedID & " AND CanView= 1")
            ddlBranche.Items(0).Text = ClsNavigationHandler.SetLanguage(Page, "[All Branches]/ [ جميع الفروع]")
            ddlBranche.SelectedIndex = 1
            ClsFisicalYearsPeriods.GetDropDownList(DdlPeriods, IntModuleId, True, "")

            IntSelectedPeriod = ClsFisicalYearsPeriods.GetLastOpenedFiscalPieriod(IntModuleId)

            Dim periodDatedt As DateTime = DateTime.Now.Date

            If CInt(PeriodId) > 0 Then
                DdlPeriods.SelectedValue = PeriodId
                Dim stri = "select FromDate from sys_FiscalYearsPeriods where ID=" & PeriodId
                Dim myDate As String = Microsoft.ApplicationBlocks.Data.SqlHelper.ExecuteScalar(ClsEmployee.ConnectionString, Data.CommandType.Text, stri)
                periodDatedt = CDate(myDate)
            End If
            Dim periodDate = periodDatedt.ToString("yyyy-MM-dd")
            lblLage.Text = ClsNavigationHandler.SetLanguage(Page, "0/1")
            Page.Session.Add("Lage", lblLage.Text)
            Page.Session.Add("ConnectionString", ClsEmployee.ConnectionString)

            'Dim MYCommandstr As String = "   SELECT        '2124100' LedgerCode      ,'010100'  collate Arabic_CI_AS CostCenter1Code, '' as CostCenter1Name		  ,'9999'    collate Arabic_CI_AS CostCenter2Code  ,'' as CostCenter2Name    ,' رواتب شهر ' + CAST(MONTH('" & periodDate & "') AS VARCHAR(50)) + ' لعام '  + CAST(YEAR('" & periodDate & "') AS VARCHAR(50)) + '   '  collate Arabic_CI_AS  ArbDesc  ,0 as Debit   , SUM(Amount*TT.Sign) Credit     FROM hrs_HrsTrans HRT	  LEFT JOIN fcs_CostCenters1 C ON HRT.Cost1 = C.ID	  LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID	LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID	  INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	  INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID   WHERE      TT.IsPaid = 1                   AND HRT.PrepareType = 'N'   AND TransactionID in(" & StrIDArray & ") AND TT.COde NOT IN ('176','201')   GROUP BY  pr.Code,pr.CostCenterCode1  UNION ALL         SELECT        '2125001' LedgerCode      ,'010100'  collate Arabic_CI_AS CostCenter1Code	,'' as CostCenter1Name  ,'9999'    collate Arabic_CI_AS CostCenter2Code  ,'' as CostCenter2Name    ,'حوافز رواتب شهر' + CAST(MONTH('" & periodDate & "') AS VARCHAR(50)) + ' لعام '  + CAST(YEAR('" & periodDate & "') AS VARCHAR(50)) + '   '  collate Arabic_CI_AS  ArbDesc     ,0 as Debit  , SUM(Amount*TT.Sign) Credit    FROM hrs_HrsTrans HRT	  LEFT JOIN fcs_CostCenters1 C ON HRT.Cost1 = C.ID	  LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID	  LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID	  INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	  INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID WHERE      TT.IsPaid = 1      AND HRT.PrepareType = 'N'     AND TransactionID in(" & StrIDArray & ") AND TT.COde  IN ('176')      GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1         union all  SELECT        '2124200' LedgerCode      ,'010100'  collate Arabic_CI_AS CostCenter1Code	, '' as CostCenter1Name	  ,'9999'    collate Arabic_CI_AS CostCenter2Code  ,''as CostCenter2Name    ,'اضافي رواتب شهر' + CAST(MONTH('" & periodDate & "') AS VARCHAR(50)) + ' لعام '  + CAST(YEAR('" & periodDate & "') AS VARCHAR(50)) + '   '  collate Arabic_CI_AS  ArbDesc    ,0 as Debit  , SUM(Amount*TT.Sign) Credit     FROM hrs_HrsTrans HRT	  LEFT JOIN fcs_CostCenters1 C ON HRT.Cost1 = C.ID	  LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID	  LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID	  INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	  INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID   WHERE      TT.IsPaid = 1      AND HRT.PrepareType = 'N'     AND TransactionID in(" & StrIDArray & ")	AND TT.COde  IN ('201')  GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1   union all	Select	 '3111001' LedgerCode	    ,c.code collate Arabic_CI_AS CostCenter1Code 	,c.ArbName4s as CostCenter1Name	,e.code  collate Arabic_CI_AS  CostCenter2Code 	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name	,'راتب اساسى & Basic Salaries'  collate Arabic_CI_AS  ArbDesc 	    ,Sum(Amount) Debit,0 as Credit from		hrs_HrsTrans HRT INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID	LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   	LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID LEFT JOIN  hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE TransactionID in(" & StrIDArray & ")  AND TT.COde IN ('11')	GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1,c.ArbName4s       ,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S  UNION ALL		select	 	'3111002' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code	,c.ArbName4s as CostCenter1Name		,e.code  collate Arabic_CI_AS  CostCenter2Code	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name ,'بدل سكن شهري & Housing Allowance'  collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT			INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID	LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	WHERE	     TransactionID in(" & StrIDArray & ") AND TT.COde IN ('13')	GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1	,c.ArbName4s,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL select	 	'3111003' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code	,c.ArbName4s as CostCenter1Name		,e.code collate Arabic_CI_AS    CostCenter2Code	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name	,'بدل مواصلات & Transportation Allowance' collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	 INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  		LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID	LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID		     WHERE	TransactionID in(" & StrIDArray & ") AND TT.COde IN ('14')		GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1	,c.ArbName4s ,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL		select	 	'3111004' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code ,c.ArbName4s	as CostCenter1Name		,e.code collate Arabic_CI_AS    CostCenter2Code	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name	,'بدل طعام & Food Allowance'  collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from	hrs_HrsTrans HRT	  		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   	LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID	LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID	INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE	 TransactionID in(" & StrIDArray & ") AND TT.COde IN ('15')		GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1	,c.ArbName4s,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL	select	 	'3112006' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code 	,c.ArbName4s as CostCenter1Name		,e.code  collate Arabic_CI_AS   CostCenter2Code	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name	,'بدلات اخري & Other Allowance'  collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   		LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID	LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID		WHERE	TransactionID in(" & StrIDArray & ") AND TT.COde IN ('17')		GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1	,c.ArbName4s	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL	select		  '' LedgerCode		,'' CostCenter1Code  		,'' as CostCenter1Name	,'' CostCenter2Code		,'' as CostCenter2Name,'بدل تليفون & Tel  Allowance'  collate Arabic_CI_AS ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT			INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('175')		GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1		UNION ALL	select	 	 '' LedgerCode		,'' CostCenter1Code  	,'' as CostCenter1Name		,'' CostCenter2Code	,'' as CostCenter2Name	,'بدل غسيل سيارة & Car Wash  Allowance'  collate Arabic_CI_AS ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	 	INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   		LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	WHERE	TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('171')		GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1	UNION ALL	select		  '3112003' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code  	,c.ArbName4s as CostCenter1Name		,e.code collate Arabic_CI_AS    CostCenter2Code		,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name,'حوافز  & Incentives Bonuses'  collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	  		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID 	LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE	TransactionID in(" & StrIDArray & ") AND TT.COde IN ('176')		GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1	,c.ArbName4s,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL		select	 	 '3112001' LedgerCode	,c.code collate Arabic_CI_AS CostCenter1Code 	,c.ArbName4s as CostCenter1Name		,e.code  collate Arabic_CI_AS   CostCenter2Code		,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name ,'الاضافي& Overtime'  collate Arabic_CI_AS ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	 	INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  	LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE TransactionID in(" & StrIDArray & ") AND TT.COde IN ('201')	GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1	,c.ArbName4s,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL	select	  '' LedgerCode		,'' CostCenter1Code  	,'' as CostCenter1Name		,'' CostCenter2Code	,'' as CostCenter2Name,'Incentives Bonuses'  collate Arabic_CI_AS  ArbDesc	,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	    INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  		LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	WHERE		TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('99999')		GROUP BY TT.ArbName,c2.code, pr.Code,pr.CostCenterCode1  UNION ALL  		select	 '1144000' LedgerCode		,c.code collate Arabic_CI_AS Center1Code	,c.ArbName4s as CostCenter1Name		,e.code  collate Arabic_CI_AS   CostCenter2Code		,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name ,'Staff Loans'  collate Arabic_CI_AS ArbDesc	,0 as Debit,Sum(Amount) Credit	from		hrs_HrsTrans HRT		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID	 LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID   		WHERE		TT.Code IN ('22')		AND TransactionID in(" & StrIDArray & ")	GROUP BY TT.ArbName,e.Code,c.code		,c.ArbName4s,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL 	select	 	'2124903' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code	,c.ArbName4s as CostCenter1Name		,e.code   collate Arabic_CI_AS  CostCenter2Code	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name	,'Accrued GOSI Insurance 9.75 % Staff '  collate Arabic_CI_AS ArbDesc		,0 as Debit,Sum(Amount) Credit  from		hrs_HrsTrans HRT		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID		LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID   	WHERE		TT.Code IN ('231') AND TransactionID in(" & StrIDArray & ")GROUP BY TT.ArbName,e.Code,c.code,c.ArbName4s,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL	select	 	 '3111001' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code ,c.ArbName4s as CostCenter1Name			,e.code  collate Arabic_CI_AS   CostCenter2Code	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name	,'Late'  collate Arabic_CI_AS  ArbDesc	 ,0 as Debit	,Sum(Amount) Credit	from		hrs_HrsTrans HRT	  		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE		TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('26')		GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1 	,c.ArbName4s ,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL      select	 	 '3111001' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code 	,c.ArbName4s as CostCenter1Name		,e.code  collate Arabic_CI_AS   CostCenter2Code	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name	,'ABSENT'  collate Arabic_CI_AS ArbDesc	,0 as Debit,Sum(Amount) Credit	from	    hrs_HrsTrans HRT	  		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE TransactionID in(" & StrIDArray & ") AND  TT.COde IN ('27')	GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1			,c.ArbName4s ,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL    select	 	 '3111001' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code ,c.ArbName4s as CostCenter1Name			,e.code collate Arabic_CI_AS    CostCenter2Code	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name	,'Other Deductions'  collate Arabic_CI_AS ArbDesc		,0 as Debit	,Sum(Amount) Credit	from		hrs_HrsTrans HRT	   		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   		LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	 WHERE		TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('24')		GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1             ,c.ArbName4s   ,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S  	  UNION ALL select	 	 '3111001' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code ,c.ArbName4s as CostCenter1Name	 	,e.code collate Arabic_CI_AS    CostCenter2Code	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name	,'Punishment'  collate Arabic_CI_AS ArbDesc	,0 as Debit	,Sum(Amount) Credit	from		hrs_HrsTrans HRT			INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  		LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE		TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('242')		GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1 ,c.ArbName4s       ,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S                                 "
            Dim MYCommandstr As String = "" _
    & "          Select '2124100' LedgerCode      ,'010100'  collate Arabic_CI_AS CostCenter1Code, '' as CostCenter1Name		  ,'0'    collate Arabic_CI_AS CostCenter2Code  ,'' as CostCenter2Name ,'0' collate Arabic_CI_AS CostCenter3Code,'' as CostCenter3Name    ,' رواتب شهر ' + CAST(MONTH('" & periodDate & "') AS VARCHAR(50)) + ' لعام '  + CAST(YEAR('" & periodDate & "') AS VARCHAR(50)) + '   '  collate Arabic_CI_AS  ArbDesc  ,0 as Debit   , SUM(Amount*TT.Sign) Credit     FROM hrs_HrsTrans HRT	  LEFT JOIN fcs_CostCenters1 C ON HRT.Cost1 = C.ID	  LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON HRT.Cost3 = C3.ID	LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID	  INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	  INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID   WHERE      TT.IsPaid = 1                   AND HRT.PrepareType = 'N'   AND TransactionID in(" & StrIDArray & ") AND TT.COde NOT IN ('176','201')   GROUP BY  pr.Code,pr.CostCenterCode1 " _
    & " UNION ALL         SELECT        '2125001' LedgerCode      ,'010100'  collate Arabic_CI_AS CostCenter1Code	,'' as CostCenter1Name  ,'0'    collate Arabic_CI_AS CostCenter2Code  ,'' as CostCenter2Name  ,'0' collate Arabic_CI_AS CostCenter3Code,'' as CostCenter3Name  ,'حوافز رواتب شهر' + CAST(MONTH('" & periodDate & "') AS VARCHAR(50)) + ' لعام '  + CAST(YEAR('" & periodDate & "') AS VARCHAR(50)) + '   '  collate Arabic_CI_AS  ArbDesc     ,0 as Debit  , SUM(Amount*TT.Sign) Credit    FROM hrs_HrsTrans HRT	  LEFT JOIN fcs_CostCenters1 C ON HRT.Cost1 = C.ID	  LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON HRT.Cost3 = C3.ID	  LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID	  INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	  INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID WHERE      TT.IsPaid = 1      AND HRT.PrepareType = 'N'     AND TransactionID in(" & StrIDArray & ") AND TT.COde  IN ('176')      GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName " _
    & "  union all  SELECT        '2124200' LedgerCode      ,'010100'  collate Arabic_CI_AS CostCenter1Code	, '' as CostCenter1Name	  ,'0'    collate Arabic_CI_AS CostCenter2Code  ,''as CostCenter2Name  ,'0' collate Arabic_CI_AS CostCenter3Code,'' as CostCenter3Name  ,'اضافي رواتب شهر' + CAST(MONTH('" & periodDate & "') AS VARCHAR(50)) + ' لعام '  + CAST(YEAR('" & periodDate & "') AS VARCHAR(50)) + '   '  collate Arabic_CI_AS  ArbDesc    ,0 as Debit  , SUM(Amount*TT.Sign) Credit     FROM hrs_HrsTrans HRT	  LEFT JOIN fcs_CostCenters1 C ON HRT.Cost1 = C.ID	  LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON HRT.Cost3 = C3.ID	  LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID	  INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	  INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID   WHERE      TT.IsPaid = 1      AND HRT.PrepareType = 'N'     AND TransactionID in(" & StrIDArray & ")	AND TT.COde  IN ('201')  GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName" _
    & "  union all	Select	 '3111001' LedgerCode	    ,c.code collate Arabic_CI_AS CostCenter1Code 	,c.ArbName as CostCenter1Name	,C2.code    collate Arabic_CI_AS CostCenter2Code  ,c2.ArbName as CostCenter2Name,C3.code  collate Arabic_CI_AS  CostCenter3Code 	,c3.ArbName as CostCenter3Name	,'راتب اساسى & Basic Salaries'  collate Arabic_CI_AS  ArbDesc 	    ,Sum(Amount) Debit,0 as Credit from		hrs_HrsTrans HRT INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID	LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   	LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID  LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID LEFT JOIN  hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE TransactionID in(" & StrIDArray & ")  AND TT.COde IN ('11')	GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName,c.ArbName ,c3.Code ,c2.ArbName     ,c3.ArbName " _
    & " UNION ALL		select	 	'3111002' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code	,c.ArbName as CostCenter1Name		,c2.code  collate Arabic_CI_AS  CostCenter2Code	,c2.ArbName as CostCenter2Name ,c3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name   ,'بدل سكن شهري & Housing Allowance'  collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT			INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID	LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	WHERE	     TransactionID in(" & StrIDArray & ") AND TT.COde IN ('13')	GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName	,c.ArbName,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL select	 	'3111003' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code	,c.ArbName as CostCenter1Name		,C2.Code collate Arabic_CI_AS    CostCenter2Code	,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  	,'بدل مواصلات & Transportation Allowance' collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	 INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  		LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID	LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID		     WHERE	TransactionID in(" & StrIDArray & ") AND TT.COde IN ('14')		GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName	,c.ArbName ,c2.ArbName,c3.Code,c3.ArbName " _
    & "  UNION ALL		select	 	'3111004' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code ,c.ArbName	as CostCenter1Name		,C2.Code collate Arabic_CI_AS    CostCenter2Code	,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  	,'بدل طعام & Food Allowance'  collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from	hrs_HrsTrans HRT	  		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   	LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID	LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID	INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE	 TransactionID in(" & StrIDArray & ") AND TT.COde IN ('15')		GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName	,c.ArbName,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL	select	 	'3112006' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code 	,c.ArbName as CostCenter1Name		,C2.Code  collate Arabic_CI_AS   CostCenter2Code	,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  	,'بدلات اخري & Other Allowance'  collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   		LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID	LEFT JOIN fcs_CostCenters3 C3 ON e.Cost2 = C3.ID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID		WHERE	TransactionID in(" & StrIDArray & ") AND TT.COde IN ('17')		GROUP BY TT.ArbName,c.code,C2.Code, c.ArbName	,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL	select		  '' LedgerCode		,'' CostCenter1Code  		,'' as CostCenter1Name	,'' CostCenter2Code		,'' as CostCenter2Name ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  ,'بدل تليفون & Tel  Allowance'  collate Arabic_CI_AS ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT			INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('175')		GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName	" _
    & " UNION ALL	select	 	 '' LedgerCode		,'' CostCenter1Code  	,'' as CostCenter1Name		,'' CostCenter2Code	,'' as CostCenter2Name ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  	,'بدل غسيل سيارة & Car Wash  Allowance'  collate Arabic_CI_AS ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	 	INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   		LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	WHERE	TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('171')		GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL	select		  '3112003' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code  	,c.ArbName as CostCenter1Name		,C2.Code collate Arabic_CI_AS    CostCenter2Code		,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  ,'حوافز  & Incentives Bonuses'  collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	  		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID 	LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE	TransactionID in(" & StrIDArray & ") AND TT.COde IN ('176')		GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName	,c.ArbName,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL		select	 	 '3112001' LedgerCode	,c.code collate Arabic_CI_AS CostCenter1Code 	,c.ArbName as CostCenter1Name		,C2.Code  collate Arabic_CI_AS   CostCenter2Code		,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name   ,'الاضافي& Overtime'  collate Arabic_CI_AS ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	 	INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  	LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE TransactionID in(" & StrIDArray & ") AND TT.COde IN ('201')	GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName	,c.ArbName,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL	select	  '' LedgerCode		,'' CostCenter1Code  	,'' as CostCenter1Name		,'' CostCenter2Code	,'' as CostCenter2Name ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  ,'Incentives Bonuses'  collate Arabic_CI_AS  ArbDesc	,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	    INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  		LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	WHERE		TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('99999')		GROUP BY TT.ArbName,c2.code,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL  		select	 '1144000' LedgerCode		,c.code collate Arabic_CI_AS Center1Code	,c.ArbName as CostCenter1Name		,C2.Code  collate Arabic_CI_AS   CostCenter2Code		,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name   ,'Staff Loans'  collate Arabic_CI_AS ArbDesc	,0 as Debit,Sum(Amount) Credit	from		hrs_HrsTrans HRT		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID	 LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID   		WHERE		TT.Code IN ('22')		AND TransactionID in(" & StrIDArray & ")	GROUP BY TT.ArbName,C2.Code,c.code		,c.ArbName,c2.ArbName,c3.Code,c3.ArbName  " _
    & " UNION ALL 	select	 	'2124903' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code	,c.ArbName as CostCenter1Name		,C2.Code   collate Arabic_CI_AS  CostCenter2Code	,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  	,'Accrued GOSI Insurance 9.75 % Staff '  collate Arabic_CI_AS ArbDesc		,0 as Debit,Sum(Amount) Credit  from		hrs_HrsTrans HRT		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID		LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID   	WHERE		TT.Code IN ('231') AND TransactionID in(" & StrIDArray & ")GROUP BY TT.ArbName,C2.Code,c.code,c.ArbName,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL	select	 	 '3111001' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code ,c.ArbName as CostCenter1Name			,C2.Code  collate Arabic_CI_AS   CostCenter2Code	,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  	,'Late'  collate Arabic_CI_AS  ArbDesc	 ,0 as Debit	,Sum(Amount) Credit	from		hrs_HrsTrans HRT	  		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE		TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('26')		GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName 	,c.ArbName ,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL      select	 	 '3111001' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code 	,c.ArbName as CostCenter1Name		,C2.Code  collate Arabic_CI_AS   CostCenter2Code	,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  	,'ABSENT'  collate Arabic_CI_AS ArbDesc	,0 as Debit,Sum(Amount) Credit	from	    hrs_HrsTrans HRT	  		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE TransactionID in(" & StrIDArray & ") AND  TT.COde IN ('27')	GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName			,c.ArbName ,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL    select	 	 '3111001' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code ,c.ArbName as CostCenter1Name			,C2.Code collate Arabic_CI_AS    CostCenter2Code	,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  	,'Other Deductions'  collate Arabic_CI_AS ArbDesc		,0 as Debit	,Sum(Amount) Credit	from		hrs_HrsTrans HRT	   		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   		LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	 WHERE		TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('24')		GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName             ,c.ArbName   ,c2.ArbName,c3.Code,c3.ArbName 	" _
    & " UNION ALL select	 	 '3111001' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code ,c.ArbName as CostCenter1Name	 	,C2.Code collate Arabic_CI_AS    CostCenter2Code	,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  	,'Punishment'  collate Arabic_CI_AS ArbDesc	,0 as Debit	,Sum(Amount) Credit	from		hrs_HrsTrans HRT			INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  		LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE		TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('242')		GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName ,c.ArbName       ,c2.ArbName,c3.Code,c3.ArbName        "
            Dim dsProjects As New Data.DataSet
            dsProjects = Microsoft.ApplicationBlocks.Data.SqlHelper.ExecuteDataset(ClsEmployee.ConnectionString, Data.CommandType.Text, MYCommandstr)

            '' Calculate totals
            'Dim dt = dsProjects.Tables(0)
            'Dim totalDebit As Decimal = dt.AsEnumerable().Sum(Function(r) Convert.ToDecimal(r("Debit")))
            'Dim totalCredit As Decimal = dt.AsEnumerable().Sum(Function(r) Convert.ToDecimal(r("Credit")))

            '' Add summary row
            'Dim summaryRow As DataRow = dt.NewRow()
            'summaryRow("LedgerCode") = "Total"
            'summaryRow("Debit") = totalDebit
            'summaryRow("Credit") = totalCredit

            'dt.Rows.InsertAt(summaryRow, 0) ' Insert at the top

            'grdProjects.DataSource = dt
            'grdProjects.DataBind()

            grdProjects.DataSource = dsProjects.Tables(0)
            grdProjects.DataBind()
        End If
    End Sub

    Private Function GetModuleID(ByVal TableName As String) As Integer
        Dim ClsForms As New ClsSys_Forms(Me.Page)
        Dim IntModuleID As Integer
        ClsForms.Find(" Code = '" & TableName & "'")
        If ClsForms.ID > 0 Then
            IntModuleID = ClsForms.ModuleID
        End If
        Return IntModuleID
    End Function

#End Region

#Region "Private Function"

    Protected Sub grdProjects_InitializeLayout(ByVal sender As Object, ByVal e As Infragistics.WebUI.UltraWebGrid.LayoutEventArgs) Handles grdProjects.InitializeLayout

        'Me.grdProjects.Browser = Infragistics.WebUI.UltraWebGrid.BrowserLevel.Xml
        'Me.grdProjects.DisplayLayout.LoadOnDemand = Infragistics.WebUI.UltraWebGrid.LoadOnDemand.Xml
        Me.grdProjects.DisplayLayout.ViewType = Infragistics.WebUI.UltraWebGrid.ViewType.Flat
        Me.grdProjects.Bands(0).FilterOptions.AllowRowFiltering = Infragistics.WebUI.UltraWebGrid.RowFiltering.OnClient
        Me.grdProjects.Bands(0).FilterOptions.RowFilterMode = Infragistics.WebUI.UltraWebGrid.RowFilterMode.SiblingRowsOnly
        Me.grdProjects.Bands(0).FilterOptions.ShowAllCondition = Infragistics.WebUI.UltraWebGrid.ShowFilterString.Yes
        Me.grdProjects.Bands(0).FilterOptions.ShowEmptyCondition = Infragistics.WebUI.UltraWebGrid.ShowFilterString.Yes
        Me.grdProjects.Bands(0).FilterOptions.ShowNonEmptyCondition = Infragistics.WebUI.UltraWebGrid.ShowFilterString.Yes


    End Sub

    Private totalDebit As Decimal = 0
    Private totalCredit As Decimal = 0

    Protected Sub grdProjects_InitializeRow(ByVal sender As Object, ByVal e As Infragistics.WebUI.UltraWebGrid.RowEventArgs) Handles grdProjects.InitializeRow
        ' Sum values
        totalDebit += Convert.ToDecimal(e.Row.Cells.FromKey("Debit").Value)
        totalCredit += Convert.ToDecimal(e.Row.Cells.FromKey("Credit").Value)

        txtCredit.Text = totalCredit
        txtDebitCode.Text = totalDebit

    End Sub

    Protected Sub DdlPeriods_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles DdlPeriods.SelectedIndexChanged, ddlsector.SelectedIndexChanged, ddlsector.SelectedIndexChanged


        GetData()
    End Sub

    Protected Sub btnSearch_Click(sender As Object, e As Infragistics.WebUI.WebDataInput.ButtonEventArgs) Handles btnFind.Click
        GetData()
    End Sub



    Protected Sub ddlDepartment_SelectedIndexChanged(sender As Object, e As EventArgs) Handles ddlDepartment.SelectedIndexChanged
        If ddlDepartment.SelectedValue <> 0 Then
            Dim ClsSector As New ClsSys_Sectors(Me.Page)
            ClsSector.GetDropDownList(ddlsector, True, "ID in (select SectorID from sys_SectorsDepartments where Checked = 1 and DepartmentID = " & ddlDepartment.SelectedValue & ")")
            ddlDepartment.Focus()
        End If
    End Sub

    Protected Sub ddlFilter_SelectedIndexChanged(sender As Object, e As EventArgs) Handles ddlFilter.SelectedIndexChanged
        GetData()
    End Sub
    Protected Sub ddlBranche_SelectedIndexChanged(sender As Object, e As EventArgs) Handles ddlBranche.SelectedIndexChanged
        GetData()
    End Sub

    Private Sub GetData()

        Dim PeriodId As String = Request.QueryString.Item("PeriodId")
        Dim ClsEmployee As New Clshrs_Employees(Page)
        Dim ClsWebHandler As New Venus.Shared.Web.WebHandler
        Dim ClsNavigationHandler As New Venus.Shared.Web.NavigationHandler(ClsEmployee.ConnectionString)

        Dim ClsEmployeeTransactions As New Clshrs_EmployeesTransactions(Page)
        Dim StrCommandAll = " select et.ID,et.EmployeeID,et.PrepareType,e.Code as Code,(select isnull(count(hrs_EmployeesTransactions.ID),0) from hrs_EmployeesTransactions where hrs_EmployeesTransactions.ID = et.ID and hrs_EmployeesTransactions.PostDate is not null) as Locked,(select isnull(count(hrs_HrsTrans.ID),0) from hrs_HrsTrans where hrs_HrsTrans.RegComputerID = et.ID and hrs_HrsTrans.ProfileHeadID is not null) as GLPosted  from hrs_EmployeesTransactions et inner join hrs_Employees e on e.ID = et.EmployeeID INNER JOIN sys_FiscalYearsPeriodsModules as m ON m.FiscalYearPeriodID=et.FiscalYearPeriodID where e.CancelDate is null and  m.ModuleID=" & GetModuleID("frmPrepareSalaries") & " And IsNull(m.CloseDate,'')='' And et.FiscalYearPeriodID=" & PeriodId
        Dim dsEmployee As New Data.DataSet
        dsEmployee = Microsoft.ApplicationBlocks.Data.SqlHelper.ExecuteDataset(ClsEmployee.ConnectionString, Data.CommandType.Text, StrCommandAll)

        Dim StrIDsArray As String = "0"
        For Each row As DataRow In dsEmployee.Tables(0).Rows
            If row("PrepareType").ToString() = ClsNavigationHandler.SetLanguage(Me, "Select All/تحديد الكل") Then
                Continue For
            End If

            ClsEmployeeTransactions.Find("ID=" & row("ID").ToString())

            If ClsEmployeeTransactions.ID > 0 Then
                ' إذا كان مقفل ولم يتم ترحيله
                If Convert.ToInt32(row("Locked")) = 1 Then ' And Convert.ToInt32(row("GLPosted")) = 0 Then
                    StrIDsArray &= "," & ClsEmployeeTransactions.ID
                End If
            End If
        Next
        Dim IDs As String = StrIDsArray
        'Dim IDs As String = Request.QueryString.Item("IDs")
        Dim StrCommand As String = "Select distinct TransactionID from hrs_HrsTrans where RegComputerID in (" & IDs & ")"


        Dim ClsFisicalYearsPeriods As New Clssys_FiscalYearsPeriods(Page)
        Dim IntModuleId As Integer = GetModuleID("frmPrepareSalaries")
        Dim clsBranch As New Clssys_Branches(Page)
        Dim ClsObjects As New Clssys_Objects(Page)
        Dim ClsSearchs As New Clssys_Searchs(Page)
        Dim dsPatches As New Data.DataSet
        dsPatches = Microsoft.ApplicationBlocks.Data.SqlHelper.ExecuteDataset(ClsEmployee.ConnectionString, Data.CommandType.Text, StrCommand)
        Dim StrIDArray As String = "0"
        If dsPatches.Tables(0).Rows.Count > 0 Then
            For Each drdatarow As Data.DataRow In dsPatches.Tables(0).Rows
                StrIDArray = StrIDArray & "," & drdatarow("TransactionID")
            Next


        End If



        Dim periodDatedt As DateTime = DateTime.Now.Date

        If CInt(PeriodId) > 0 Then
            DdlPeriods.SelectedValue = PeriodId
            Dim stri = "select FromDate from sys_FiscalYearsPeriods where ID=" & PeriodId
            Dim myDate As String = Microsoft.ApplicationBlocks.Data.SqlHelper.ExecuteScalar(ClsEmployee.ConnectionString, Data.CommandType.Text, stri)
            periodDatedt = CDate(myDate)
        End If
        Dim periodDate = periodDatedt.ToString("yyyy-MM-dd")
        lblLage.Text = ClsNavigationHandler.SetLanguage(Page, "0/1")
        Page.Session.Add("Lage", lblLage.Text)
        Page.Session.Add("ConnectionString", ClsEmployee.ConnectionString)

        'Dim MYCommandstr As String = "   SELECT        '2124100' LedgerCode      ,'010100'  collate Arabic_CI_AS CostCenter1Code, '' as CostCenter1Name		  ,'9999'    collate Arabic_CI_AS CostCenter2Code  ,'' as CostCenter2Name    ,' رواتب شهر ' + CAST(MONTH('" & periodDate & "') AS VARCHAR(50)) + ' لعام '  + CAST(YEAR('" & periodDate & "') AS VARCHAR(50)) + '   '  collate Arabic_CI_AS  ArbDesc  ,0 as Debit   , SUM(Amount*TT.Sign) Credit     FROM hrs_HrsTrans HRT	  LEFT JOIN fcs_CostCenters1 C ON HRT.Cost1 = C.ID	  LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID	LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID	  INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	  INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID   WHERE      TT.IsPaid = 1                   AND HRT.PrepareType = 'N'   AND TransactionID in(" & StrIDArray & ") AND TT.COde NOT IN ('176','201')   GROUP BY  pr.Code,pr.CostCenterCode1  UNION ALL         SELECT        '2125001' LedgerCode      ,'010100'  collate Arabic_CI_AS CostCenter1Code	,'' as CostCenter1Name  ,'9999'    collate Arabic_CI_AS CostCenter2Code  ,'' as CostCenter2Name    ,'حوافز رواتب شهر' + CAST(MONTH('" & periodDate & "') AS VARCHAR(50)) + ' لعام '  + CAST(YEAR('" & periodDate & "') AS VARCHAR(50)) + '   '  collate Arabic_CI_AS  ArbDesc     ,0 as Debit  , SUM(Amount*TT.Sign) Credit    FROM hrs_HrsTrans HRT	  LEFT JOIN fcs_CostCenters1 C ON HRT.Cost1 = C.ID	  LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID	  LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID	  INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	  INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID WHERE      TT.IsPaid = 1      AND HRT.PrepareType = 'N'     AND TransactionID in(" & StrIDArray & ") AND TT.COde  IN ('176')      GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1         union all  SELECT        '2124200' LedgerCode      ,'010100'  collate Arabic_CI_AS CostCenter1Code	, '' as CostCenter1Name	  ,'9999'    collate Arabic_CI_AS CostCenter2Code  ,''as CostCenter2Name    ,'اضافي رواتب شهر' + CAST(MONTH('" & periodDate & "') AS VARCHAR(50)) + ' لعام '  + CAST(YEAR('" & periodDate & "') AS VARCHAR(50)) + '   '  collate Arabic_CI_AS  ArbDesc    ,0 as Debit  , SUM(Amount*TT.Sign) Credit     FROM hrs_HrsTrans HRT	  LEFT JOIN fcs_CostCenters1 C ON HRT.Cost1 = C.ID	  LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID	  LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID	  INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	  INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID   WHERE      TT.IsPaid = 1      AND HRT.PrepareType = 'N'     AND TransactionID in(" & StrIDArray & ")	AND TT.COde  IN ('201')  GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1   union all	Select	 '3111001' LedgerCode	    ,c.code collate Arabic_CI_AS CostCenter1Code 	,c.ArbName4s as CostCenter1Name	,e.code  collate Arabic_CI_AS  CostCenter2Code 	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name	,'راتب اساسى & Basic Salaries'  collate Arabic_CI_AS  ArbDesc 	    ,Sum(Amount) Debit,0 as Credit from		hrs_HrsTrans HRT INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID	LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   	LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID LEFT JOIN  hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE TransactionID in(" & StrIDArray & ")  AND TT.COde IN ('11')	GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1,c.ArbName4s       ,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S  UNION ALL		select	 	'3111002' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code	,c.ArbName4s as CostCenter1Name		,e.code  collate Arabic_CI_AS  CostCenter2Code	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name ,'بدل سكن شهري & Housing Allowance'  collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT			INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID	LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	WHERE	     TransactionID in(" & StrIDArray & ") AND TT.COde IN ('13')	GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1	,c.ArbName4s,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL select	 	'3111003' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code	,c.ArbName4s as CostCenter1Name		,e.code collate Arabic_CI_AS    CostCenter2Code	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name	,'بدل مواصلات & Transportation Allowance ' collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	 INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  		LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID	LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID		     WHERE	TransactionID in(" & StrIDArray & ") AND TT.COde IN ('14')		GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1	,c.ArbName4s ,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL		select	 	'3111004' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code ,c.ArbName4s	as CostCenter1Name		,e.code collate Arabic_CI_AS    CostCenter2Code	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name	,'بدل طعام & Food Allowance'  collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from	hrs_HrsTrans HRT	  		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   	LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID	LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID	INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE	 TransactionID in(" & StrIDArray & ") AND TT.COde IN ('15')		GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1	,c.ArbName4s,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL	select	 	'3112006' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code 	,c.ArbName4s as CostCenter1Name		,e.code  collate Arabic_CI_AS   CostCenter2Code	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name	,'بدلات اخري & Other Allowance'  collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   		LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID	LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID		WHERE	TransactionID in(" & StrIDArray & ") AND TT.COde IN ('17')		GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1	,c.ArbName4s	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL	select		  '' LedgerCode		,'' CostCenter1Code  		,'' as CostCenter1Name	,'' CostCenter2Code		,'' as CostCenter2Name,'بدل تليفون & Tel  Allowance'  collate Arabic_CI_AS ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT			INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('175')		GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1		UNION ALL	select	 	 '' LedgerCode		,'' CostCenter1Code  	,'' as CostCenter1Name		,'' CostCenter2Code	,'' as CostCenter2Name	,'بدل غسيل سيارة & Car Wash  Allowance'  collate Arabic_CI_AS ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	 	INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   		LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	WHERE	TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('171')		GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1	UNION ALL	select		  '3112003' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code  	,c.ArbName4s as CostCenter1Name		,e.code collate Arabic_CI_AS    CostCenter2Code		,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name,'حوافز  & Incentives Bonuses'  collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	  		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID 	LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE	TransactionID in(" & StrIDArray & ") AND TT.COde IN ('176')		GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1	,c.ArbName4s,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL		select	 	 '3112001' LedgerCode	,c.code collate Arabic_CI_AS CostCenter1Code 	,c.ArbName4s as CostCenter1Name		,e.code  collate Arabic_CI_AS   CostCenter2Code		,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name ,'الاضافي& Overtime '  collate Arabic_CI_AS ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	 	INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  	LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE TransactionID in(" & StrIDArray & ") AND TT.COde IN ('201')	GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1	,c.ArbName4s,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL	select	  '' LedgerCode		,'' CostCenter1Code  	,'' as CostCenter1Name		,'' CostCenter2Code	,'' as CostCenter2Name,'Incentives Bonuses'  collate Arabic_CI_AS  ArbDesc	,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	    INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  		LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	WHERE		TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('99999')		GROUP BY TT.ArbName,c2.code, pr.Code,pr.CostCenterCode1  UNION ALL  		select	 '1144000' LedgerCode		,c.code collate Arabic_CI_AS Center1Code	,c.ArbName4s as CostCenter1Name		,e.code  collate Arabic_CI_AS   CostCenter2Code		,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name ,'Staff Loans '  collate Arabic_CI_AS ArbDesc	,0 as Debit,Sum(Amount) Credit	from		hrs_HrsTrans HRT		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID	 LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID   		WHERE		TT.Code IN ('22')		AND TransactionID in(" & StrIDArray & ")	GROUP BY TT.ArbName,e.Code,c.code		,c.ArbName4s,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL 	select	 	'2124903' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code	,c.ArbName4s as CostCenter1Name		,e.code   collate Arabic_CI_AS  CostCenter2Code	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name	,'Accrued GOSI Insurance 9.75 % Staff '  collate Arabic_CI_AS ArbDesc		,0 as Debit,Sum(Amount) Credit  from		hrs_HrsTrans HRT		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID		LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID   	WHERE		TT.Code IN ('231') AND TransactionID in(" & StrIDArray & ")GROUP BY TT.ArbName,e.Code,c.code,c.ArbName4s,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL	select	 	 '3111001' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code ,c.ArbName4s as CostCenter1Name			,e.code  collate Arabic_CI_AS   CostCenter2Code	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name	,'Late'  collate Arabic_CI_AS  ArbDesc	 ,0 as Debit	,Sum(Amount) Credit	from		hrs_HrsTrans HRT	  		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE		TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('26')		GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1 	,c.ArbName4s ,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL      select	 	 '3111001' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code 	,c.ArbName4s as CostCenter1Name		,e.code  collate Arabic_CI_AS   CostCenter2Code	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name	,'ABSENT'  collate Arabic_CI_AS ArbDesc	,0 as Debit,Sum(Amount) Credit	from	    hrs_HrsTrans HRT	  		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE TransactionID in(" & StrIDArray & ") AND  TT.COde IN ('27')	GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1			,c.ArbName4s ,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S UNION ALL    select	 	 '3111001' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code ,c.ArbName4s as CostCenter1Name			,e.code collate Arabic_CI_AS    CostCenter2Code	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name	,'Other Deductions'  collate Arabic_CI_AS ArbDesc		,0 as Debit	,Sum(Amount) Credit	from		hrs_HrsTrans HRT	   		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   		LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	 WHERE		TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('24')		GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1             ,c.ArbName4s   ,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S  	  UNION ALL select	 	 '3111001' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code ,c.ArbName4s as CostCenter1Name	 	,e.code collate Arabic_CI_AS    CostCenter2Code	,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S as CostCenter2Name	,'Punishment'  collate Arabic_CI_AS ArbDesc	,0 as Debit	,Sum(Amount) Credit	from		hrs_HrsTrans HRT			INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  		LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE		TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('242')		GROUP BY TT.ArbName,c.code,e.code, pr.Code,pr.CostCenterCode1 ,c.ArbName4s       ,e.ArbName4S+' '+e.FatherArbName4S+' '+e.GrandArbName4S+' '+e.FamilyArbName4S                                 "
        Dim MYCommandstr As String = "" _
    & "          Select '2124100' LedgerCode      ,'010100'  collate Arabic_CI_AS CostCenter1Code, '' as CostCenter1Name		  ,'0'    collate Arabic_CI_AS CostCenter2Code  ,'' as CostCenter2Name ,'0' collate Arabic_CI_AS CostCenter3Code,'' as CostCenter3Name    ,' رواتب شهر ' + CAST(MONTH('" & periodDate & "') AS VARCHAR(50)) + ' لعام '  + CAST(YEAR('" & periodDate & "') AS VARCHAR(50)) + '   '  collate Arabic_CI_AS  ArbDesc  ,0 as Debit   , SUM(Amount*TT.Sign) Credit     FROM hrs_HrsTrans HRT	  LEFT JOIN fcs_CostCenters1 C ON HRT.Cost1 = C.ID	  LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON HRT.Cost3 = C3.ID	LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID	  INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	  INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID   WHERE      TT.IsPaid = 1                   AND HRT.PrepareType = 'N'   AND TransactionID in(" & StrIDArray & ") AND TT.COde NOT IN ('176','201')   GROUP BY  pr.Code,pr.CostCenterCode1 " _
    & " UNION ALL         SELECT        '2125001' LedgerCode      ,'010100'  collate Arabic_CI_AS CostCenter1Code	,'' as CostCenter1Name  ,'0'    collate Arabic_CI_AS CostCenter2Code  ,'' as CostCenter2Name  ,'0' collate Arabic_CI_AS CostCenter3Code,'' as CostCenter3Name  ,'حوافز رواتب شهر' + CAST(MONTH('" & periodDate & "') AS VARCHAR(50)) + ' لعام '  + CAST(YEAR('" & periodDate & "') AS VARCHAR(50)) + '   '  collate Arabic_CI_AS  ArbDesc     ,0 as Debit  , SUM(Amount*TT.Sign) Credit    FROM hrs_HrsTrans HRT	  LEFT JOIN fcs_CostCenters1 C ON HRT.Cost1 = C.ID	  LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON HRT.Cost3 = C3.ID	  LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID	  INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	  INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID WHERE      TT.IsPaid = 1      AND HRT.PrepareType = 'N'     AND TransactionID in(" & StrIDArray & ") AND TT.COde  IN ('176')      GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName " _
    & "  union all  SELECT        '2124200' LedgerCode      ,'010100'  collate Arabic_CI_AS CostCenter1Code	, '' as CostCenter1Name	  ,'0'   collate Arabic_CI_AS CostCenter2Code  ,''as CostCenter2Name  ,'0' collate Arabic_CI_AS CostCenter3Code,'' as CostCenter3Name  ,'اضافي رواتب شهر' + CAST(MONTH('" & periodDate & "') AS VARCHAR(50)) + ' لعام '  + CAST(YEAR('" & periodDate & "') AS VARCHAR(50)) + '   '  collate Arabic_CI_AS  ArbDesc    ,0 as Debit  , SUM(Amount*TT.Sign) Credit     FROM hrs_HrsTrans HRT	  LEFT JOIN fcs_CostCenters1 C ON HRT.Cost1 = C.ID	  LEFT JOIN fcs_CostCenters2 C2 ON HRT.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON HRT.Cost3 = C3.ID	  LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID	  INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	  INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID   WHERE      TT.IsPaid = 1      AND HRT.PrepareType = 'N'     AND TransactionID in(" & StrIDArray & ")	AND TT.COde  IN ('201')  GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName" _
    & "  union all	Select	 '3111001' LedgerCode	    ,c.code collate Arabic_CI_AS CostCenter1Code 	,c.ArbName as CostCenter1Name	,C2.code    collate Arabic_CI_AS CostCenter2Code  ,c2.ArbName as CostCenter2Name,C3.code  collate Arabic_CI_AS  CostCenter3Code 	,c3.ArbName as CostCenter3Name	,'راتب اساسى & Basic Salaries'  collate Arabic_CI_AS  ArbDesc 	    ,Sum(Amount) Debit,0 as Credit from		hrs_HrsTrans HRT INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID	LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   	LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID  LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID LEFT JOIN  hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE TransactionID in(" & StrIDArray & ")  AND TT.COde IN ('11')	GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName,c.ArbName ,c3.Code ,c2.ArbName     ,c3.ArbName " _
    & " UNION ALL		select	 	'3111002' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code	,c.ArbName as CostCenter1Name		,c2.code  collate Arabic_CI_AS  CostCenter2Code	,c2.ArbName as CostCenter2Name ,c3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name   ,'بدل سكن شهري & Housing Allowance'  collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT			INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID	LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	WHERE	     TransactionID in(" & StrIDArray & ") AND TT.COde IN ('13')	GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName	,c.ArbName,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL select	 	'3111003' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code	,c.ArbName as CostCenter1Name		,C2.Code collate Arabic_CI_AS    CostCenter2Code	,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  	,'بدل مواصلات & Transportation Allowance' collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	 INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  		LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID	LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID		     WHERE	TransactionID in(" & StrIDArray & ") AND TT.COde IN ('14')		GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName	,c.ArbName ,c2.ArbName,c3.Code,c3.ArbName " _
    & "  UNION ALL		select	 	'3111004' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code ,c.ArbName	as CostCenter1Name		,C2.Code collate Arabic_CI_AS    CostCenter2Code	,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  	,'بدل طعام & Food Allowance'  collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from	hrs_HrsTrans HRT	  		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   	LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID	LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID	INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE	 TransactionID in(" & StrIDArray & ") AND TT.COde IN ('15')		GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName	,c.ArbName,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL	select	 	'3112006' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code 	,c.ArbName as CostCenter1Name		,C2.Code  collate Arabic_CI_AS   CostCenter2Code	,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  	,'بدلات اخري & Other Allowance'  collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   		LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID	LEFT JOIN fcs_CostCenters3 C3 ON e.Cost2 = C3.ID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID		WHERE	TransactionID in(" & StrIDArray & ") AND TT.COde IN ('17')		GROUP BY TT.ArbName,c.code,C2.Code, c.ArbName	,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL	select		  '' LedgerCode		,'' CostCenter1Code  		,'' as CostCenter1Name	,'' CostCenter2Code		,'' as CostCenter2Name ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  ,'بدل تليفون & Tel  Allowance'  collate Arabic_CI_AS ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT			INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('175')		GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName	" _
    & " UNION ALL	select	 	 '' LedgerCode		,'' CostCenter1Code  	,'' as CostCenter1Name		,'' CostCenter2Code	,'' as CostCenter2Name ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  	,'بدل غسيل سيارة & Car Wash  Allowance'  collate Arabic_CI_AS ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	 	INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   		LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	WHERE	TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('171')		GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL	select		  '3112003' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code  	,c.ArbName as CostCenter1Name		,C2.Code collate Arabic_CI_AS    CostCenter2Code		,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  ,'حوافز  & Incentives Bonuses'  collate Arabic_CI_AS  ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	  		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID 	LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE	TransactionID in(" & StrIDArray & ") AND TT.COde IN ('176')		GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName	,c.ArbName,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL		select	 	 '3112001' LedgerCode	,c.code collate Arabic_CI_AS CostCenter1Code 	,c.ArbName as CostCenter1Name		,C2.Code  collate Arabic_CI_AS   CostCenter2Code		,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name   ,'الاضافي& Overtime'  collate Arabic_CI_AS ArbDesc		,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	 	INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  	LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE TransactionID in(" & StrIDArray & ") AND TT.COde IN ('201')	GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName	,c.ArbName,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL	select	  '' LedgerCode		,'' CostCenter1Code  	,'' as CostCenter1Name		,'' CostCenter2Code	,'' as CostCenter2Name ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  ,'Incentives Bonuses'  collate Arabic_CI_AS  ArbDesc	,Sum(Amount) Debit,0 as Credit	from		hrs_HrsTrans HRT	    INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  		LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	WHERE		TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('99999')		GROUP BY TT.ArbName,c2.code,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL  		select	 '1144000' LedgerCode		,c.code collate Arabic_CI_AS Center1Code	,c.ArbName as CostCenter1Name		,C2.Code  collate Arabic_CI_AS   CostCenter2Code		,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name   ,'Staff Loans'  collate Arabic_CI_AS ArbDesc	,0 as Debit,Sum(Amount) Credit	from		hrs_HrsTrans HRT		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID	 LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID   		WHERE		TT.Code IN ('22')		AND TransactionID in(" & StrIDArray & ")	GROUP BY TT.ArbName,C2.Code,c.code		,c.ArbName,c2.ArbName,c3.Code,c3.ArbName  " _
    & " UNION ALL 	select	 	'2124903' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code	,c.ArbName as CostCenter1Name		,C2.Code   collate Arabic_CI_AS  CostCenter2Code	,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  	,'Accrued GOSI Insurance 9.75 % Staff '  collate Arabic_CI_AS ArbDesc		,0 as Debit,Sum(Amount) Credit  from		hrs_HrsTrans HRT		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID		LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID   	WHERE		TT.Code IN ('231') AND TransactionID in(" & StrIDArray & ")GROUP BY TT.ArbName,C2.Code,c.code,c.ArbName,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL	select	 	 '3111001' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code ,c.ArbName as CostCenter1Name			,C2.Code  collate Arabic_CI_AS   CostCenter2Code	,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  	,'Late'  collate Arabic_CI_AS  ArbDesc	 ,0 as Debit	,Sum(Amount) Credit	from		hrs_HrsTrans HRT	  		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE		TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('26')		GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName 	,c.ArbName ,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL      select	 	 '3111001' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code 	,c.ArbName as CostCenter1Name		,C2.Code  collate Arabic_CI_AS   CostCenter2Code	,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  	,'ABSENT'  collate Arabic_CI_AS ArbDesc	,0 as Debit,Sum(Amount) Credit	from	    hrs_HrsTrans HRT	  		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE TransactionID in(" & StrIDArray & ") AND  TT.COde IN ('27')	GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName			,c.ArbName ,c2.ArbName,c3.Code,c3.ArbName " _
    & " UNION ALL    select	 	 '3111001' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code ,c.ArbName as CostCenter1Name			,C2.Code collate Arabic_CI_AS    CostCenter2Code	,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  	,'Other Deductions'  collate Arabic_CI_AS ArbDesc		,0 as Debit	,Sum(Amount) Credit	from		hrs_HrsTrans HRT	   		INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID   		LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID	 WHERE		TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('24')		GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName             ,c.ArbName   ,c2.ArbName,c3.Code,c3.ArbName 	" _
    & " UNION ALL select	 	 '3111001' LedgerCode		,c.code collate Arabic_CI_AS CostCenter1Code ,c.ArbName as CostCenter1Name	 	,C2.Code collate Arabic_CI_AS    CostCenter2Code	,C2.ArbName ,C3.Code collate Arabic_CI_AS CostCenter3Code,c3.ArbName as CostCenter3Name  	,'Punishment'  collate Arabic_CI_AS ArbDesc	,0 as Debit	,Sum(Amount) Credit	from		hrs_HrsTrans HRT			INNER JOIN hrs_Employees e on e.ID = hrt.EmployeeID		LEFT JOIN fcs_CostCenters1 C ON e.Cost1 = C.ID  		LEFT JOIN fcs_CostCenters2 C2 ON e.Cost2 = C2.ID   LEFT JOIN fcs_CostCenters3 C3 ON e.Cost3 = C3.ID		LEFT JOIN hrs_Projects pr  on pr.ID = hrt.ProjectID		INNER JOIN hrs_TransactionsTypes TT ON TT.ID = HRT.TransactionTypeID WHERE		TransactionID in(" & StrIDArray & ") AND	TT.COde IN ('242')		GROUP BY TT.ArbName,c.code,C2.Code,c2.ArbName,c3.Code,c3.ArbName ,c.ArbName       ,c2.ArbName,c3.Code,c3.ArbName        "

        Dim dsProjects As New Data.DataSet
        dsProjects = Microsoft.ApplicationBlocks.Data.SqlHelper.ExecuteDataset(ClsEmployee.ConnectionString, Data.CommandType.Text, MYCommandstr)
        Dim dt As DataTable = dsProjects.Tables(0).Copy()

        Dim rows() As DataRow = dt.Select(" Debit<>0 OR Credit<>0 ")

        If Not String.IsNullOrWhiteSpace(txtCode.Text) AndAlso IsNumeric(txtCode.Text) Then
            Dim code As String = Convert.ToString(txtCode.Text)
            rows = rows.Where(Function(r) Convert.ToString(r("CostCenter3Code")).Replace("EM", "") = code).ToArray()
        End If

        If ddlFilter.SelectedIndex > 0 Then
            If ddlFilter.SelectedValue = "N" Then
                rows = rows.Where(Function(r) Convert.ToString(r("ArbDesc")) = "راتب اساسى & Basic Salaries").ToArray()
            End If
            If ddlFilter.SelectedValue = "V" Then
                rows = rows.Where(Function(r) Convert.ToString(r("ArbDesc")) = "الاضافي& Overtime").ToArray()
            End If
            If ddlFilter.SelectedValue = "E" Then
                rows = rows.Where(Function(r) Convert.ToString(r("ArbDesc")) = "بدلات اخري & Other Allowance").ToArray()
            End If
            If ddlFilter.SelectedValue = "L" Then
                rows = rows.Where(Function(r) Convert.ToString(r("ArbDesc")) = "Staff Loans").ToArray()
            End If
        End If


        Dim filteredDt As DataTable = dt.Clone() ' Copy the structure
        For Each row As DataRow In rows
            row("CostCenter3Code") = row("CostCenter3Code").ToString().Replace("EM", "")
            Dim add As Boolean = True
            ClsEmployee.Find(" Code = '" & row("CostCenter3Code") & "' ")
            If ddlDepartment.SelectedIndex > 0 Then

                If ClsEmployee.DepartmentID <> ddlDepartment.SelectedValue Then
                    add = False
                End If
            End If
            If Not String.IsNullOrWhiteSpace(TextBox_Sponsor.Text) Then
                Dim clsSponsor As New Clshrs_Sponsors(Page)
                If clsSponsor.Find(" Code='" & TextBox_Sponsor.Text & "'") Then
                    If ClsEmployee.SponsorID <> clsSponsor.ID Then
                        add = False
                    End If
                End If
            End If
            If ddlBranche.SelectedIndex > 0 Then
                ClsEmployee.Find(" Code = '" & row("CostCenter3Code") & "' ")
                If ClsEmployee.ID > 0 Then
                    If ClsEmployee.BranchID <> ddlBranche.SelectedValue Then
                        add = False
                    End If
                End If

            End If

            If ddlsector.SelectedIndex > 0 Then
                ClsEmployee.Find(" Code = '" & row("CostCenter3Code") & "' ")
                If ClsEmployee.SectorID <> ddlsector.SelectedValue Then
                    add = False
                End If
            End If
            If add Then
                filteredDt.ImportRow(row)
            End If

        Next
        If filteredDt.Rows.Count > 0 Then
            dt = filteredDt.AsEnumerable() _
                   .OrderBy(Function(row) row.Field(Of String)("CostCenter3Code")) _
                   .CopyToDataTable()

            grdProjects.DataSource = dt
            grdProjects.DataBind()
        Else
            grdProjects.DataSource = filteredDt
            grdProjects.DataBind()
        End If




    End Sub
#End Region

End Class
