/* 
   HR script
   Created by: Hassan Kurdi
   Date: 2021-07-06
*/

IF COL_LENGTH('sys_DocumentsDetails', 'DocumentID') IS NOT NULL  
BEGIN
    ALTER TABLE sys_DocumentsDetails
    ALTER COLUMN DocumentID int NULL
END
GO

IF COL_LENGTH('Att_AttendTransactions', 'ShiftNo') IS NULL  
BEGIN
    ALTER TABLE Att_AttendTransactions
    ADD ShiftNo tinyint 
END
GO

IF COL_LENGTH('hrs_Employees', 'HasTaqat') IS NULL  
BEGIN
    ALTER TABLE hrs_Employees
    ADD HasTaqat bit 
END
GO

IF COL_LENGTH('Att_AttendShifts', 'FirstShiftTimeInFingerprintStart') IS NULL  
BEGIN
    ALTER TABLE Att_AttendShifts
    ADD FirstShiftTimeInFingerprintStart varchar(5) 
END
GO

IF COL_LENGTH('Att_AttendShifts', 'FirstShiftEntryTimeInClose') IS NULL  
BEGIN
    ALTER TABLE Att_AttendShifts
    ADD FirstShiftEntryTimeInClose varchar(5) 
END
GO

IF COL_LENGTH('Att_AttendShifts', 'FirstShiftTimeOutFingerprintClose') IS NULL  
BEGIN
    ALTER TABLE Att_AttendShifts
    ADD FirstShiftTimeOutFingerprintClose varchar(5) 
END
GO

IF COL_LENGTH('Att_AttendShifts', 'SecondShiftTimeInFingerprintStart') IS NULL  
BEGIN
    ALTER TABLE Att_AttendShifts
    ADD SecondShiftTimeInFingerprintStart varchar(5) 
END
GO

IF COL_LENGTH('Att_AttendShifts', 'SecondShiftEntryTimeInClose') IS NULL  
BEGIN
    ALTER TABLE Att_AttendShifts
    ADD SecondShiftEntryTimeInClose varchar(5) 
END
GO

IF COL_LENGTH('Att_AttendShifts', 'SecondShiftTimeOutFingerprintClose') IS NULL  
BEGIN
    ALTER TABLE Att_AttendShifts
    ADD SecondShiftTimeOutFingerprintClose varchar(5) 
END
GO

CREATE OR ALTER PROCEDURE [dbo].[Att_GetCustomAttandace]
 @EmployeeID     AS INT, 
 @Attandancedate AS DATE
AS
SET DATEFIRST 6

SET DATEFORMAT dmy
     SELECT AttShD. DayNo                                AS DayNo,                             
            AttShD.TimeIn                                AS TimeIn, 
            AttShD.TimeOut                               AS TimeOut, 
            AttShD.TimeIn2nd                             AS TimeIn2nd, 
            AttShD.TimeOut2nd                            AS TimeOut2nd, 
            AttShD.IsDayOff                              AS IsDayOff,
			AttSh.FirstShiftTimeInFingerprintStart       AS FirstShiftTimeInFingerprintStart,
			AttSh.FirstShiftEntryTimeInClose             AS FirstShiftEntryTimeInClose,
			AttSh.FirstShiftTimeOutFingerprintClose      AS FirstShiftTimeOutFingerprintClose,
			AttSh.SecondShiftTimeInFingerprintStart      AS SecondShiftTimeInFingerprintStart,
			AttSh.SecondShiftEntryTimeInClose            AS SecondShiftEntryTimeInClose,
			AttSh.SecondShiftTimeOutFingerprintClose     AS SecondShiftTimeOutFingerprintClose
     FROM Att_AttendShiftDays AttShD
          INNER JOIN Att_AttendShifts AttSh ON Attsh.id = Attshd.AttendShiftID
          INNER JOIN Att_AttendAppointment AttApp ON AttApp.AttendaceShiftID = attsh.id
          INNER JOIN Att_AttendAppointmentMembers AttAppM ON AttappM.AppointID = AttApp.ID
     WHERE AttAppM.EmployeeID = @EmployeeID
           AND @Attandancedate BETWEEN AttApp.FromDate AND AttApp.ToDate
		   and  DATEPART(dw,@Attandancedate)=DayNo
     ORDER BY AttApp.RegDate DESC
GO

CREATE OR  ALTER PROCEDURE [dbo].[Att_GetCustomAttandace]
 @EmployeeID     AS INT, 
 @Attandancedate AS DATE
AS
SET DATEFIRST 6

SET DATEFORMAT dmy
     SELECT AttShD. DayNo                                AS DayNo,                             
            AttShD.TimeIn                                AS TimeIn, 
            AttShD.TimeOut                               AS TimeOut, 
            AttShD.TimeIn2nd                             AS TimeIn2nd, 
            AttShD.TimeOut2nd                            AS TimeOut2nd, 
            AttShD.IsDayOff                              AS IsDayOff,
			AttSh.FirstShiftTimeInFingerprintStart       AS FirstShiftTimeInFingerprintStart,
			AttSh.FirstShiftEntryTimeInClose             AS FirstShiftEntryTimeInClose,
			AttSh.FirstShiftTimeOutFingerprintClose      AS FirstShiftTimeOutFingerprintClose,
			AttSh.SecondShiftTimeInFingerprintStart      AS SecondShiftTimeInFingerprintStart,
			AttSh.SecondShiftEntryTimeInClose            AS SecondShiftEntryTimeInClose,
			AttSh.SecondShiftTimeOutFingerprintClose     AS SecondShiftTimeOutFingerprintClose
     FROM Att_AttendShiftDays AttShD
          INNER JOIN Att_AttendShifts AttSh ON Attsh.id = Attshd.AttendShiftID
          INNER JOIN Att_AttendAppointment AttApp ON AttApp.AttendaceShiftID = attsh.id
          INNER JOIN Att_AttendAppointmentMembers AttAppM ON AttappM.AppointID = AttApp.ID
     WHERE AttAppM.EmployeeID = @EmployeeID
           AND @Attandancedate BETWEEN AttApp.FromDate AND AttApp.ToDate
		   AND  DATEPART(dw, @Attandancedate) = DayNo
		   AND AttAppM.CancelDate IS NULL
     ORDER BY AttApp.RegDate DESC
GO

IF EXISTS
(
    SELECT name
    FROM sysobjects
    WHERE name = 'hrs_FingerprintSettings'
)
BEGIN
	IF COL_LENGTH('hrs_FingerprintSettings', 'UserMatchColumnName') IS NULL
		BEGIN
			DROP TABLE hrs_FingerprintSettings
		END
	END
GO

IF NOT EXISTS
(
    SELECT name
    FROM sysobjects
    WHERE name = 'hrs_FingerprintSettings'
)
    BEGIN
        CREATE TABLE hrs_FingerprintSettings
		(
			ID int IDENTITY(1,1) NOT NULL,
			IsDefault bit,
			Code varchar(50) NULL,
			EngName varchar(100) NULL,
			ArbName nvarchar(100) NULL,
			Remarks varchar(2048) NULL,
			FingerprintServerIP varchar(50),
			FingerprintDatabaseName varchar(50),
			FingerprintTableName varchar(100),
			UserIdColumnName varchar(50),
			CheckInOutColumnName varchar(50),
			UsersTableName varchar(100),
			UserMatchColumnName varchar(50),
			UsersTableIdntity varchar(50),
			RegUserId int,
			RegDate smalldatetime,
			CancelDate smalldatetime
		)
	END
GO

IF COL_LENGTH('hrs_FingerprintSettings', 'RegDate') IS NOT NULL  
BEGIN
	IF((SELECT COUNT(object_definition(default_object_id)) FROM sys.columns WHERE name ='RegDate'
	AND    object_id = object_id('hrs_FingerprintSettings')) < 1)
	BEGIN
		ALTER TABLE hrs_FingerprintSettings
		ADD  CONSTRAINT [DF_hrs_FingerprintSettings_RegDate]  DEFAULT (getdate()) FOR [RegDate]
	END
END
GO

IF(SELECT COUNT(*) FROM sys_Forms WHERE Code = 'frmFingerprintSettings') = 0
BEGIN
 INSERT INTO [dbo].[sys_Forms]
           ([Code]
           ,[EngName]
           ,[ArbName]
           ,[ArbName4S]
           ,[EngDescription]
           ,[ArbDescription]
           ,[Rank]
           ,[ModuleID]
           ,[Height]
           ,[Width]
           ,[RegDate])
     VALUES
           ('frmFingerprintSettings'
           ,'frmFingerprintSettings.aspx'
           ,'اعدادات برنامج البصمة'
           ,''
           ,'Fingerprint Settings'
           ,'اعدادات برنامج البصمة'
           ,0
           ,2
           ,650
           ,1100
           ,GETDATE())
END
ELSE
BEGIN
	UPDATE [sys_Forms] SET [ArbName] = 'اعدادات برنامج البصمة',[ArbDescription] = 'اعدادات برنامج البصمة' WHERE Code = 'frmFingerprintSettings'
END

GO

IF(SELECT COUNT(*) FROM sys_Menus WHERE Code = 'frmFingerprintSettings') = 0
BEGIN
 INSERT INTO [dbo].[sys_Menus]
           ([Code]
           ,[EngName]
           ,[ArbName]
           ,[ArbName4S]
           ,[ParentID]
           ,[Rank]
           ,[FormID]
           ,[ViewFormID]
           ,[IsHide]
           ,[ViewType]
           ,[RegDate])
     VALUES
           ('frmFingerprintSettings'
           ,'frmFingerprintSettings'
           ,'اعدادات برنامج البصمة'
           ,'اعدادات برنامج البصمة'
           ,410
           ,6
           ,(SELECT ID FROM sys_Forms WHERE Code = 'frmFingerprintSettings')
           ,283
           ,0
           ,1
           ,GETDATE())
END
ELSE
BEGIN
UPDATE [dbo].[sys_Menus] SET [ArbName] = 'اعدادات برنامج البصمة', [ArbName4S] = 'اعدادات برنامج البصمة' WHERE Code = 'frmFingerprintSettings'
END
GO

IF(SELECT COUNT(*) FROM sys_FormsPermissions WHERE UserID = 1 AND FormID = 
			(SELECT ID FROM sys_Forms WHERE Code = 'frmFingerprintSettings')) = 0
BEGIN
 INSERT INTO [dbo].[sys_FormsPermissions]
           ([FormID]
           ,[UserID]
           ,[AllowView]
           ,[AllowAdd]
           ,[AllowEdit]
           ,[AllowDelete]
           ,[AllowPrint]
		   ,[RegUserID]
           ,[RegDate])
     VALUES
           ((SELECT ID FROM sys_Forms WHERE Code = 'frmFingerprintSettings')
           ,1
           ,1
           ,1
           ,1
           ,1
           ,1
		   ,1
           ,GETDATE())
END
GO

IF COL_LENGTH('hrs_EmployeeVacationOpenBalanceSettlement', 'PaidDays') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeeVacationOpenBalanceSettlement
    ADD PaidDays real 
END
GO

IF COL_LENGTH('hrs_EmployeesTransactions', 'EmployeesVacationsID') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeesTransactions
    ADD EmployeesVacationsID int 
END
GO

IF COL_LENGTH('sys_Companies', 'CountEmployeeVacationDaysTotal') IS NULL  
BEGIN
    ALTER TABLE sys_Companies
    ADD CountEmployeeVacationDaysTotal bit 
END
GO

IF ((SELECT COUNT(OBJECTPROPERTY(OBJECT_ID('sys_Companies'), 'TableHasIdentity'))) < 1)
BEGIN
    ALTER TABLE dbo.sys_Companies
	ADD ID INT IDENTITY
       CONSTRAINT PK_sys_Companies PRIMARY KEY CLUSTERED
END
GO

IF COL_LENGTH('hrs_EmployeesTransactions', 'TotalVacDaySettlement') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeesTransactions
    ADD TotalVacDaySettlement int 
END
GO

IF COL_LENGTH('hrs_EmployeesTransactions', 'RemainVacDaySettlement') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeesTransactions
    ADD RemainVacDaySettlement int 
END
GO

IF COL_LENGTH('hrs_EmployeesTransactions', 'LastPaidDate') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeesTransactions
    ADD LastPaidDate smalldatetime 
END
GO

IF COL_LENGTH('sys_Companies', 'ZeroBalAfterVac') IS NULL  
BEGIN
    ALTER TABLE sys_Companies
    ADD ZeroBalAfterVac bit 
END
ELSE IF((SELECT DATA_TYPE FROM INFORMATION_SCHEMA.COLUMNS
		 WHERE TABLE_NAME = 'sys_Companies' AND COLUMN_NAME = 'ZeroBalAfterVac') <> 'bit')
BEGIN
    ALTER TABLE sys_Companies
    DROP COLUMN ZeroBalAfterVac
    ALTER TABLE sys_Companies
    ADD ZeroBalAfterVac bit 
END
GO

IF NOT EXISTS
(
    SELECT name
    FROM sysobjects
    WHERE name = 'hrs_EmployeesOvertimeList'
)
    BEGIN
        CREATE TABLE [dbo].[hrs_EmployeesOvertimeList](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[EmployeeID] [int] NULL,
	[StartDate] [smalldatetime] NULL,
	[EndDate] [smalldatetime] NOT NULL,
	[OvertimeHours] [real] NULL,
	[Shift] [int] NULL,
	[FingerPrint] [bit] NULL,
	[Notes] [varchar](2048) NULL,
	[Remarks] [varchar](2048) NULL,
	[RegUserID] [int] NULL,
	[RegComputerID] [int] NULL,
	[RegDate] [smalldatetime] NULL,
	[CancelDate] [smalldatetime] NULL,
 CONSTRAINT [PK_hrs_EmployeesOvertimeList] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
	END
GO

IF 
((SELECT COUNT(object_definition(default_object_id)) FROM sys.columns WHERE name ='RegDate'
	AND    object_id = object_id('hrs_EmployeesOvertimeList')) < 1)
    BEGIN
		ALTER TABLE [dbo].[hrs_EmployeesOvertimeList] ADD  DEFAULT (getdate()) FOR [RegDate]
	END
GO

IF(SELECT COUNT(*) FROM sys_Forms WHERE Code = 'frmEmployeesOvertimeList') = 0
BEGIN
 INSERT INTO [dbo].[sys_Forms]
           ([Code]
           ,[EngName]
           ,[ArbName]
           ,[ArbName4S]
           ,[EngDescription]
           ,[ArbDescription]
           ,[Rank]
           ,[ModuleID]
           ,[Height]
           ,[Width]
           ,[RegDate])
     VALUES
           ('frmEmployeesOvertimeList'
           ,'frmEmployeesOvertimeList.aspx'
           ,'قائمة الاضافي'
           ,'قائمة الاضافي'
           ,'Employees Overtime List'
           ,'قائمة الاضافي'
           ,0
           ,2
           ,650
           ,1100
           ,GETDATE())
END
ELSE
BEGIN
UPDATE [dbo].[sys_Forms] SET [ArbName] = 'قائمة الاضافي', [ArbName4S] = 'قائمة الاضافي', [ArbDescription] = 'قائمة الاضافي' WHERE Code = 'frmEmployeesOvertimeList'
END
GO

IF(SELECT COUNT(*) FROM sys_Menus WHERE Code = 'frmEmployeesOvertimeList') = 0
BEGIN
 INSERT INTO [dbo].[sys_Menus]
           ([Code]
           ,[EngName]
           ,[ArbName]
           ,[ArbName4S]
           ,[ParentID]
           ,[Rank]
           ,[FormID]
           ,[ViewFormID]
           ,[IsHide]
           ,[ViewType]
           ,[RegDate])
     VALUES
           ('frmEmployeesOvertimeList'
           ,'frmEmployeesOvertimeList'
           ,'قائمة الاضافي'
           ,'قائمة الاضافي'
           ,410
           ,6
           ,(SELECT ID FROM sys_Forms WHERE Code = 'frmEmployeesOvertimeList')
           ,283
           ,0
           ,1
           ,GETDATE())
END
ELSE
BEGIN
UPDATE [dbo].[sys_Menus] SET [ArbName] = 'قائمة الاضافي', [ArbName4S] = 'قائمة الاضافي' WHERE Code = 'frmEmployeesOvertimeList'
END
GO

IF(SELECT COUNT(*) FROM sys_FormsPermissions WHERE UserID = 1 AND FormID = 
			(SELECT ID FROM sys_Forms WHERE Code = 'frmEmployeesOvertimeList')) = 0
BEGIN
 INSERT INTO [dbo].[sys_FormsPermissions]
           ([FormID]
           ,[UserID]
           ,[AllowView]
           ,[AllowAdd]
           ,[AllowEdit]
           ,[AllowDelete]
           ,[AllowPrint]
		   ,[RegUserID]
           ,[RegDate])
     VALUES
           ((SELECT ID FROM sys_Forms WHERE Code = 'frmEmployeesOvertimeList')
           ,1
           ,1
           ,1
           ,1
           ,1
           ,1
		   ,1
           ,GETDATE())
END
GO

IF(SELECT COUNT(*) FROM sys_Menus WHERE Code = 'frmFingerprintSettings') <> 0
BEGIN
UPDATE sys_Menus SET ArbName = 'اعدادات برنامج البصمة' WHERE Code = 'frmFingerprintSettings'
END
GO

IF(SELECT COUNT(*) FROM sys_Menus WHERE Code = 'frmEmployeesOvertimeList') <> 0
BEGIN
UPDATE sys_Menus SET ArbName = 'قائمة الاضافي' WHERE Code = 'frmEmployeesOvertimeList'
END
GO

IF(SELECT COUNT(*) FROM sys_Menus WHERE Code = 'frmEmployeesOvertimeList') <> 0
BEGIN
UPDATE sys_Menus SET ArbName = 'قائمة الاضافي' WHERE Code = 'frmEmployeesOvertimeList'
END
GO

IF COL_LENGTH('hrs_FingerprintSettings', 'FingerprintServerIP') IS NULL  
BEGIN
    ALTER TABLE hrs_FingerprintSettings
    ADD FingerprintServerIP nvarchar(50) 
END
GO

IF 
((SELECT COUNT(object_definition(default_object_id)) FROM sys.columns WHERE name ='RegDate'
	AND    object_id = object_id('hrs_FingerprintSettings')) < 1)
    BEGIN
		ALTER TABLE [dbo].[hrs_FingerprintSettings] ADD  DEFAULT (getdate()) FOR [RegDate]
	END
GO

IF NOT EXISTS
(
    SELECT name
    FROM sysobjects
    WHERE name = 'hrs_EmployeesFingerprints'
)
BEGIN
CREATE TABLE hrs_EmployeesFingerprints
(
	ID int IDENTITY(1,1) NOT NULL,
	FingerprintTime smalldatetime,
	UserId int,
	UserCode varchar(20),
	RegDate smalldatetime,
	FingerprintID int
)

ALTER TABLE hrs_EmployeesFingerprints
	ADD  CONSTRAINT [DF_hrs_EmployeesFingerprint_RegDate]  DEFAULT (getdate()) FOR [RegDate]

END
GO

CREATE OR ALTER Proc [dbo].[hrs_FingerprintForCurrntMonth]
@FingerprintID int
AS
BEGIN
 DECLARE
	@ServerIP Varchar(50),
	@DatabaseName Varchar(50),
	@FingerprintTableName Varchar(50),
	@UserIdColumnName Varchar(50),
	@CheckInOutColumnName Varchar(50),
	@Query NVARCHAR (MAX),
	@LastDateFingerPrint smalldatetime,
	@UsersTableIdntity Varchar(50),
	@UserMatchColumnName Varchar(50),
	@UsersTableName Varchar(50)

SELECT 
	@ServerIP = FingerprintServerIP,
	@DatabaseName = FingerprintDatabaseName,
	@FingerprintTableName = FingerprintTableName,
	@UserIdColumnName = UserIdColumnName,
	@CheckInOutColumnName = CheckInOutColumnName,
	@UsersTableIdntity = UsersTableIdntity,
	@UserMatchColumnName = UserMatchColumnName,
	@UsersTableName = UsersTableName
FROM hrs_FingerprintSettings
WHERE ID = @FingerprintID

IF EXISTS
(
    SELECT name
    FROM sysobjects
    WHERE name = 'hrs_EmployeesFingerprints'
)
BEGIN
	DECLARE @result TABLE ([FingerprintTime] smalldatetime);

	INSERT INTO @result ([FingerprintTime])
	EXEC (N'SELECT TOP (1) [FingerprintTime] FROM [hrs_EmployeesFingerprints] WHERE [FingerprintID] = ' + @FingerprintID
	    + N' ORDER BY [FingerprintTime] DESC');

	SET @LastDateFingerPrint = (SELECT TOP (1) [FingerprintTime] FROM @result);

	SET @Query = NULL
	SET @Query = N'INSERT INTO hrs_EmployeesFingerprints ([UserID ],'
			   + N'[FingerprintTime], [UserCode], [FingerprintID])'
			   + N'SELECT fp.[' + @UserIdColumnName + N'],'
	           + N' fp.[' + @CheckInOutColumnName + N'],'
			   + N' us.[' + @UserMatchColumnName + N'], '
			   + CAST(@FingerprintID AS NVARCHAR(10))
			   + N' FROM [' + @DatabaseName + N']'
			   + N'.[dbo].[' + @FingerprintTableName + N'] AS fp'
			   + N' INNER JOIN [' + @DatabaseName + N'].[dbo].[' + @UsersTableName + N'] AS us'
			   + N' ON fp.[' + @UserIdColumnName + N'] = us.[' + @UsersTableIdntity + N']'

		
	IF(@LastDateFingerPrint IS NOT NULL)
		BEGIN
			DECLARE @ConvertLastDate varchar(20) 
			SELECT @ConvertLastDate  = CAST(CONVERT(VARCHAR(20), @LastDateFingerPrint, 113)AS SmallDateTime)
			SET @Query += N' WHERE fp.[' + @CheckInOutColumnName + N'] > ''' + @ConvertLastDate + N''''
		END
	ELSE
		BEGIN
			SET @Query += N' WHERE fp.[' + @CheckInOutColumnName + N'] > GETDATE()-60'
		END
		           
		EXEC (@Query)
    END
END

GO

IF COL_LENGTH('hrs_EmployeesFingerprints', 'UserId') IS NULL  
BEGIN
    ALTER TABLE hrs_FingerprintSettings
    ADD UserId int 
END
GO

IF NOT EXISTS
(
    SELECT name
    FROM sysobjects
    WHERE name = 'hrs_EmployeesExcuses'
)
BEGIN
CREATE TABLE [dbo].[hrs_EmployeesExcuses](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[EmployeeID] [int] NULL,
	[ExcuseTarget] [nvarchar](50) NULL,
	[ExcuseType] [nvarchar](10) NULL,
	[ExcuseDate] [smalldatetime] NULL,
	[ExcuseHours] [varchar](10) NULL,
	[Shift] [int] NULL,
	[Notes] [varchar](200) NULL,
	[Remarks] [varchar](2048) NULL,
	[RegUserID] [int] NULL,
	[RegComputerID] [int] NULL,
	[RegDate] [smalldatetime] NULL,
	[CancelDate] [smalldatetime] NULL,
 CONSTRAINT [PK_hrs_EmployeesExcuses] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
END
ELSE IF NOT EXISTS
(
    SELECT COUNT(*)
    FROM hrs_EmployeesExcuses
    WHERE ExcuseDate > '2021-10-01'
)
BEGIN
 DROP TABLE hrs_EmployeesExcuses

 CREATE TABLE [dbo].[hrs_EmployeesExcuses](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[EmployeeID] [int] NULL,
	[ExcuseTarget] [nvarchar](50) NULL,
	[ExcuseType] [nvarchar](10) NULL,
	[ExcuseDate] [smalldatetime] NULL,
	[ExcuseHours] [varchar](10) NULL,
	[Shift] [int] NULL,
	[Notes] [varchar](200) NULL,
	[Remarks] [varchar](2048) NULL,
	[RegUserID] [int] NULL,
	[RegComputerID] [int] NULL,
	[RegDate] [smalldatetime] NULL,
	[CancelDate] [smalldatetime] NULL,
 CONSTRAINT [PK_hrs_EmployeesExcuses] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

END
GO

IF COL_LENGTH('hrs_EmployeesClasses', 'AbsentFormula') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeesClasses
    ADD AbsentFormula varchar(2048)
END
GO

IF COL_LENGTH('hrs_EmployeesClasses', 'LateFormula') IS NULL  
BEGIN
   ALTER TABLE hrs_EmployeesClasses
   ADD LateFormula varchar(2048)
END
GO

IF NOT EXISTS
(
    SELECT name
    FROM sysobjects
    WHERE name = 'hrs_EmployeesClassesWeeklyCustomize'
)
BEGIN
CREATE TABLE [dbo].[hrs_EmployeesClassesWeeklyCustomize](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[Code] [varchar](50) NULL,
	[EngName] [varchar](100) NULL,
	[ArbName] [varchar](100) NULL,
	[BeginDate] [smalldatetime] NULL,
	[EndDate] [smalldatetime] NULL,
	[EmployeeClassID] [int] NOT NULL,
	[Remarks] [varchar](2048) NULL,
	[RegUserID] [int] NULL,
	[RegComputerID] [int] NULL,
	[RegDate] [smalldatetime] NOT NULL,
	[CancelDate] [smalldatetime] NULL,
 CONSTRAINT [PK_hrs_EmployeesClassesCalenderSetCustomize] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

ALTER TABLE [dbo].[hrs_EmployeesClassesWeeklyCustomize] ADD  DEFAULT (getdate()) FOR [RegDate]
END
GO

IF(SELECT COUNT(*) FROM sys_Forms WHERE Code = 'frmEmployeesClassesWeeklySetCustomize') = 0
BEGIN
 INSERT INTO [dbo].[sys_Forms]
           ([Code]
           ,[EngName]
           ,[ArbName]
           ,[ArbName4S]
           ,[EngDescription]
           ,[ArbDescription]
           ,[Rank]
           ,[ModuleID]
           ,[Height]
           ,[Width]
           ,[RegDate])
     VALUES
           ('frmEmployeesClassesWeeklySetCustomize'
           ,'frmEmployeesClassesWeeklySetCustomize.aspx'
           ,'تخصيص الدوام'
           ,''
           ,'Employees Classe sWeekly Set Customize'
           ,'تخصيص الدوام'
           ,0
           ,2
           ,650
           ,1100
           ,GETDATE())
END
ELSE
BEGIN
UPDATE [dbo].[sys_Forms] SET [ArbName] = 'تخصيص الدوام', [ArbDescription] = 'تخصيص الدوام' WHERE Code = 'frmEmployeesClassesWeeklySetCustomize'
END
GO

IF(SELECT COUNT(*) FROM sys_Menus WHERE Code = 'frmEmployeesClassesWeeklySetCustomize') = 0
BEGIN
 INSERT INTO [dbo].[sys_Menus]
           ([Code]
           ,[EngName]
           ,[ArbName]
           ,[ArbName4S]
           ,[ParentID]
           ,[Rank]
           ,[FormID]
           ,[ViewFormID]
           ,[IsHide]
           ,[ViewType]
           ,[RegDate])
     VALUES
           ('frmEmployeesClassesWeeklySetCustomize'
           ,'frmEmployeesClassesWeeklySetCustomize'
           ,'تخصيص الدوام'
           ,'تخصيص الدوام'
           ,410
           ,6
           ,(SELECT ID FROM sys_Forms WHERE Code = 'frmEmployeesClassesWeeklySetCustomize')
           ,283
           ,0
           ,1
           ,GETDATE())
END
ELSE
BEGIN
UPDATE [dbo].[sys_Menus] SET [ArbName] = 'تخصيص الدوام', [ArbName4S] = 'تخصيص الدوام' WHERE Code = 'frmEmployeesClassesWeeklySetCustomize'
END
GO
IF(SELECT COUNT(*) FROM sys_FormsPermissions WHERE UserID = 1 AND FormID = 
			(SELECT ID FROM sys_Forms WHERE Code = 'frmEmployeesClassesWeeklySetCustomize')) = 0
BEGIN
 INSERT INTO [dbo].[sys_FormsPermissions]
           ([FormID]
           ,[UserID]
           ,[AllowView]
           ,[AllowAdd]
           ,[AllowEdit]
           ,[AllowDelete]
           ,[AllowPrint]
		   ,[RegUserID]
           ,[RegDate])
     VALUES
           ((SELECT ID FROM sys_Forms WHERE Code = 'frmEmployeesClassesWeeklySetCustomize')
           ,1
           ,1
           ,1
           ,1
           ,1
           ,1
		   ,1
           ,GETDATE())
END
GO

IF NOT EXISTS
(
    SELECT name
    FROM sysobjects
    WHERE name = 'hrs_EmployeesClassesWeeklyCustomizeDays'
)
BEGIN
CREATE TABLE [dbo].[hrs_EmployeesClassesWeeklyCustomizeDays](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[CustomizeID] [int] NULL,
	[DayNo] [int] NULL,
	[TimeIn1] [varchar](5) NULL,
	[TimeOut1] [varchar](5) NULL,
	[TimeIn2] [varchar](5) NULL,
	[TimeOut2] [varchar](5) NULL,
	[IsDayOff] [bit] NULL,
	[RegUserID] [int] NULL,
	[RegComputerID] [int] NULL,
	[RegDate] [smalldatetime] NOT NULL,
	[CancelDate] [smalldatetime] NULL,
 CONSTRAINT [PK_hrs_EmployeesClassesCalenderSetCustomizeDays] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]


ALTER TABLE [dbo].[hrs_EmployeesClassesWeeklyCustomizeDays] ADD  DEFAULT (getdate()) FOR [RegDate]


ALTER TABLE [dbo].[hrs_EmployeesClassesWeeklyCustomizeDays]  WITH CHECK ADD  CONSTRAINT [FK_hrs_EmployeesClassesCalenderSetCustomizeDays_hrs_EmployeesClassesCalenderSetCustomize] FOREIGN KEY([CustomizeID])
REFERENCES [dbo].[hrs_EmployeesClassesWeeklyCustomize] ([ID])

END

GO

IF COL_LENGTH('hrs_EmployeesClassesWeeklyCustomize', 'EmployeeID') IS NULL  
BEGIN
   ALTER TABLE hrs_EmployeesClassesWeeklyCustomize
   ADD EmployeeID int
END
GO

IF COL_LENGTH('hrs_EmployeesClassesWeeklyCustomize', 'EmployeeClassID') IS NOT NULL  
BEGIN
   ALTER TABLE hrs_EmployeesClassesWeeklyCustomize
   ALTER COLUMN EmployeeClassID int NULL
END
GO

IF((SELECT COUNT(*) FROM sys_Objects WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize') = 0)
BEGIN
 INSERT INTO sys_Objects
 (Code, 
  EngName, 
  ArbName)
 VALUES
 ('hrs_EmployeesClassesWeeklyCustomize', 
  'hrs_EmployeesClassesWeeklyCustomize', 
  'hrs_EmployeesClassesWeeklyCustomize')
 END
GO

IF((SELECT COUNT(*) FROM sys_Searchs WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize') = 0)
BEGIN
INSERT INTO sys_Searchs
(Code, 
 EngName, 
 ArbName, 
 ObjectID)
 VALUES
 ('hrs_EmployeesClassesWeeklyCustomize', 
  'hrs_EmployeesClassesWeeklyCustomize', 
  'hrs_EmployeesClassesWeeklyCustomize', 
  (SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'))
END
GO

IF((SELECT COUNT(*) FROM sys_Fields WHERE ObjectID = (SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize')) = 0)
BEGIN
INSERT INTO sys_Fields
(ObjectID,
 FieldName,
 FieldType,
 FieldLength,
 SysColumns_OrderID)
 VALUES
 ((SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
  'ArbName',
  167,
  100,
  4
 )

INSERT INTO sys_Fields
(ObjectID,
 FieldName,
 FieldType,
 FieldLength,
 SysColumns_OrderID)
 VALUES
 ((SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
  'BeginDate',
  58,
  4,
  5
 )

INSERT INTO sys_Fields
(ObjectID,
 FieldName,
 FieldType,
 FieldLength,
 SysColumns_OrderID)
 VALUES
 ((SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
  'CancelDate',
  58,
  4,
  12
 )

INSERT INTO sys_Fields
(ObjectID,
 FieldName,
 FieldType,
 FieldLength,
 SysColumns_OrderID)
 VALUES
 ((SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
  'Code',
  167,
  50,
  2
 )

INSERT INTO sys_Fields
(ObjectID,
 FieldName,
 FieldType,
 FieldLength,
 SysColumns_OrderID)
 VALUES
 ((SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
  'EmployeeClassID',
  56,
  4,
  7
 )

INSERT INTO sys_Fields
(ObjectID,
 FieldName,
 FieldType,
 FieldLength,
 SysColumns_OrderID)
 VALUES
 ((SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
  'EndDate',
  58,
  4,
  6
 )

INSERT INTO sys_Fields
(ObjectID,
 FieldName,
 FieldType,
 FieldLength,
 SysColumns_OrderID)
 VALUES
 ((SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
  'EngName',
  167,
  100,
  3
 )

INSERT INTO sys_Fields
(ObjectID,
 FieldName,
 FieldType,
 FieldLength,
 SysColumns_OrderID)
 VALUES
 ((SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
  'ID',
  56,
  4,
  1
 )

INSERT INTO sys_Fields
(ObjectID,
 FieldName,
 FieldType,
 FieldLength,
 SysColumns_OrderID)
 VALUES
 ((SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
  'RegComputerID',
  56,
  4,
  10
 )

INSERT INTO sys_Fields
(ObjectID,
 FieldName,
 FieldType,
 FieldLength,
 SysColumns_OrderID)
 VALUES
 ((SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
  'RegDate',
  58,
  4,
  11
 )

INSERT INTO sys_Fields
(ObjectID,
 FieldName,
 FieldType,
 FieldLength,
 SysColumns_OrderID)
 VALUES
 ((SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
  'RegUserID',
  56,
  4,
  9
 )

INSERT INTO sys_Fields
(ObjectID,
 FieldName,
 FieldType,
 FieldLength,
 SysColumns_OrderID)
 VALUES
 ((SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
  'Remarks',
  167,
  2048,
  8
 )
END
GO

IF((SELECT COUNT(*) FROM sys_SearchsColumns WHERE SearchID = (SELECT ID FROM sys_Searchs 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize')) = 0)
BEGIN
INSERT INTO sys_SearchsColumns
(SearchID,
 FieldID,
 EngName,
 ArbName,
 IsCriteria,
 IsView)
VALUES
((SELECT ID FROM sys_Searchs WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
 (SELECT ID FROM sys_Fields WHERE FieldName = 'ID' AND ObjectID = (SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize')),
 'ID',
 'ID',
 0,
 0
)

INSERT INTO sys_SearchsColumns
(SearchID,
 FieldID,
 EngName,
 ArbName,
 IsCriteria,
 IsView,
 Rank)
VALUES
((SELECT ID FROM sys_Searchs WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
 (SELECT ID FROM sys_Fields WHERE FieldName = 'Code' AND ObjectID = (SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize')),
 'Code',
 'ÇáßæÏ',
 1,
 1,
 0
)

INSERT INTO sys_SearchsColumns
(SearchID,
 FieldID,
 EngName,
 ArbName,
 IsCriteria,
 IsView,
 Rank)
VALUES
((SELECT ID FROM sys_Searchs WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
 (SELECT ID FROM sys_Fields WHERE FieldName = 'EngName' AND ObjectID = (SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize')),
 'English Name',
 'ÇÓã ÇáÇäÌáíÒí',
 1,
 1,
 1
)

INSERT INTO sys_SearchsColumns
(SearchID,
 FieldID,
 EngName,
 ArbName,
 IsCriteria,
 IsView,
 Rank)
VALUES
((SELECT ID FROM sys_Searchs WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
 (SELECT ID FROM sys_Fields WHERE FieldName = 'ArbName' AND ObjectID = (SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize')),
 'Arabic Name',
 'ÇáÇÓã ÇáÚÑÈí',
 1,
 1,
 2
)

INSERT INTO sys_SearchsColumns
(SearchID,
 FieldID,
 EngName,
 ArbName,
 IsCriteria,
 IsView)
VALUES
((SELECT ID FROM sys_Searchs WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
 (SELECT ID FROM sys_Fields WHERE FieldName = 'BeginDate' AND ObjectID = (SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize')),
 'Begin Date',
 'ãä ÊÇÑíÎ',
 0,
 0
)

INSERT INTO sys_SearchsColumns
(SearchID,
 FieldID,
 EngName,
 ArbName,
 IsCriteria,
 IsView)
VALUES
((SELECT ID FROM sys_Searchs WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
 (SELECT ID FROM sys_Fields WHERE FieldName = 'EndDate' AND ObjectID = (SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize')),
 'End Date',
 'Åáì ÊÇÑíÎ',
 0,
 0
)

INSERT INTO sys_SearchsColumns
(SearchID,
 FieldID,
 EngName,
 ArbName,
 IsCriteria,
 IsView)
VALUES
((SELECT ID FROM sys_Searchs WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
 (SELECT ID FROM sys_Fields WHERE FieldName = 'EmployeeClassID' AND ObjectID = (SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize')),
 'Employee Class ID',
 'ÎØÉ ÇáÏæÇã',
 0,
 0
)

INSERT INTO sys_SearchsColumns
(SearchID,
 FieldID,
 EngName,
 ArbName,
 IsCriteria,
 IsView,
 Rank)
VALUES
((SELECT ID FROM sys_Searchs WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
 (SELECT ID FROM sys_Fields WHERE FieldName = 'Remarks' AND ObjectID = (SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize')),
 'Remarks',
 'ãáÇÍÙÇÊ',
 1,
 1,
 3
)

INSERT INTO sys_SearchsColumns
(SearchID,
 FieldID,
 EngName,
 ArbName,
 IsCriteria,
 IsView)
VALUES
((SELECT ID FROM sys_Searchs WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
 (SELECT ID FROM sys_Fields WHERE FieldName = 'RegUserID' AND ObjectID = (SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize')),
 'RegUserID',
 'RegUserID',
 0,
 0
)

INSERT INTO sys_SearchsColumns
(SearchID,
 FieldID,
 EngName,
 ArbName,
 IsCriteria,
 IsView)
VALUES
((SELECT ID FROM sys_Searchs WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
 (SELECT ID FROM sys_Fields WHERE FieldName = 'RegComputerID' AND ObjectID = (SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize')),
 'RegComputerID',
 'RegComputerID',
 0,
 0
)

INSERT INTO sys_SearchsColumns
(SearchID,
 FieldID,
 EngName,
 ArbName,
 IsCriteria,
 IsView)
VALUES
((SELECT ID FROM sys_Searchs WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
 (SELECT ID FROM sys_Fields WHERE FieldName = 'RegDate' AND ObjectID = (SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize')),
 'RegDate',
 'RegDate',
 0,
 0
)

INSERT INTO sys_SearchsColumns
(SearchID,
 FieldID,
 EngName,
 ArbName,
 IsCriteria,
 IsView)
VALUES
((SELECT ID FROM sys_Searchs WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize'),
 (SELECT ID FROM sys_Fields WHERE FieldName = 'CancelDate' AND ObjectID = (SELECT ID FROM sys_Objects 
		WHERE Code = 'hrs_EmployeesClassesWeeklyCustomize')),
 'CancelDate',
 'CancelDate',
 0,
 0
)
END
GO

CREATE OR ALTER  PROCEDURE [dbo].[Att_GetCustomAttandace]
 @EmployeeID     AS INT, 
 @Attandancedate AS DATE
AS
SET DATEFIRST 6

IF((SELECT COUNT(*) FROM hrs_EmployeesClassesWeeklyCustomize WHERE EmployeeID = @EmployeeID
	AND @Attandancedate BETWEEN BeginDate AND EndDate) > 0)
BEGIN
SET DATEFORMAT dmy
     SELECT AttShD. DayNo                                AS DayNo,                             
            AttShD.TimeIn1                               AS TimeIn, 
            AttShD.TimeOut1                              AS TimeOut, 
            AttShD.TimeIn2                               AS TimeIn2nd, 
            AttShD.TimeOut2                              AS TimeOut2nd, 
            AttShD.IsDayOff                              AS IsDayOff
			--AttSh.FirstShiftTimeInFingerprintStart       AS FirstShiftTimeInFingerprintStart,
			--AttSh.FirstShiftEntryTimeInClose             AS FirstShiftEntryTimeInClose,
			--AttSh.FirstShiftTimeOutFingerprintClose      AS FirstShiftTimeOutFingerprintClose,
			--AttSh.SecondShiftTimeInFingerprintStart      AS SecondShiftTimeInFingerprintStart,
			--AttSh.SecondShiftEntryTimeInClose            AS SecondShiftEntryTimeInClose,
			--AttSh.SecondShiftTimeOutFingerprintClose     AS SecondShiftTimeOutFingerprintClose
     FROM hrs_EmployeesClassesWeeklyCustomizeDays AttShD
          INNER JOIN hrs_EmployeesClassesWeeklyCustomize AttSh ON Attsh.id = AttShD.CustomizeID

     WHERE AttSh.EmployeeID = @EmployeeID
           AND @Attandancedate BETWEEN AttSh.BeginDate AND AttSh.EndDate
		   AND  DATEPART(dw, @Attandancedate) = DayNo
		   AND AttSh.CancelDate IS NULL
     ORDER BY AttSh.RegDate DESC
END
ELSE IF((SELECT COUNT(*) FROM hrs_EmployeesClassesWeeklyCustomizeDays AttShD
          INNER JOIN hrs_EmployeesClassesWeeklyCustomize AttSh ON Attsh.id = Attshd.CustomizeID
          INNER JOIN Att_AttendAppointment AttApp ON AttApp.AttendaceShiftID = attsh.EmployeeClassID
          INNER JOIN Att_AttendAppointmentMembers AttAppM ON AttappM.AppointID = AttApp.ID
     WHERE AttAppM.EmployeeID = @EmployeeID
           AND @Attandancedate BETWEEN AttApp.FromDate AND AttApp.ToDate
		   AND  DATEPART(dw, @Attandancedate) = DayNo
		   AND AttAppM.CancelDate IS NULL) > 0)
BEGIN
 SET DATEFORMAT dmy
     SELECT AttShD. DayNo                                AS DayNo,                             
            AttShD.TimeIn1                               AS TimeIn, 
            AttShD.TimeOut1                              AS TimeOut, 
            AttShD.TimeIn2                               AS TimeIn2nd, 
            AttShD.TimeOut2                              AS TimeOut2nd, 
            AttShD.IsDayOff                              AS IsDayOff
			--AttSh.FirstShiftTimeInFingerprintStart       AS FirstShiftTimeInFingerprintStart,
			--AttSh.FirstShiftEntryTimeInClose             AS FirstShiftEntryTimeInClose,
			--AttSh.FirstShiftTimeOutFingerprintClose      AS FirstShiftTimeOutFingerprintClose,
			--AttSh.SecondShiftTimeInFingerprintStart      AS SecondShiftTimeInFingerprintStart,
			--AttSh.SecondShiftEntryTimeInClose            AS SecondShiftEntryTimeInClose,
			--AttSh.SecondShiftTimeOutFingerprintClose     AS SecondShiftTimeOutFingerprintClose
     FROM hrs_EmployeesClassesWeeklyCustomizeDays AttShD
          INNER JOIN hrs_EmployeesClassesWeeklyCustomize AttSh ON Attsh.id = Attshd.CustomizeID
          INNER JOIN Att_AttendAppointment AttApp ON AttApp.AttendaceShiftID = attsh.EmployeeClassID
          INNER JOIN Att_AttendAppointmentMembers AttAppM ON AttappM.AppointID = AttApp.ID
     WHERE AttAppM.EmployeeID = @EmployeeID
           AND @Attandancedate BETWEEN AttApp.FromDate AND AttApp.ToDate
		   AND  DATEPART(dw, @Attandancedate) = DayNo
		   AND AttAppM.CancelDate IS NULL
     ORDER BY AttApp.RegDate DESC
END
ELSE 
BEGIN
SET DATEFORMAT dmy
     SELECT AttShD. DayNo                                AS DayNo,                             
            AttShD.TimeIn                                AS TimeIn, 
            AttShD.TimeOut                               AS TimeOut, 
            AttShD.TimeIn2nd                             AS TimeIn2nd, 
            AttShD.TimeOut2nd                            AS TimeOut2nd, 
            AttShD.IsDayOff                              AS IsDayOff,
			AttSh.FirstShiftTimeInFingerprintStart       AS FirstShiftTimeInFingerprintStart,
			AttSh.FirstShiftEntryTimeInClose             AS FirstShiftEntryTimeInClose,
			AttSh.FirstShiftTimeOutFingerprintClose      AS FirstShiftTimeOutFingerprintClose,
			AttSh.SecondShiftTimeInFingerprintStart      AS SecondShiftTimeInFingerprintStart,
			AttSh.SecondShiftEntryTimeInClose            AS SecondShiftEntryTimeInClose,
			AttSh.SecondShiftTimeOutFingerprintClose     AS SecondShiftTimeOutFingerprintClose
     FROM Att_AttendShiftDays AttShD
          INNER JOIN Att_AttendShifts AttSh ON Attsh.id = Attshd.AttendShiftID
          INNER JOIN Att_AttendAppointment AttApp ON AttApp.AttendaceShiftID = attsh.id
          INNER JOIN Att_AttendAppointmentMembers AttAppM ON AttappM.AppointID = AttApp.ID
     WHERE AttAppM.EmployeeID = @EmployeeID
           AND @Attandancedate BETWEEN AttApp.FromDate AND AttApp.ToDate
		   AND  DATEPART(dw, @Attandancedate) = DayNo
		   AND AttAppM.CancelDate IS NULL
     ORDER BY AttApp.RegDate DESC
END
GO

IF COL_LENGTH('hrs_EmployeesClasses', 'VacCostFormula') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeesClasses
    ADD VacCostFormula varchar(2048)
END
GO

IF NOT EXISTS
(
    SELECT name
    FROM sysobjects
    WHERE name = 'hrs_ViolationCategory'
)
BEGIN
CREATE TABLE [dbo].[hrs_ViolationCategory](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[Code] [varchar](50) NOT NULL,
	[EngName] [varchar](100) NULL,
	[ArbName] [varchar](100) NULL,
	[ArbName4S] [varchar](100) NULL,
	[Remarks] [varchar](2048) NULL,
	[RegUserID] [int] NOT NULL,
	[RegComputerID] [int] NULL,
	[RegDate] [smalldatetime] NOT NULL,
	[CancelDate] [smalldatetime] NULL,
 CONSTRAINT [PK_hrs_ViolationCategory] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

ALTER TABLE [dbo].[hrs_ViolationCategory] ADD  CONSTRAINT [DF_hrs_ViolationCategory_RegDate]  DEFAULT (getdate()) FOR [RegDate]

END
GO

IF NOT EXISTS
(
    SELECT name
    FROM sysobjects
    WHERE name = 'hrs_ViolationTypes'
)
BEGIN
CREATE TABLE [dbo].[hrs_ViolationTypes](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[Code] [varchar](50) NULL,
	[EngName] [varchar](100) NULL,
	[ArbName] [varchar](100) NULL,
	[ArbName4s] [varchar](100) NULL,
	[ViolationCategoryID] [int] NOT NULL,
	[BranchID] [int] NOT NULL,
	[Vfrom] [float] NOT NULL,
	[Vto] [float] NOT NULL,
	[IsObstructionOther] [bit] NOT NULL,
	[Remarks] [varchar](2048) NULL,
	[RegUserID] [int] NOT NULL,
	[RegComputerId] [int] NULL,
	[RegDate] [smalldatetime] NOT NULL,
	[CancelDate] [smalldatetime] NULL,
	[ActiveDate] [smalldatetime] NULL,
 CONSTRAINT [PK_hrs_ViolationTypes] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

ALTER TABLE [dbo].[hrs_ViolationTypes] ADD  CONSTRAINT [DF_hrs_ViolationTypes_RegDate]  DEFAULT (getdate()) FOR [RegDate]

ALTER TABLE [dbo].[hrs_ViolationTypes]  WITH NOCHECK ADD  CONSTRAINT [FK_hrs_ViolationTypes_hrs_ViolationCategory] FOREIGN KEY([ViolationCategoryID])
REFERENCES [dbo].[hrs_ViolationCategory] ([ID])

ALTER TABLE [dbo].[hrs_ViolationTypes] CHECK CONSTRAINT [FK_hrs_ViolationTypes_hrs_ViolationCategory]

END
GO

IF NOT EXISTS
(
    SELECT name
    FROM sysobjects
    WHERE name = 'hrs_ViolationPenalties'
)
BEGIN
CREATE TABLE [dbo].[hrs_ViolationPenalties](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[EngName] [varchar](100) NULL,
	[ArbName] [varchar](100) NULL,
	[ArbName4S] [varchar](100) NULL,
	[ViolationTypeId] [int] NOT NULL,
	[NumberOfTimes] [int] NOT NULL,
	[DeductionPercentage] [float] NOT NULL,
	[Remarks] [varchar](2048) NULL,
	[RegUserID] [int] NULL,
	[RegComputerId] [int] NULL,
	[RegDate] [smalldatetime] NOT NULL,
	[CancelDate] [smalldatetime] NULL,
 CONSTRAINT [PK_hrs_ViolationPenalties] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

ALTER TABLE [dbo].[hrs_ViolationPenalties] ADD  CONSTRAINT [DF_hrs_ViolationPenalties_RegDate]  DEFAULT (getdate()) FOR [RegDate]

ALTER TABLE [dbo].[hrs_ViolationPenalties]  WITH NOCHECK ADD  CONSTRAINT [FK_hrs_ViolationPenalties_hrs_ViolationTypes] FOREIGN KEY([ViolationTypeId])
REFERENCES [dbo].[hrs_ViolationTypes] ([ID])
ON DELETE CASCADE

ALTER TABLE [dbo].[hrs_ViolationPenalties] CHECK CONSTRAINT [FK_hrs_ViolationPenalties_hrs_ViolationTypes]

END
GO

IF COL_LENGTH('hrs_EmployeesClasses', 'HasFingerPrint') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeesClasses
    ADD HasFingerPrint bit 
END
GO

IF COL_LENGTH('sys_DocumentsDetails', 'CombID') IS NULL  
BEGIN
    ALTER TABLE sys_DocumentsDetails
    ADD CombID nvarchar(250) 
END
GO

IF COL_LENGTH('sys_ObjectsAttachments', 'CombID') IS NULL  
BEGIN
    ALTER TABLE sys_ObjectsAttachments
    ADD CombID nvarchar(250) 
END
GO

IF COL_LENGTH('hrs_EmployeesTransactions', 'RemainVacSettlement') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeesTransactions
    ADD RemainVacSettlement money
END
GO

CREATE OR ALTER PROCEDURE [dbo].[GetAllEmployeePreviousVacations]
 @EmployeeID int
AS
 
SET DATEFORMAT dmy
SELECT
 ID, 
 PaidDate,
 FinancialWorkingUnits PaidDays,
 (ISNULL((SELECT SUM(NumericValue)
	      FROM hrs_EmployeesTransactionsDetails
		  INNER JOIN hrs_EmployeesTransactionsProjects 
		  ON EmpTransProjID = hrs_EmployeesTransactionsProjects.ID
		  INNER JOIN hrs_TransactionsTypes 
		  ON TransactionTypeID = hrs_TransactionsTypes.ID
		  WHERE hrs_EmployeesTransactionsProjects.EmployeeTransactionID =hrs_EmployeesTransactions.ID
		  AND [Sign] > 0
		  AND IsPaid = 1)
		  ,0)
			-
  ISNULL((SELECT SUM(NumericValue)
		  From hrs_EmployeesTransactionsDetails
		  INNER JOIN hrs_EmployeesTransactionsProjects 
		  On EmpTransProjID = hrs_EmployeesTransactionsProjects.ID
		  INNER JOIN hrs_TransactionsTypes 
		  On TransactionTypeID = hrs_TransactionsTypes.ID
		  WHERE hrs_EmployeesTransactionsProjects.EmployeeTransactionID =hrs_EmployeesTransactions.ID
		  AND [Sign] <0
		  AND IsPaid = 1)
		  ,0)		)AS Amount
FROM hrs_EmployeesTransactions 
WHERE EmployeeID = @EmployeeID
AND CancelDate IS NULL
AND ( PrepareType = 'V' )
ORDER BY PaidDate

GO

CREATE OR ALTER   PROCEDURE [dbo].[GetEmployeeLastVacationSettlement]
	@EmployeeID Int
As
SET DateFormat dmy
SELECT TOP 1
		ID, 
		PaidDate,
		FinancialWorkingUnits PaidDays,
		(
			IsNull((
				SELECT SUM(NumericValue)
				FROM hrs_EmployeesTransactionsDetails
					INNER JOIN hrs_EmployeesTransactionsProjects 
					ON EmpTransProjID = hrs_EmployeesTransactionsProjects.ID
					INNER JOIN hrs_TransactionsTypes 
					ON TransactionTypeID = hrs_TransactionsTypes.ID
				WHERE 
					hrs_EmployeesTransactionsProjects.EmployeeTransactionID = hrs_EmployeesTransactions.ID
					AND [Sign] > 0
					AND IsPaid = 1
			),0)
			-
			IsNull((
				SELECT SUM(NumericValue)
				From hrs_EmployeesTransactionsDetails
					INNER JOIN hrs_EmployeesTransactionsProjects 
					ON EmpTransProjID = hrs_EmployeesTransactionsProjects.ID
					INNER JOIN hrs_TransactionsTypes 
					ON TransactionTypeID = hrs_TransactionsTypes.ID
				WHERE 
					hrs_EmployeesTransactionsProjects.EmployeeTransactionID = hrs_EmployeesTransactions.ID
					AND [Sign] < 0
					AND IsPaid = 1
			),0)	
		)AS Amount,
		TotalVacDaySettlement,
		RemainVacDaySettlement,
		RemainVacSettlement
	From
		hrs_EmployeesTransactions 
	WHERE
		EmployeeID = @EmployeeID
		AND CancelDate IS NULL
		AND PrepareType = 'V'
	ORDER BY 
		PaidDate DESC,
		ID DESC


GO

IF COL_LENGTH('hrs_EmployeeVacationOpenBalance', 'Days') IS NOT NULL  
BEGIN
	IF((SELECT DATA_TYPE 
		FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'hrs_EmployeeVacationOpenBalance' 
		AND COLUMN_NAME = 'Days') <> 'decimal')
		BEGIN
			ALTER TABLE hrs_EmployeeVacationOpenBalance
			ALTER COLUMN Days decimal(5,2)
		END
END
GO

IF COL_LENGTH('hrs_EmployeesFingerprints', 'FingerprintTime') IS NOT NULL  
BEGIN
 IF((SELECT DATA_TYPE 
  FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'hrs_EmployeesFingerprints' 
  AND COLUMN_NAME = 'FingerprintTime') <> 'datetime')
	BEGIN
		ALTER TABLE hrs_EmployeesFingerprints
		ALTER COLUMN FingerprintTime datetime
	END
END
GO

CREATE OR ALTER Proc [dbo].[hrs_FingerprintForCurrntMonth]
@FingerprintID int
AS
BEGIN
 DECLARE
	@ServerIP Varchar(50),
	@DatabaseName Varchar(50),
	@FingerprintTableName Varchar(50),
	@UserIdColumnName Varchar(50),
	@CheckInOutColumnName Varchar(50),
	@Query NVARCHAR (MAX),
	@LastDateFingerPrint DateTime,
	@UsersTableIdntity Varchar(50),
	@UserMatchColumnName Varchar(50),
	@UsersTableName Varchar(50)

SELECT 
	@ServerIP = FingerprintServerIP,
	@DatabaseName = FingerprintDatabaseName,
	@FingerprintTableName = FingerprintTableName,
	@UserIdColumnName = UserIdColumnName,
	@CheckInOutColumnName = CheckInOutColumnName,
	@UsersTableIdntity = UsersTableIdntity,
	@UserMatchColumnName = UserMatchColumnName,
	@UsersTableName = UsersTableName
FROM hrs_FingerprintSettings
WHERE ID = @FingerprintID

IF EXISTS
(
    SELECT name
    FROM sysobjects
    WHERE name = 'hrs_EmployeesFingerprints'
)
BEGIN
	DECLARE @result TABLE ([FingerprintTime] datetime);

	INSERT INTO @result ([FingerprintTime])
	EXEC (N'SELECT TOP (1) [FingerprintTime] FROM [hrs_EmployeesFingerprints] WHERE [FingerprintID] = ' + @FingerprintID
	    + N' ORDER BY [FingerprintTime] DESC');

	SET @LastDateFingerPrint = (SELECT TOP (1) [FingerprintTime] FROM @result);

	SET @Query = NULL
	SET @Query = N'INSERT INTO hrs_EmployeesFingerprints ([UserID ],'
			   + N'[FingerprintTime], [UserCode], [FingerprintID])'
			   + N'SELECT fp.[' + @UserIdColumnName + N'],'
	           + N' fp.[' + @CheckInOutColumnName + N'],'
			   + N' us.[' + @UserMatchColumnName + N'], '
			   + CAST(@FingerprintID AS NVARCHAR(10))
			   + N' FROM [' + @DatabaseName + N']'
			   + N'.[dbo].[' + @FingerprintTableName + N'] AS fp'
			   + N' INNER JOIN [' + @DatabaseName + N'].[dbo].[' + @UsersTableName + N'] AS us'
			   + N' ON fp.[' + @UserIdColumnName + N'] = us.[' + @UsersTableIdntity + N']'

		
	IF(@LastDateFingerPrint IS NOT NULL)
		BEGIN
			DECLARE @ConvertLastDate varchar(20) 
			SELECT @ConvertLastDate  = CONVERT(VARCHAR(20), @LastDateFingerPrint, 120)
			SET @Query += N' WHERE fp.[' + @CheckInOutColumnName + N'] > ''' + @ConvertLastDate + N''''
			+  N' AND fp.[' + @CheckInOutColumnName + N'] BETWEEN ''1900-01-01'' AND ''2079-06-06'' '
		END
	ELSE
		BEGIN
			SET @Query += N' WHERE fp.[' + @CheckInOutColumnName + N'] > GETDATE()-60'
			+  N' AND fp.[' + @CheckInOutColumnName + N'] BETWEEN ''1900-01-01'' AND ''2079-06-06'' '
		END
		PRINT(@Query)
		EXEC (@Query)
    END
END
GO

IF COL_LENGTH('hrs_EmployeesClassesWeeklyCustomizeDays', 'FirstShiftTimeInFingerprintStart') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeesClassesWeeklyCustomizeDays
    ADD FirstShiftTimeInFingerprintStart varchar(5) 
END
GO

IF COL_LENGTH('hrs_EmployeesClassesWeeklyCustomizeDays', 'FirstShiftEntryTimeInClose') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeesClassesWeeklyCustomizeDays
    ADD FirstShiftEntryTimeInClose varchar(5) 
END
GO

IF COL_LENGTH('hrs_EmployeesClassesWeeklyCustomizeDays', 'FirstShiftTimeOutFingerprintClose') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeesClassesWeeklyCustomizeDays
    ADD FirstShiftTimeOutFingerprintClose varchar(5) 
END
GO

IF COL_LENGTH('hrs_EmployeesClassesWeeklyCustomizeDays', 'SecondShiftTimeInFingerprintStart') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeesClassesWeeklyCustomizeDays
    ADD SecondShiftTimeInFingerprintStart varchar(5) 
END
GO

IF COL_LENGTH('hrs_EmployeesClassesWeeklyCustomizeDays', 'SecondShiftEntryTimeInClose') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeesClassesWeeklyCustomizeDays
    ADD SecondShiftEntryTimeInClose varchar(5) 
END
GO

IF COL_LENGTH('hrs_EmployeesClassesWeeklyCustomizeDays', 'SecondShiftTimeOutFingerprintClose') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeesClassesWeeklyCustomizeDays
    ADD SecondShiftTimeOutFingerprintClose varchar(5) 
END
GO

IF COL_LENGTH('hrs_EmployeesExcuses', 'ExcuseType') IS NOT NULL  
BEGIN
    ALTER TABLE hrs_EmployeesExcuses
    ALTER COLUMN ExcuseType varchar(10) 
END
GO

IF COL_LENGTH('hrs_EmployeesExcuses', 'ExcuseHours') IS NOT NULL  
BEGIN
    ALTER TABLE hrs_EmployeesExcuses
    ALTER COLUMN ExcuseHours varchar(5) 
END
GO

IF COL_LENGTH('hrs_EmployeesClasses', 'HasOvertimeList') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeesClasses
    ADD HasOvertimeList Bit 
END
GO

IF COL_LENGTH('hrs_Employees', 'BankAccountType') IS NULL  
BEGIN
    ALTER TABLE hrs_Employees
    ADD BankAccountType nvarchar(50) 
END
GO

CREATE OR ALTER PROCEDURE [dbo].[GetAllPreparedEmployeesForSalariesByEmployeeID] 
	@FiscalPeriodID As Int,
	@RegUserID      As Int,
	@GroupID		As Int,
	@EmployeeID		As Int,
	@FiscalPeriodStart	smalldatetime ,
    @FiscalPeriodEnd	smalldatetime ,
    @OrgFiscalPeriodStart	smalldatetime ,
    @OrgFiscalPeriodEnd	smalldatetime 
AS

Set Dateformat DMY
Declare @FiscalYearID		int
Declare @FiscalYearStart	smalldatetime 
Declare @FiscalYearEnd		smalldatetime 
Declare @Prepared			bit

Set		@FiscalPeriodID		= @FiscalPeriodID
Set		@FiscalYearID		= (Select FiscalYearID		From sys_FiscalYearsPeriods Where id = @FiscalPeriodID)	

Set		@FiscalYearStart	= (Select Top 1 FromDate	From sys_FiscalYears	Inner Join sys_FiscalYearsPeriods On sys_FiscalYears.ID =sys_FiscalYearsPeriods.FiscalyearID Where sys_FiscalYears.ID= @FiscalYearID	Order By FromDate	Asc)
Set		@FiscalYearEnd		= (Select Top 1 todate		From sys_FiscalYears	Inner Join sys_FiscalYearsPeriods On sys_FiscalYears.ID =sys_FiscalYearsPeriods.FiscalyearID Where sys_FiscalYears.ID= @FiscalYearID	Order By ToDate		Desc)

Select 
	e.ID,
	e.Code,
	IsNull( e.EngName,'') + ',' + IsNull( e.FatherEngName,'') + ',' + IsNull( e.GrandEngName,'') + ',' + IsNull( e.FamilyEngName,'')																							As	FullEngName,
	IsNull( e.ArbName,'') + ',' + IsNull( e.FatherArbName,'') + ',' + IsNull( e.GrandArbName,'') + ',' + IsNull( e.FamilyArbName,'')																							As	FullArbName,
	Case When (Select count(ID) From hrs_EmployeesTransactions Where IsNull(CancelDate,'')=''  And  Employeeid = e.ID And FiscalYearPeriodID = @FiscalPeriodID And PrepareType ='N')>0	Then 1	Else 0 End						As	Prepared,
	Case When ((Select Count(ID) From hrs_Contracts Co Where Co.EmployeeID = e.ID And Co.CancelDate is null) = 1 and (Select Count(ID) From hrs_EmployeesJoins jo Where jo.EmployeeID = e.ID And jo.CancelDate is null) = 1 And (e.JoinDate >= @OrgFiscalPeriodStart)) or ((Select Count(ID) From hrs_EmployeesJoins jo Where jo.EmployeeID = e.ID And jo.CancelDate is null) > 1 And (select MIN(JoinDate) from hrs_EmployeesJoins where EndOfServiceDate is null And CancelDate is null And EmployeeID = e.ID) >= @OrgFiscalPeriodStart) Then 0	Else 2 End	As	FirstPrepare,
	
	
	
	
	(Select IsNull(Sum(DurationDays),0) From hrs_ContractsVacations Inner Join hrs_VacationsTypes On hrs_ContractsVacations.VacationTypeID	= hrs_vacationsTypes.id  Where ContractID = hrs_Contracts.ID And IsPaid = 1)		
	* (Case When WorkingUnitsIsHours = 1 Then WorkHoursPerDay Else 1 End )
	As AvailableVacation,
	((dbo.fn_GetVacationDuringPeriod(e.ID,@FiscalYearStart,@FiscalYearEnd,WorkHoursperDay,-1)	+																																	
	Case When 
			((Select IsNull(Sum(DurationDays),0) From hrs_ContractsVacations Inner Join hrs_VacationsTypes On hrs_ContractsVacations.VacationTypeID	= hrs_vacationsTypes.id  Where ContractID = hrs_Contracts.ID And IsPaid = 1)
			 -
			dbo.fn_GetVacationDuringPeriod(e.ID,@FiscalYearStart,@FiscalYearEnd,WorkHoursperDay,1))	< 0 
		 Then
			(dbo.fn_GetVacationDuringPeriod(e.ID,@FiscalYearStart,@FiscalYearEnd,WorkHoursperDay,1)
			-
			(Select IsNull(Sum(DurationDays),0) From hrs_ContractsVacations Inner Join hrs_VacationsTypes On hrs_ContractsVacations.VacationTypeID	= hrs_vacationsTypes.id  Where ContractID = hrs_Contracts.ID And IsPaid = 1))
		 Else		
			0
		 End)) * (Case When WorkingUnitsIsHours = 1 Then WorkHoursPerDay Else 1 End )	As TotalPenalty,
			-- Calculate the Contracted Days 


			(IsNull((DateDiff(hh,@OrgFiscalPeriodStart,case day(@OrgFiscalPeriodEnd) when 31 then dateadd(day,-1,@OrgFiscalPeriodEnd) else @OrgFiscalPeriodEnd end)/24)+1,NoOfDaysPerPeriod) -
			
			Case When (IsNull(hrs_Contracts.EndDate,'01/01/2070') Between @OrgFiscalPeriodStart And @OrgFiscalPeriodEnd And Not hrs_Contracts.StartDate Between @OrgFiscalPeriodStart And @OrgFiscalPeriodEnd) Then (DateDiff(hh,@OrgFiscalPeriodStart,@OrgFiscalPeriodEnd) / 24) - (Datediff(hh,@OrgFiscalPeriodStart,hrs_Contracts.Enddate) / 24)	Else 
			Case When (hrs_contracts.StartDate Between @OrgFiscalPeriodStart And @OrgFiscalPeriodEnd And Not IsNull(hrs_Contracts.EndDate,'01/01/2070') Between @OrgFiscalPeriodStart And @OrgFiscalPeriodEnd)Then (DateDiff(hh,@OrgFiscalPeriodStart,@OrgFiscalPeriodEnd) / 24) - (Datediff(hh,hrs_Contracts.StartDate, @OrgFiscalPeriodEnd ) / 24)	Else  
			Case When (hrs_contracts.StartDate Between @OrgFiscalPeriodStart And @OrgFiscalPeriodEnd And IsNull(hrs_Contracts.EndDate,'01/01/2070') Between @OrgFiscalPeriodStart And @OrgFiscalPeriodEnd)	Then (DateDiff(hh,@OrgFiscalPeriodStart,@OrgFiscalPeriodEnd) / 24) - (DateDiff(hh,hrs_Contracts.StartDate,hrs_Contracts.EndDate) /24)	Else
						0
			End
			End
			End) * (Case When WorkingUnitsIsHours = 1 Then WorkHoursPerDay Else 1 End )																																																			
			  As ContractedDays,
				 Case When (IsNull(hrs_Contracts.EndDate,'01/01/2070') Between @OrgFiscalPeriodStart And @OrgFiscalPeriodEnd And Not hrs_Contracts.StartDate Between @OrgFiscalPeriodStart And @OrgFiscalPeriodEnd) Then 1	Else
				 Case When (hrs_contracts.StartDate > @OrgFiscalPeriodStart And hrs_contracts.StartDate <= @OrgFiscalPeriodEnd And Not IsNull(hrs_Contracts.EndDate,'01/01/2070') Between @OrgFiscalPeriodStart And @OrgFiscalPeriodEnd)Then 1	Else  
				 Case When (hrs_contracts.StartDate > @OrgFiscalPeriodStart And hrs_contracts.StartDate <= @OrgFiscalPeriodEnd And IsNull(hrs_Contracts.EndDate,'01/01/2070') Between @OrgFiscalPeriodStart And @OrgFiscalPeriodEnd)	Then 1 Else
				 Case When (select COUNT(ID) from hrs_EmployeesVacations where CancelDate IS NULL and EmployeeID = e.ID and ActualStartDate <@OrgFiscalPeriodStart and IsNull(ActualEndDate,'01/01/2070') > @OrgFiscalPeriodStart and VacationTypeID in(select ID from hrs_VacationsTypes where IsAnnual = 1)) > 0 Then (DateDiff(hh,@FiscalperiodStart,@FiscalPeriodEnd)/24)+1
				 Else 0
				       End
					End
				End
			End AS CalcType
From    
		hrs_Employees e
		Inner Join hrs_Contracts			On hrs_Contracts.EmployeeID = e.ID 
		Left  Join hrs_EmployeesClasses		On hrs_EmployeesClasses.ID	= hrs_Contracts.EmployeeClassID
Where 
		IsNull(e.CancelDate,'')=''
		And  IsNull(hrs_Contracts.CancelDate,'')=''	
		And	 hrs_Contracts.StartDate <= @OrgFiscalPeriodEnd 
		And (hrs_Contracts.EndDate is null or  hrs_Contracts.EndDate > @OrgFiscalPeriodStart)
		And (select Count(v.ID) as VCount	From	hrs_EmployeesVacations  v	
		LEFT JOIN hrs_VacationsTypes vt ON v.VacationTypeID = vt.ID
		Where	IsNull(v.CancelDate,'')=''	And	v.EmployeeID = e.ID	
		AND vt.IsAnnual <> 0
		AND vt.IsPaid <> 1
		And	Convert(smalldatetime,Convert(varchar,v.ActualStartDate ,103)) <= Convert(smalldatetime,Convert(varchar,@OrgFiscalPeriodStart ,103))	And	(v.ActualEndDate Is Null Or  Convert(smalldatetime,Convert(varchar,v.ActualEndDate ,103)) > Convert(smalldatetime,Convert(varchar,@OrgFiscalPeriodEnd ,103))))=0
		And e.ID = @EmployeeID
Order By 
		e.Code
GO

CREATE FUNCTION [dbo].[AttendanceEffects]
(
  @EmpID int,
  @AttandanceFromDate date,
  @AttandanceToDate date,
  @intFiscalperiod int,
  @IsToAttandanceToDate bit = 0,
  @ToAttendDate date,
  @isEndOfservice bit = 0,
  @FiscalFromdDate date,
  @FiscalToDate date
)
RETURNS @Attendace TABLE
   (
		WorkingDays int,
		AbsentDays  int,
		vactiondays int
   )
AS
BEGIN
		--declare		@FiscalFromdDate as date=(SELECT TOP 1 fromdate FROM sys_FiscalYearsPeriods WHERE id=@intFiscalperiod)
		--declare		@FiscalToDate as date=(SELECT TOP 1 ToDate  FROM sys_FiscalYearsPeriods WHERE id=@intFiscalperiod)
		DECLARE		@WorkingDays int	= 0,
					@AbsentDays int		= 0,
					@vactiondays int	= 0,
					@AcutalStartVaction date,
					@AcutalEndVaction date,
					@joindateDaysDeduction int = 0,
					@EndOfserviceDaysDetuction int = 0,
					@AttToEndDays int = 0,
					@contractID int		= (SELECT TOP 1 id FROM hrs_Contracts
					                        WHERE EmployeeID = @EmpID
											ORDER BY StartDate DESC)
		
		   DECLARE @NODPP int			= (SELECT TOP 1 NoOfDaysPerPeriod
											FROM hrs_EmployeesClasses Ec INNER JOIN hrs_Contracts c
											ON c.EmployeeClassID = Ec.ID
											WHERE c.ID = @contractID),
		
				@JoinDate date		= (SELECT  joindate FROM hrs_employees WHERE id = @EmpID ),
				@lastDayOfMonth int = 30 --DAY((SELECT DATEADD(d, -1, DATEADD(m, DATEDIFF(m, 0, @FiscalToDate) + 1, 0))))
		--IF @NODPP =30
		--	BEGIN
				SET @WorkingDays = 30
				--======== joindate ==============================		{
				IF @JoinDate > @FiscalFromdDate
				BEGIN
				SET @joindateDaysDeduction = DATEDIFF(DAY, @FiscalFromdDate, @JoinDate)
				IF((DATEDIFF(DAY, @FiscalFromdDate, @FiscalToDate) + 1) = 31)
				    SET @WorkingDays = 30
				ELSE
					SET @WorkingDays = @lastDayOfMonth
				END
				--=================================================		}
				
				--================= END Of service ==================		{
				IF	   @isEndOfservice = 1
				BEGIN
				 SET @EndOfserviceDaysDetuction = @WorkingDays - DATEDIFF(DAY,@FiscalFromdDate,@AttandanceToDate) - 1
				END
				--=================================================		}
				
				--================== Vaction =======================	{	
				-- start vaction date smaller than fiscal strat date AND return vaction is null or greater than fiscal END date
				--01
					--Ýì ÍÇáÉ Çä ÇáÇÌÇÒÉ ÈÏÃÊ ÞÈá ÇáÝÊÑÉ ÇáãÇáíÉ æÇáÚæÏÉ áíÓÊ Ýì ÇáÝÊÑÉ ÇáãÇáíÉ --
					-- ÚÏÏ ÇáÇíÇã ÇáÇÌÇÒÉ äÝÓ ÇíÇã ÇáÚãá 
				IF EXISTS(SELECT TOP 1 id FROM hrs_EmployeesVacations
				           WHERE EmployeeID = @EmpID
						   AND  CancelDate IS NULL
						   AND ActualStartDate  < @FiscalFromdDate
						   AND (ActualEndDate IS NULL OR ActualEndDate > @Fiscaltodate )
						   AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
													WHERE  IsAnnual = 1
													or  IsPaid = -1)
												                                               )
					BEGIN 
						
						SET @VactionDays = @WorkingDays
					END
					--=================================================		}
				-- StartVaction Greeter than Fiscal start date AND acutl END vaction is null or greeter than ficalto date
				--02
				-- Ýì ÍÇáÉ ÇáÇÌÇÒÉ ÏÇÎá ÇáÝÊÑÉ ÇáãÇáíÉ æÇáÚæÏÉ ÎÇÑÌ ÇáÝÊÑÉ ÇáãÇáíÉ --
					IF EXISTS(SELECT TOP 1 id FROM hrs_EmployeesVacations
					            WHERE EmployeeID = @EmpID
								AND  CancelDate IS NULL
								AND ActualStartDate  >= @FiscalFromdDate
								AND ActualStartDate  <= @Fiscaltodate
								AND (ActualEndDate IS NULL OR ActualEndDate > @Fiscaltodate )
									AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
																				WHERE   IsAnnual = 1
																				or  IsPaid = -1)
																				)
					BEGIN
						SET @AcutalStartVaction = (SELECT TOP 1 ActualStartDate FROM hrs_EmployeesVacations
						                           WHERE EmployeeID = @EmpID
												   AND  CancelDate IS NULL
												   AND ActualStartDate  >= @FiscalFromdDate
												   AND ActualStartDate  <= @Fiscaltodate
												   AND (ActualEndDate IS NULL OR ActualEndDate > @Fiscaltodate )
														AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
																				WHERE   IsAnnual = 1
																				or  IsPaid = -1)
																				)
						IF @JoinDate >= @FiscalFromdDate AND @JoinDate <= @FiscalToDate
						SET @VactionDays = @WorkingDays - DATEDIFF (DAY,@JoinDate,@AcutalStartVaction)
						ELSE
						SET @VactionDays = @WorkingDays - DATEDIFF (DAY,@FiscalFromdDate ,@AcutalStartVaction)
					END
				--================================================		}
				-- EndVactiondate Smaller than Fiscal END date AND Start  vaction is not BETWEEN acual start date AND acual END date
				--03
				-- ÇáÚæÏÉ ãä ÇáÇÌÇÒÉ ÏÇÎá ÇáÝÊÑÉ æáßä ÈÏÇíÉ ÇáÇÌÇÒÉ áíÓÊ Öãä ÇáÝÑÉ 
				IF EXISTS(SELECT TOP 1 id FROM hrs_EmployeesVacations
				           WHERE EmployeeID=@EmpID
						   AND CancelDate IS NULL
						   AND ActualEndDate > @FiscalFromdDate
						   AND ActualEndDate <= @Fiscaltodate
						   AND ActualStartDate NOT BETWEEN  @FiscalFromdDate AND @Fiscaltodate
						  		AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
																				WHERE   IsAnnual = 1
																				or  IsPaid = -1)
																				)
				BEGIN
					SET @AcutalEndVaction = (SELECT TOP 1 ActualEndDate FROM hrs_EmployeesVacations
												WHERE EmployeeID = @EmpID
												AND CancelDate IS NULL
												AND ActualEndDate >= @FiscalFromdDate
												AND ActualEndDate <= @Fiscaltodate
												AND ActualStartDate NOT BETWEEN @FiscalFromdDate AND @Fiscaltodate
														AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
																				WHERE   IsAnnual = 1
																				or  IsPaid = -1)
																				)
					BEGIN
							SET @VactionDays = @VactionDays + DATEDIFF (DAY, @FiscalFromdDate, @AcutalEndVaction )
					 SET @WorkingDays = @lastDayOfMonth
					END
	
				END
				--================================================		}
				--ÏÇÎá ÇáÝÊÑÉ --
				--04
				-- IF return date AND start date IN same period ==		{
						IF EXISTS(SELECT TOP 1 id FROM hrs_EmployeesVacations
							WHERE EmployeeID = @EmpID AND  CancelDate IS NULL
							AND ActualStartDate BETWEEN @FiscalFromdDate
							AND @Fiscaltodate
							AND ActualEndDate BETWEEN @FiscalFromdDate AND @Fiscaltodate
							AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
													WHERE IsAnnual = 1))
				BEGIN
					
					SET @VactionDays = @VactionDays + (SELECT SUM(DATEDIFF (DAY, ActualStartDate, ActualEndDate))
														FROM hrs_EmployeesVacations
														WHERE EmployeeID = @EmpID
														AND  CancelDate IS NULL
														AND ActualStartDate BETWEEN @FiscalFromdDate AND  @Fiscaltodate
														AND ActualEndDate BETWEEN @FiscalFromdDate AND  @Fiscaltodate
														AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
																				WHERE   IsAnnual = 1))
				SET @WorkingDays = @lastDayOfMonth
				
				END

				--================================================		}
				
				--SET @VactionDays= @VactionDays+
				--(
				--SELECT ISNULL(count(id),0)
				-- FROM Att_AttendancePreparationDetails
				-- WHERE EmployeeID = @EmpID
				-- AND CONVERT(Datetime, GAttendDate, 103) >= CONVERT(Datetime, @AttandanceFromDate, 103)
				-- AND CONVERT(Datetime, GAttendDate, 103) <= CONVERT(Datetime, @AttandanceTodate, 103)
				
				-- AND LeavingType IN(SELECT ID FROM hrs_VacationsTypes WHERE IsPaid = -1)
				--)
				--=============== ABSENT ==========================		{
				SET @AbsentDays =
				(
				SELECT ISNULL(count(id),0)
				 FROM Att_AttendancePreparationDetails
				 WHERE EmployeeID = @EmpID
				 AND CONVERT(Datetime, GAttendDate, 103) >= CONVERT(Datetime, @AttandanceFromDate, 103)
				 AND CONVERT(Datetime, GAttendDate, 103) <= CONVERT(Datetime, @AttandanceTodate, 103)
				 AND IsAbsent = 1
				 AND isnull(LeavingType,0) = 0
				)
				--================================================		}
				IF @IsToAttandanceToDate = 1
				BEGIN
						SET @AtttoEndDays = @WorkingDays-@vactiondays - DAY(@ToAttendDate) + 1
				END
				SET @WorkingDays = @WorkingDays - @vactiondays -@AbsentDays - @joindateDaysDeduction - @EndOfserviceDaysDetuction - @AtttoEndDays
				IF	@WorkingDays < 0  SET @WorkingDays = 0
				IF	@WorkingDays > 30 SET @WorkingDays = 30
	--	END
		SET @vactiondays = @vactiondays + @AtttoEndDays
		
				INSERT INTO @Attendace (WorkingDays, AbsentDays, vactiondays)
								SELECT @WorkingDays, @AbsentDays, @vactiondays
			
		  RETURN
END
GO

ALTER   Proc [dbo].[hrs_FingerprintForCurrntMonth]
@FingerprintID int,
@FromDate DateTime,
@ToDate DateTime
AS
BEGIN
SET DATEFORMAT ymd
 DECLARE
	@ServerIP Varchar(50),
	@DatabaseName Varchar(50),
	@FingerprintTableName Varchar(50),
	@UserIdColumnName Varchar(50),
	@CheckInOutColumnName Varchar(50),
	@Query NVARCHAR (MAX),
	@LastDateFingerPrint DateTime,
	@UsersTableIdntity Varchar(50),
	@UserMatchColumnName Varchar(50),
	@UsersTableName Varchar(50)

SELECT 
	@ServerIP = FingerprintServerIP,
	@DatabaseName = FingerprintDatabaseName,
	@FingerprintTableName = FingerprintTableName,
	@UserIdColumnName = UserIdColumnName,
	@CheckInOutColumnName = CheckInOutColumnName,
	@UsersTableIdntity = UsersTableIdntity,
	@UserMatchColumnName = UserMatchColumnName,
	@UsersTableName = UsersTableName
FROM hrs_FingerprintSettings
WHERE ID = @FingerprintID

SELECT * FROM hrs_EmployeesFingerprints
IF EXISTS
(
    SELECT name
    FROM sysobjects
    WHERE name = 'hrs_EmployeesFingerprints'
)
BEGIN
    SET DATEFORMAT ymd
	DELETE FROM hrs_EmployeesFingerprints WHERE FingerprintTime BETWEEN @FromDate AND @ToDate

	DECLARE @result TABLE ([FingerprintTime] datetime);

	INSERT INTO @result ([FingerprintTime])
	EXEC (N'SELECT TOP (1) [FingerprintTime] FROM [hrs_EmployeesFingerprints] WHERE [FingerprintID] = ' + @FingerprintID
	    + N' ORDER BY [FingerprintTime] DESC');

	SET @LastDateFingerPrint = (SELECT TOP (1) [FingerprintTime] FROM @result);

	SET @Query = NULL
	SET @Query = N'INSERT INTO hrs_EmployeesFingerprints ([UserID ],'
			   + N'[FingerprintTime], [UserCode], [FingerprintID])'
			   + N'SELECT fp.[' + @UserIdColumnName + N'],'
	           + N' fp.[' + @CheckInOutColumnName + N'],'
			   + N' us.[' + @UserMatchColumnName + N'], '
			   + CAST(@FingerprintID AS NVARCHAR(10))
			   + N' FROM [' + @DatabaseName + N']'
			   + N'.[dbo].[' + @FingerprintTableName + N'] AS fp'
			   + N' INNER JOIN [' + @DatabaseName + N'].[dbo].[' + @UsersTableName + N'] AS us'
			   + N' ON fp.[' + @UserIdColumnName + N'] = us.[' + @UsersTableIdntity + N']'

		
	--IF(@LastDateFingerPrint IS NOT NULL)
	--	BEGIN
	--		DECLARE @ConvertLastDate varchar(20) 
	--		SELECT @ConvertLastDate  = CONVERT(VARCHAR(20), @LastDateFingerPrint, 120)
	--		SET @Query += N' WHERE fp.[' + @CheckInOutColumnName + N'] > ''' + @ConvertLastDate + N''''
	--		+  N' AND fp.[' + @CheckInOutColumnName + N'] BETWEEN ''1900-01-01'' AND ''2079-06-06'' '
	--	END
	--ELSE
	--	BEGIN
	--		SET @Query += N' WHERE fp.[' + @CheckInOutColumnName + N'] > GETDATE()-60'
	--		+  N' AND fp.[' + @CheckInOutColumnName + N'] BETWEEN ''1900-01-01'' AND ''2079-06-06'' '
	--	END
	DECLARE @ConvertFromDate varchar(20) 
	DECLARE @ConvertToDate varchar(20) 
	SELECT @ConvertFromDate  = CONVERT(VARCHAR(20), @FromDate, 120)
	SELECT @ConvertToDate  = CONVERT(VARCHAR(20), @ToDate, 120)
	SET @Query += N' WHERE fp.[' + @CheckInOutColumnName + N'] BETWEEN ''' + @ConvertFromDate + ''''
			    + N' AND ''' + @ConvertToDate + ''''

		EXEC (@Query)
    END
END
GO


CREATE OR ALTER PROCEDURE [dbo].[hrs_GetContractIDDate]
	@EmployeeID Int
	,@ChechDate smalldatetime
AS
SET DATEFORMAT dmy
SELECT 
	TOP(1) ID
FROM 
	hrs_Contracts 
WHERE
	EmployeeID = @EmployeeID 
	AND CancelDate IS NULL
	AND @ChechDate BETWEEN StartDate AND ISNULL(EndDate,'2079-06-06')
ORDER BY 
	StartDate DESC
GO

CREATE   FUNCTION [dbo].[AttendanceEffects]
(
  @EmpID int,
  @AttandanceFromDate date,
  @AttandanceToDate date,
  @intFiscalperiod int,
  @IsToAttandanceToDate bit = 0,
  @ToAttendDate date,
  @isEndOfservice bit = 0,
  @FiscalFromdDate date,
  @FiscalToDate date
)
RETURNS @Attendace TABLE
   (
		WorkingDays int,
		AbsentDays  int,
		vactiondays int
   )
AS
BEGIN
		--declare		@FiscalFromdDate as date=(SELECT TOP 1 fromdate FROM sys_FiscalYearsPeriods WHERE id=@intFiscalperiod)
		--declare		@FiscalToDate as date=(SELECT TOP 1 ToDate  FROM sys_FiscalYearsPeriods WHERE id=@intFiscalperiod)
		DECLARE		@WorkingDays int	= 0,
					@AbsentDays int		= 0,
					@vactiondays int	= 0,
					@AcutalStartVaction date,
					@AcutalEndVaction date,
					@joindateDaysDeduction int = 0,
					@EndOfserviceDaysDetuction int = 0,
					@AttToEndDays int = 0,
					@contractID int		= (SELECT TOP 1 id FROM hrs_Contracts
					                        WHERE EmployeeID = @EmpID
											ORDER BY StartDate DESC)
		
		   DECLARE @NODPP int			= (SELECT TOP 1 NoOfDaysPerPeriod
											FROM hrs_EmployeesClasses Ec INNER JOIN hrs_Contracts c
											ON c.EmployeeClassID = Ec.ID
											WHERE c.ID = @contractID),
		
				@JoinDate date		= (SELECT  joindate FROM hrs_employees WHERE id = @EmpID ),
				@lastDayOfMonth int = 30 --DAY((SELECT DATEADD(d, -1, DATEADD(m, DATEDIFF(m, 0, @FiscalToDate) + 1, 0))))
		--IF @NODPP =30
		--	BEGIN
				SET @WorkingDays = 30
				--======== joindate ==============================		{
				IF @JoinDate > @FiscalFromdDate
				BEGIN
				SET @joindateDaysDeduction = DATEDIFF(DAY, @FiscalFromdDate, @JoinDate)
				IF((DATEDIFF(DAY, @FiscalFromdDate, @FiscalToDate) + 1) = 31)
				    SET @WorkingDays = 30
				ELSE
					SET @WorkingDays = @lastDayOfMonth
				END
				--=================================================		}
				
				--================= END Of service ==================		{
				IF	   @isEndOfservice = 1
				BEGIN
				 SET @EndOfserviceDaysDetuction = @WorkingDays - DATEDIFF(DAY,@FiscalFromdDate,@AttandanceToDate) - 1
				END
				--=================================================		}
				
				--================== Vaction =======================	{	
				-- start vaction date smaller than fiscal strat date AND return vaction is null or greater than fiscal END date
				--01
					--Ýì ÍÇáÉ Çä ÇáÇÌÇÒÉ ÈÏÃÊ ÞÈá ÇáÝÊÑÉ ÇáãÇáíÉ æÇáÚæÏÉ áíÓÊ Ýì ÇáÝÊÑÉ ÇáãÇáíÉ --
					-- ÚÏÏ ÇáÇíÇã ÇáÇÌÇÒÉ äÝÓ ÇíÇã ÇáÚãá 
				IF EXISTS(SELECT TOP 1 id FROM hrs_EmployeesVacations
				           WHERE EmployeeID = @EmpID
						   AND  CancelDate IS NULL
						   AND ActualStartDate  < @FiscalFromdDate
						   AND (ActualEndDate IS NULL OR ActualEndDate > @Fiscaltodate )
						   AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
													WHERE  IsAnnual = 1
													or  IsPaid = -1)
												                                               )
					BEGIN 
						
						SET @VactionDays = @WorkingDays
					END
					--=================================================		}
				-- StartVaction Greeter than Fiscal start date AND acutl END vaction is null or greeter than ficalto date
				--02
				-- Ýì ÍÇáÉ ÇáÇÌÇÒÉ ÏÇÎá ÇáÝÊÑÉ ÇáãÇáíÉ æÇáÚæÏÉ ÎÇÑÌ ÇáÝÊÑÉ ÇáãÇáíÉ --
					IF EXISTS(SELECT TOP 1 id FROM hrs_EmployeesVacations
					            WHERE EmployeeID = @EmpID
								AND  CancelDate IS NULL
								AND ActualStartDate  >= @FiscalFromdDate
								AND ActualStartDate  <= @Fiscaltodate
								AND (ActualEndDate IS NULL OR ActualEndDate > @Fiscaltodate )
									AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
																				WHERE   IsAnnual = 1
																				or  IsPaid = -1)
																				)
					BEGIN
						SET @AcutalStartVaction = (SELECT TOP 1 ActualStartDate FROM hrs_EmployeesVacations
						                           WHERE EmployeeID = @EmpID
												   AND  CancelDate IS NULL
												   AND ActualStartDate  >= @FiscalFromdDate
												   AND ActualStartDate  <= @Fiscaltodate
												   AND (ActualEndDate IS NULL OR ActualEndDate > @Fiscaltodate )
														AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
																				WHERE   IsAnnual = 1
																				or  IsPaid = -1)
																				)
						IF @JoinDate >= @FiscalFromdDate AND @JoinDate <= @FiscalToDate
						SET @VactionDays = @WorkingDays - DATEDIFF (DAY,@JoinDate,@AcutalStartVaction)
						ELSE
						SET @VactionDays = @WorkingDays - DATEDIFF (DAY,@FiscalFromdDate ,@AcutalStartVaction)
					END
				--================================================		}
				-- EndVactiondate Smaller than Fiscal END date AND Start  vaction is not BETWEEN acual start date AND acual END date
				--03
				-- ÇáÚæÏÉ ãä ÇáÇÌÇÒÉ ÏÇÎá ÇáÝÊÑÉ æáßä ÈÏÇíÉ ÇáÇÌÇÒÉ áíÓÊ Öãä ÇáÝÑÉ 
				IF EXISTS(SELECT TOP 1 id FROM hrs_EmployeesVacations
				           WHERE EmployeeID=@EmpID
						   AND CancelDate IS NULL
						   AND ActualEndDate > @FiscalFromdDate
						   AND ActualEndDate <= @Fiscaltodate
						   AND ActualStartDate NOT BETWEEN  @FiscalFromdDate AND @Fiscaltodate
						  		AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
																				WHERE   IsAnnual = 1
																				or  IsPaid = -1)
																				)
				BEGIN
					SET @AcutalEndVaction = (SELECT TOP 1 ActualEndDate FROM hrs_EmployeesVacations
												WHERE EmployeeID = @EmpID
												AND CancelDate IS NULL
												AND ActualEndDate >= @FiscalFromdDate
												AND ActualEndDate <= @Fiscaltodate
												AND ActualStartDate NOT BETWEEN @FiscalFromdDate AND @Fiscaltodate
														AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
																				WHERE   IsAnnual = 1
																				or  IsPaid = -1)
																				)
					BEGIN
							SET @VactionDays = @VactionDays + DATEDIFF (DAY, @FiscalFromdDate, @AcutalEndVaction )
					 SET @WorkingDays = @lastDayOfMonth
					END
	
				END
				--================================================		}
				--ÏÇÎá ÇáÝÊÑÉ --
				--04
				-- IF return date AND start date IN same period ==		{
						IF EXISTS(SELECT TOP 1 id FROM hrs_EmployeesVacations
							WHERE EmployeeID = @EmpID AND  CancelDate IS NULL
							AND ActualStartDate BETWEEN @FiscalFromdDate
							AND @Fiscaltodate
							AND ActualEndDate BETWEEN @FiscalFromdDate AND @Fiscaltodate
							AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
																				WHERE   IsAnnual = 1
																				or  IsPaid = -1)
																				)
				BEGIN
					
					SET @VactionDays = @VactionDays + (SELECT SUM(DATEDIFF (DAY, ActualStartDate, ActualEndDate))
														FROM hrs_EmployeesVacations
														WHERE EmployeeID = @EmpID
														AND  CancelDate IS NULL
														AND ActualStartDate BETWEEN @FiscalFromdDate AND  @Fiscaltodate
														AND ActualEndDate BETWEEN @FiscalFromdDate AND  @Fiscaltodate
														AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
																				WHERE   IsAnnual = 1
																				or  IsPaid = -1)
																				)
				SET @WorkingDays = @lastDayOfMonth
				
				END

				--================================================		}
				
				--SET @VactionDays= @VactionDays+
				--(
				--SELECT ISNULL(count(id),0)
				-- FROM Att_AttendancePreparationDetails
				-- WHERE EmployeeID = @EmpID
				-- AND CONVERT(Datetime, GAttendDate, 103) >= CONVERT(Datetime, @AttandanceFromDate, 103)
				-- AND CONVERT(Datetime, GAttendDate, 103) <= CONVERT(Datetime, @AttandanceTodate, 103)
				
				-- AND LeavingType IN(SELECT ID FROM hrs_VacationsTypes WHERE IsPaid = -1)
				--)
				--=============== ABSENT ==========================		{
				SET @AbsentDays =
				(
				SELECT ISNULL(count(id),0)
				 FROM Att_AttendancePreparationDetails
				 WHERE EmployeeID = @EmpID
				 AND CONVERT(Datetime, GAttendDate, 103) >= CONVERT(Datetime, @AttandanceFromDate, 103)
				 AND CONVERT(Datetime, GAttendDate, 103) <= CONVERT(Datetime, @AttandanceTodate, 103)
				 AND IsAbsent = 1
				 AND isnull(LeavingType,0) = 0
				)
				--================================================		}
				IF @IsToAttandanceToDate = 1
				BEGIN
						SET @AtttoEndDays = @WorkingDays-@vactiondays - DAY(@ToAttendDate) + 1
				END
				SET @WorkingDays = @WorkingDays - @vactiondays -@AbsentDays - @joindateDaysDeduction - @EndOfserviceDaysDetuction - @AtttoEndDays
				IF	@WorkingDays < 0  SET @WorkingDays = 0
				IF	@WorkingDays > 30 SET @WorkingDays = 30
	--	END
		SET @vactiondays = @vactiondays + @AtttoEndDays
		
				INSERT INTO @Attendace (WorkingDays, AbsentDays, vactiondays)
								SELECT @WorkingDays, @AbsentDays, @vactiondays
			
		  RETURN
END
GO

IF COL_LENGTH('hrs_EmployeesClasses', 'AttendanceFromTimeSheet') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeesClasses
    ADD AttendanceFromTimeSheet Bit 
END
GO

ALTER   Proc [dbo].[hrs_FingerprintForCurrntMonth]
@FingerprintID int,
@FromDate DateTime,
@ToDate DateTime
AS
BEGIN
SET DATEFORMAT ymd
 DECLARE
	@ServerIP Varchar(50),
	@DatabaseName Varchar(50),
	@FingerprintTableName Varchar(50),
	@UserIdColumnName Varchar(50),
	@CheckInOutColumnName Varchar(50),
	@Query NVARCHAR (MAX),
	@LastDateFingerPrint DateTime,
	@UsersTableIdntity Varchar(50),
	@UserMatchColumnName Varchar(50),
	@UsersTableName Varchar(50)

SELECT 
	@ServerIP = FingerprintServerIP,
	@DatabaseName = FingerprintDatabaseName,
	@FingerprintTableName = FingerprintTableName,
	@UserIdColumnName = UserIdColumnName,
	@CheckInOutColumnName = CheckInOutColumnName,
	@UsersTableIdntity = UsersTableIdntity,
	@UserMatchColumnName = UserMatchColumnName,
	@UsersTableName = UsersTableName
FROM hrs_FingerprintSettings
WHERE ID = @FingerprintID

SET @ToDate =  DATEADD(DAY, 2, @ToDate) 

IF EXISTS
(
    SELECT name
    FROM sysobjects
    WHERE name = 'hrs_EmployeesFingerprints'
)
BEGIN
    SET DATEFORMAT ymd
	DELETE FROM hrs_EmployeesFingerprints WHERE FingerprintTime BETWEEN @FromDate AND @ToDate

	DECLARE @result TABLE ([FingerprintTime] datetime);

	INSERT INTO @result ([FingerprintTime])
	EXEC (N'SELECT TOP (1) [FingerprintTime] FROM [hrs_EmployeesFingerprints] WHERE [FingerprintID] = ' + @FingerprintID
	    + N' ORDER BY [FingerprintTime] DESC');

	SET @LastDateFingerPrint = (SELECT TOP (1) [FingerprintTime] FROM @result);

	SET @Query = NULL
	SET @Query = N'INSERT INTO hrs_EmployeesFingerprints ([UserID ],'
			   + N'[FingerprintTime], [UserCode], [FingerprintID])'
			   + N'SELECT fp.[' + @UserIdColumnName + N'],'
	           + N' fp.[' + @CheckInOutColumnName + N'],'
			   + N' us.[' + @UserMatchColumnName + N'], '
			   + CAST(@FingerprintID AS NVARCHAR(10))
			   + N' FROM [' + @DatabaseName + N']'
			   + N'.[dbo].[' + @FingerprintTableName + N'] AS fp'
			   + N' INNER JOIN [' + @DatabaseName + N'].[dbo].[' + @UsersTableName + N'] AS us'
			   + N' ON fp.[' + @UserIdColumnName + N'] = us.[' + @UsersTableIdntity + N']'

	DECLARE @ConvertFromDate varchar(20) 
	DECLARE @ConvertToDate varchar(20) 
	SELECT @ConvertFromDate  = CONVERT(VARCHAR(20), @FromDate, 120)
	SELECT @ConvertToDate  = CONVERT(VARCHAR(20), @ToDate, 120)
	SET @Query += N' WHERE fp.[' + @CheckInOutColumnName + N'] BETWEEN ''' + @ConvertFromDate + ''''
			    + N' AND ''' + @ConvertToDate + ''''

		EXEC (@Query)
    END
END
GO

IF COL_LENGTH('hrs_EmployeesVacations', 'RemainingDays') IS NOT NULL  
BEGIN
    ALTER TABLE hrs_EmployeesVacations
    ALTER COLUMN RemainingDays decimal(10,2)
END
GO

IF COL_LENGTH('hrs_EmployeesVacations', 'RemainingBalance') IS NOT NULL  
BEGIN
    ALTER TABLE hrs_EmployeesVacations
    ALTER COLUMN RemainingBalance decimal(10,2)
END
GO

IF COL_LENGTH('hrs_EmployeesTransactions', 'RemainVacDaySettlement') IS NOT NULL  
BEGIN
    ALTER TABLE hrs_EmployeesTransactions
    ALTER COLUMN RemainVacDaySettlement decimal(8,2)
END
GO

IF COL_LENGTH('sys_Companies', 'VacSettlement') IS NULL  
BEGIN
    ALTER TABLE sys_Companies
    ADD VacSettlement bit
END
GO

-- 2022-03-28
create     FUNCTION [dbo].[AttendanceEffects]
(
  @EmpID int,
  @AttandanceFromDate date,
  @AttandanceToDate date,
  @intFiscalperiod int,
  @IsToAttandanceToDate bit = 0,
  @ToAttendDate date,
  @isEndOfservice bit = 0,
  @FiscalFromdDate date,
  @FiscalToDate date
)
RETURNS @Attendace TABLE
   (
		WorkingDays int,
		AbsentDays  int,
		vactiondays int
   )
AS
BEGIN
		--declare		@FiscalFromdDate as date=(SELECT TOP 1 fromdate FROM sys_FiscalYearsPeriods WHERE id=@intFiscalperiod)
		--declare		@FiscalToDate as date=(SELECT TOP 1 ToDate  FROM sys_FiscalYearsPeriods WHERE id=@intFiscalperiod)
				DECLARE		@WorkingDays int	= 0,
					@AbsentDays int		= 0,
					@vactiondays int	= 0,
					@AcutalStartVaction date,
					@AcutalEndVaction date,
					@joindateDaysDeduction int = 0,
					@EndOfserviceDaysDetuction int = 0,
					@AttToEndDays int = 0,
					@contractID int		= (SELECT TOP 1 id FROM hrs_Contracts
					                        WHERE EmployeeID = @EmpID
											ORDER BY StartDate DESC)
		
		   DECLARE @NODPP int			= (SELECT TOP 1 NoOfDaysPerPeriod
											FROM hrs_EmployeesClasses Ec INNER JOIN hrs_Contracts c
											ON c.EmployeeClassID = Ec.ID
											WHERE c.ID = @contractID),
		
				@JoinDate date		= (SELECT  joindate FROM hrs_employees WHERE id = @EmpID ),
				@lastDayOfMonth int = 30 --DAY((SELECT DATEADD(d, -1, DATEADD(m, DATEDIFF(m, 0, @FiscalToDate) + 1, 0))))
		--IF @NODPP =30
		--	BEGIN
				SET @WorkingDays = 30
				--======== joindate ==============================		{
				IF @JoinDate > @FiscalFromdDate
				BEGIN
				SET @joindateDaysDeduction = DATEDIFF(DAY, @FiscalFromdDate, @JoinDate)
				IF((DATEDIFF(DAY, @FiscalFromdDate, @FiscalToDate) + 1) = 31)
				    SET @WorkingDays = 30
				ELSE
					SET @WorkingDays = @lastDayOfMonth
				END
				--=================================================		}
				
				--================= END Of service ==================		{
				IF	   @isEndOfservice = 1
				BEGIN
				SET @EndOfserviceDaysDetuction = @WorkingDays - DATEDIFF(DAY,@FiscalFromdDate,@AttandanceToDate) - 1
				END
				--=================================================		}
				
				--================== Vaction =======================	{	
				-- start vaction date smaller than fiscal strat date AND return vaction is null or greater than fiscal END date
				--01
					--Ýì ÍÇáÉ Çä ÇáÇÌÇÒÉ ÈÏÃÊ ÞÈá ÇáÝÊÑÉ ÇáãÇáíÉ æÇáÚæÏÉ áíÓÊ Ýì ÇáÝÊÑÉ ÇáãÇáíÉ --
					-- ÚÏÏ ÇáÇíÇã ÇáÇÌÇÒÉ äÝÓ ÇíÇã ÇáÚãá
				IF EXISTS(SELECT TOP 1 id FROM hrs_EmployeesVacations
				           WHERE EmployeeID = @EmpID
						   AND  CancelDate IS NULL
						   AND ActualStartDate  < @FiscalFromdDate
						   AND (ActualEndDate IS NULL OR ActualEndDate > @Fiscaltodate )
						   AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
													WHERE  IsAnnual = 1
													or  IsPaid = -1)
												                                               )
					BEGIN
						
						SET @VactionDays = @WorkingDays
					END
					--=================================================		}
				-- StartVaction Greeter than Fiscal start date AND acutl END vaction is null or greeter than ficalto date
				--02
				-- Ýì ÍÇáÉ ÇáÇÌÇÒÉ ÏÇÎá ÇáÝÊÑÉ ÇáãÇáíÉ æÇáÚæÏÉ ÎÇÑÌ ÇáÝÊÑÉ ÇáãÇáíÉ --
					IF EXISTS(SELECT TOP 1 id FROM hrs_EmployeesVacations
					            WHERE EmployeeID = @EmpID
								AND  CancelDate IS NULL
								AND ActualStartDate  >= @FiscalFromdDate
								AND ActualStartDate  <= @Fiscaltodate
								AND (ActualEndDate IS NULL OR ActualEndDate > @Fiscaltodate )
									AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
																				WHERE   IsAnnual = 1
																				or  IsPaid = -1)
																				)
					BEGIN
						SET @AcutalStartVaction = (SELECT TOP 1 ActualStartDate FROM hrs_EmployeesVacations
						                           WHERE EmployeeID = @EmpID
												   AND  CancelDate IS NULL
												   AND ActualStartDate  >= @FiscalFromdDate
												   AND ActualStartDate  <= @Fiscaltodate
												   AND (ActualEndDate IS NULL OR ActualEndDate > @Fiscaltodate )
														AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
																				WHERE   IsAnnual = 1
																				or  IsPaid = -1)
																				)
						IF @JoinDate >= @FiscalFromdDate AND @JoinDate <= @FiscalToDate
						SET @VactionDays = @WorkingDays - DATEDIFF (DAY,@JoinDate,@AcutalStartVaction)
						ELSE
						SET @VactionDays = @WorkingDays - DATEDIFF (DAY,@FiscalFromdDate ,@AcutalStartVaction)
					END
				--================================================		}
				-- EndVactiondate Smaller than Fiscal END date AND Start  vaction is not BETWEEN acual start date AND acual END date
				--03
				-- ÇáÚæÏÉ ãä ÇáÇÌÇÒÉ ÏÇÎá ÇáÝÊÑÉ æáßä ÈÏÇíÉ ÇáÇÌÇÒÉ áíÓÊ Öãä ÇáÝÑÉ
				IF EXISTS(SELECT TOP 1 id FROM hrs_EmployeesVacations
				           WHERE EmployeeID=@EmpID
						   AND CancelDate IS NULL
						   AND ActualEndDate > @FiscalFromdDate
						   AND ActualEndDate <= @Fiscaltodate
						   AND ActualStartDate NOT BETWEEN  @FiscalFromdDate AND @Fiscaltodate
						  		AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
																				WHERE   IsAnnual = 1
																				or  IsPaid = -1)
																				)
				BEGIN
					SET @AcutalEndVaction = (SELECT TOP 1 ActualEndDate FROM hrs_EmployeesVacations
												WHERE EmployeeID = @EmpID
												AND CancelDate IS NULL
												AND ActualEndDate >= @FiscalFromdDate
												AND ActualEndDate <= @Fiscaltodate
												AND ActualStartDate NOT BETWEEN @FiscalFromdDate AND @Fiscaltodate
														AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
																				WHERE   IsAnnual = 1
																				or  IsPaid = -1)
																				)
					BEGIN
							SET @VactionDays = @VactionDays + DATEDIFF (DAY, @FiscalFromdDate, @AcutalEndVaction )
					SET @WorkingDays = @lastDayOfMonth
					END
	
				END
				--================================================		}
				--ÏÇÎá ÇáÝÊÑÉ --
				--04
				-- IF return date AND start date IN same period ==		{
						IF EXISTS(SELECT TOP 1 id FROM hrs_EmployeesVacations
							WHERE EmployeeID = @EmpID AND  CancelDate IS NULL
							AND ActualStartDate BETWEEN @FiscalFromdDate
							AND @Fiscaltodate
							AND ActualEndDate BETWEEN @FiscalFromdDate AND @Fiscaltodate
							AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
																				WHERE   IsAnnual = 1
																				or  IsPaid = -1)
																				)
				BEGIN
					
					SET @VactionDays = @VactionDays + (SELECT SUM(DATEDIFF (DAY, ActualStartDate, ActualEndDate))
														FROM hrs_EmployeesVacations
														WHERE EmployeeID = @EmpID
														AND  CancelDate IS NULL
														AND ActualStartDate BETWEEN @FiscalFromdDate AND  @Fiscaltodate
														AND ActualEndDate BETWEEN @FiscalFromdDate AND  @Fiscaltodate
														AND VacationTypeID IN(SELECT ID FROM hrs_VacationsTypes
																				WHERE   IsAnnual = 1
																				or  IsPaid = -1)
																				)
				SET @WorkingDays = @lastDayOfMonth
				
				END				--=============== ABSENT ==========================		{
				SET @AbsentDays =
				(
				SELECT ISNULL(count(id),0)
				FROM Att_AttendancePreparationDetails
				WHERE EmployeeID = @EmpID
				AND CONVERT(Datetime, GAttendDate, 103) >= CONVERT(Datetime, @AttandanceFromDate, 103)
				AND CONVERT(Datetime, GAttendDate, 103) <= CONVERT(Datetime, @AttandanceTodate, 103)
				AND IsAbsent = 1
				AND isnull(LeavingType,0) = 0
				)
				--================================================		}
				IF @IsToAttandanceToDate = 1
				BEGIN
						SET @AtttoEndDays = @WorkingDays-@vactiondays - DAY(@ToAttendDate) + 1
				END
				SET @WorkingDays = @WorkingDays - @vactiondays -@AbsentDays - @joindateDaysDeduction - @EndOfserviceDaysDetuction - @AtttoEndDays
				IF	@WorkingDays < 0  SET @WorkingDays = 0
				IF	@WorkingDays > 30 SET @WorkingDays = 30
	--	END
		SET @vactiondays = @vactiondays + @AtttoEndDays
		
				INSERT INTO @Attendace (WorkingDays, AbsentDays, vactiondays)
								SELECT @WorkingDays, @AbsentDays, @vactiondays
			
		  RETURN
END
GO

IF COL_LENGTH('hrs_EmployeesVacations', 'TotalBalance') IS NOT NULL  
BEGIN
    ALTER TABLE hrs_EmployeesVacations
    ALTER COLUMN TotalBalance decimal(10, 2)
END
GO

IF(SELECT COUNT(*) FROM sys_Forms WHERE Code = 'frmUpdateDirectManager') = 0
BEGIN
	INSERT INTO [dbo].[sys_Forms] ( [Code], [EngName], [ArbName], [ArbName4S], [EngDescription], [ArbDescription], [Rank], [ModuleID], [SearchFormID], [Height], [Width], [Remarks], [RegUserID], [RegComputerID], [RegDate], [CancelDate], [Layout], [LinkTarget], [LinkUrl], [ImageUrl], [MainID]) VALUES ( 'frmUpdateDirectManager', 'frmUpdateDirectManager.aspx', NULL, NULL, 'Update DirectManager', 'تحديث المدير المباشر', 0, 2, NULL, 650, 1100, NULL, NULL, NULL, '20110726 13:23:00.000', NULL, NULL, NULL, NULL, NULL, NULL)
END
ELSE
BEGIN
UPDATE [dbo].[sys_Forms] SET [ArbDescription] = 'تحديث المدير المباشر' WHERE Code = 'frmUpdateDirectManager'
END
GO

IF(SELECT COUNT(*) FROM sys_Menus WHERE Code = 'frmUpdateDirectManager') = 0
BEGIN
	INSERT INTO [dbo].[sys_Menus] ( [Code], [EngName], [ArbName], [ArbName4S], [ParentID], [Shortcut], [Rank], [FormID], [ObjectID], [ViewFormID], [IsHide], [Image], [ViewType], [RegUserID], [RegComputerID], [RegDate], [CancelDate]) VALUES ( 'frmUpdateDirectManager', 'Update Direct Manager', 'تحديث المدير المباشر', 'تحديث المدير المباشر', 240, NULL, 9, (SELECT ID FROM sys_Forms WHERE Code = 'frmUpdateDirectManager'), NULL, NULL, 0, NULL, 1, NULL, NULL, '20110726 14:00:00.000', NULL)
END
ELSE
BEGIN
UPDATE [dbo].[sys_Menus] SET [ArbName] = 'تحديث المدير المباشر', [ArbName4S] = 'تحديث المدير المباشر' WHERE Code = 'frmUpdateDirectManager'
END
GO

IF(SELECT COUNT(*) FROM sys_FormsPermissions WHERE UserID = 1 AND FormID = 
			(SELECT ID FROM sys_Forms WHERE Code = 'frmUpdateDirectManager')) = 0
BEGIN
 INSERT INTO [dbo].[sys_FormsPermissions]
           ([FormID]
           ,[UserID]
           ,[AllowView]
           ,[AllowAdd]
           ,[AllowEdit]
           ,[AllowDelete]
           ,[AllowPrint]
		   ,[RegUserID]
           ,[RegDate])
     VALUES
           ((SELECT ID FROM sys_Forms WHERE Code = 'frmUpdateDirectManager')
           ,1
           ,1
           ,1
           ,1
           ,1
           ,1
		   ,1
           ,GETDATE())
END
GO

IF NOT EXISTS(SELECT * FROM sys.views WHERE name = 'fcs_CostCenters1')
BEGIN 
	EXECUTE('CREATE VIEW fcs_CostCenters1 AS SELECT * FROM CostCenter')
END
GO

IF NOT EXISTS(SELECT * FROM sys.views WHERE name = 'fcs_CostCenters2')
BEGIN 
	EXECUTE('CREATE VIEW fcs_CostCenters2 AS SELECT * FROM CostCenter')
END
GO

IF NOT EXISTS(SELECT * FROM sys.views WHERE name = 'fcs_CostCenters3')
BEGIN 
	EXECUTE('CREATE VIEW fcs_CostCenters3 AS SELECT * FROM CostCenter')
END
GO

IF NOT EXISTS(SELECT * FROM sys.views WHERE name = 'fcs_CostCenters4')
BEGIN 
	EXECUTE('CREATE VIEW fcs_CostCenters4 AS SELECT * FROM CostCenter')
END
GO

IF NOT EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[hrs_PaidSalaries]'))
EXEC dbo.sp_executesql @statement = N'CREATE OR ALTER VIEW [dbo].[hrs_PaidSalaries]
AS
SELECT TOP (100) PERCENT dbo.hrs_Employees.ID, dbo.hrs_Employees.Code, dbo.fn_GetEmpName(dbo.hrs_Employees.Code, 1) AS FullName, dbo.fn_GetEmpName(dbo.hrs_Employees.Code, 2) AS EmpEngName, 
                  dbo.sys_FiscalYearsPeriods.ArbName AS PeriodCode, dbo.sys_FiscalYearsPeriods.ID AS PeriodID, SUM(dbo.hrs_TransactionsTypes.Sign * dbo.hrs_EmployeesTransactionsDetails.NumericValue) AS PaidSalary
FROM     dbo.hrs_Employees INNER JOIN
                  dbo.hrs_EmployeesTransactions ON dbo.hrs_Employees.ID = dbo.hrs_EmployeesTransactions.EmployeeID INNER JOIN
                  dbo.hrs_EmployeesTransactionsProjects ON dbo.hrs_EmployeesTransactions.ID = dbo.hrs_EmployeesTransactionsProjects.EmployeeTransactionID INNER JOIN
                  dbo.hrs_EmployeesTransactionsDetails ON dbo.hrs_EmployeesTransactionsProjects.ID = dbo.hrs_EmployeesTransactionsDetails.EmpTransProjID INNER JOIN
                  dbo.hrs_TransactionsTypes ON dbo.hrs_EmployeesTransactionsDetails.TransactionTypeID = dbo.hrs_TransactionsTypes.ID INNER JOIN
                  dbo.sys_FiscalYearsPeriods ON dbo.hrs_EmployeesTransactions.FiscalYearPeriodID = dbo.sys_FiscalYearsPeriods.ID
WHERE  (dbo.hrs_EmployeesTransactions.PrepareType = ''N'') AND (dbo.hrs_EmployeesTransactionsDetails.NumericValue > 0) AND (dbo.hrs_EmployeesTransactionsDetails.TextValue = ''Paid'')
GROUP BY dbo.hrs_Employees.Code, dbo.hrs_Employees.ArbName + '' '' + dbo.hrs_Employees.FatherArbName + '' '' + dbo.hrs_Employees.GrandArbName + '' '' + dbo.hrs_Employees.FamilyArbName, 
                  dbo.hrs_Employees.EngName + '' '' + dbo.hrs_Employees.FatherEngName + '' '' + dbo.hrs_Employees.GrandEngName + '' '' + dbo.hrs_Employees.FamilyEngName, dbo.sys_FiscalYearsPeriods.ID, dbo.sys_FiscalYearsPeriods.ArbName, 
                  dbo.hrs_Employees.ID
ORDER BY PeriodID DESC
' 
GO

IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[hrs_SalartDistExec]') AND type in (N'U'))
BEGIN
CREATE TABLE [dbo].[hrs_SalartDistExec](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[FiscalPeriodID] [int] NOT NULL,
	[EmployeeID] [int] NOT NULL,
	[ProjectID] [int] NOT NULL,
	[ProjectPercentage] [decimal](18, 3) NOT NULL,
	[ProjectAmount] [decimal](18, 3) NOT NULL,
 CONSTRAINT [PK_hrs_SalartDistExec] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
END
GO

IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[hrs_SalaryDist]') AND type in (N'U'))
BEGIN
CREATE TABLE [dbo].[hrs_SalaryDist](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[Code] [varchar](50) NOT NULL,
	[EngName] [varchar](100) NOT NULL,
	[ArbName] [varchar](100) NOT NULL,
	[RegUserID] [int] NULL,
	[RegDate] [smalldatetime] NOT NULL,
	[CancelDate] [smalldatetime] NULL,
 CONSTRAINT [PK_hrs_SalaryDistribution] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
END
GO

IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[hrs_SalaryDistPlan]') AND type in (N'U'))
BEGIN
CREATE TABLE [dbo].[hrs_SalaryDistPlan](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[Code] [nvarchar](max) NULL,
	[SalaryDistributionID] [int] NOT NULL,
	[PeriodIDs] [nvarchar](max) NOT NULL,
	[Remarks] [varchar](2048) NULL,
	[RegUserID] [int] NULL,
	[RegComputerID] [int] NULL,
	[RegDate] [smalldatetime] NULL,
	[CancelDate] [smalldatetime] NULL,
 CONSTRAINT [PK_hrs_SalaryDistPlan] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
END
GO

IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[hrs_SalaryDistPlanMember]') AND type in (N'U'))
BEGIN
CREATE TABLE [dbo].[hrs_SalaryDistPlanMember](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[SalaryDistPlanID] [int] NULL,
	[EmployeeID] [int] NULL,
	[Remarks] [varchar](2048) NULL,
	[RegUserID] [int] NULL,
	[RegComputerID] [int] NULL,
	[RegDate] [smalldatetime] NOT NULL,
	[CancelDate] [smalldatetime] NULL,
 CONSTRAINT [PK_hrs_SalaryDistPlanMember] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
END
GO

IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[hrs_SalaryDistProjects]') AND type in (N'U'))
BEGIN
CREATE TABLE [dbo].[hrs_SalaryDistProjects](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[SalaryDistributionID] [int] NOT NULL,
	[ProjectID] [int] NOT NULL,
	[Percentage] [decimal](5, 2) NOT NULL,
	[RegUserID] [int] NULL,
	[RegDate] [smalldatetime] NOT NULL,
	[CancelDate] [smalldatetime] NULL,
 CONSTRAINT [PK_hrs_SalaryDistProjects] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
END
GO

IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DF_hrs_SalaryDistribution_RegDate]') AND type = 'D')
BEGIN
ALTER TABLE [dbo].[hrs_SalaryDist] ADD  CONSTRAINT [DF_hrs_SalaryDistribution_RegDate]  DEFAULT (getdate()) FOR [RegDate]
END
GO

IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DF_hrs_SalaryDistPlan_RegDate]') AND type = 'D')
BEGIN
ALTER TABLE [dbo].[hrs_SalaryDistPlan] ADD  CONSTRAINT [DF_hrs_SalaryDistPlan_RegDate]  DEFAULT (getdate()) FOR [RegDate]
END
GO

IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DF_hrs_SalaryDistPlanMember_RegDate]') AND type = 'D')
BEGIN
ALTER TABLE [dbo].[hrs_SalaryDistPlanMember] ADD  CONSTRAINT [DF_hrs_SalaryDistPlanMember_RegDate]  DEFAULT (getdate()) FOR [RegDate]
END
GO

IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DF_hrs_SalaryDistProjects_RegDate]') AND type = 'D')
BEGIN
ALTER TABLE [dbo].[hrs_SalaryDistProjects] ADD  CONSTRAINT [DF_hrs_SalaryDistProjects_RegDate]  DEFAULT (getdate()) FOR [RegDate]
END
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_hrs_SalaryDistPlan_hrs_SalaryDist]') AND parent_object_id = OBJECT_ID(N'[dbo].[hrs_SalaryDistPlan]'))
ALTER TABLE [dbo].[hrs_SalaryDistPlan]  WITH CHECK ADD  CONSTRAINT [FK_hrs_SalaryDistPlan_hrs_SalaryDist] FOREIGN KEY([SalaryDistributionID])
REFERENCES [dbo].[hrs_SalaryDist] ([ID])
GO

IF  EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_hrs_SalaryDistPlan_hrs_SalaryDist]') AND parent_object_id = OBJECT_ID(N'[dbo].[hrs_SalaryDistPlan]'))
ALTER TABLE [dbo].[hrs_SalaryDistPlan] CHECK CONSTRAINT [FK_hrs_SalaryDistPlan_hrs_SalaryDist]
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_hrs_SalaryDistPlanMember_hrs_Employees]') AND parent_object_id = OBJECT_ID(N'[dbo].[hrs_SalaryDistPlanMember]'))
ALTER TABLE [dbo].[hrs_SalaryDistPlanMember]  WITH CHECK ADD  CONSTRAINT [FK_hrs_SalaryDistPlanMember_hrs_Employees] FOREIGN KEY([EmployeeID])
REFERENCES [dbo].[hrs_Employees] ([ID])
GO

IF  EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_hrs_SalaryDistPlanMember_hrs_Employees]') AND parent_object_id = OBJECT_ID(N'[dbo].[hrs_SalaryDistPlanMember]'))
ALTER TABLE [dbo].[hrs_SalaryDistPlanMember] CHECK CONSTRAINT [FK_hrs_SalaryDistPlanMember_hrs_Employees]
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_hrs_SalaryDistPlanMember_hrs_SalaryDistPlan]') AND parent_object_id = OBJECT_ID(N'[dbo].[hrs_SalaryDistPlanMember]'))
ALTER TABLE [dbo].[hrs_SalaryDistPlanMember]  WITH CHECK ADD  CONSTRAINT [FK_hrs_SalaryDistPlanMember_hrs_SalaryDistPlan] FOREIGN KEY([SalaryDistPlanID])
REFERENCES [dbo].[hrs_SalaryDistPlan] ([ID])
GO

IF  EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_hrs_SalaryDistPlanMember_hrs_SalaryDistPlan]') AND parent_object_id = OBJECT_ID(N'[dbo].[hrs_SalaryDistPlanMember]'))
ALTER TABLE [dbo].[hrs_SalaryDistPlanMember] CHECK CONSTRAINT [FK_hrs_SalaryDistPlanMember_hrs_SalaryDistPlan]
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_hrs_SalaryDistProjects_hrs_Projects]') AND parent_object_id = OBJECT_ID(N'[dbo].[hrs_SalaryDistProjects]'))
ALTER TABLE [dbo].[hrs_SalaryDistProjects]  WITH CHECK ADD  CONSTRAINT [FK_hrs_SalaryDistProjects_hrs_Projects] FOREIGN KEY([ProjectID])
REFERENCES [dbo].[hrs_Projects] ([ID])
GO

IF  EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_hrs_SalaryDistProjects_hrs_Projects]') AND parent_object_id = OBJECT_ID(N'[dbo].[hrs_SalaryDistProjects]'))
ALTER TABLE [dbo].[hrs_SalaryDistProjects] CHECK CONSTRAINT [FK_hrs_SalaryDistProjects_hrs_Projects]
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_hrs_SalaryDistProjects_hrs_SalaryDist]') AND parent_object_id = OBJECT_ID(N'[dbo].[hrs_SalaryDistProjects]'))
ALTER TABLE [dbo].[hrs_SalaryDistProjects]  WITH CHECK ADD  CONSTRAINT [FK_hrs_SalaryDistProjects_hrs_SalaryDist] FOREIGN KEY([SalaryDistributionID])
REFERENCES [dbo].[hrs_SalaryDist] ([ID])
GO

IF  EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_hrs_SalaryDistProjects_hrs_SalaryDist]') AND parent_object_id = OBJECT_ID(N'[dbo].[hrs_SalaryDistProjects]'))
ALTER TABLE [dbo].[hrs_SalaryDistProjects] CHECK CONSTRAINT [FK_hrs_SalaryDistProjects_hrs_SalaryDist]
GO

IF NOT EXISTS (SELECT * FROM sys.fn_listextendedproperty(N'MS_DiagramPane1' , N'SCHEMA',N'dbo', N'VIEW',N'hrs_PaidSalaries', NULL,NULL))
	EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[35] 4[26] 2[13] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "hrs_Employees"
            Begin Extent = 
               Top = 7
               Left = 48
               Bottom = 170
               Right = 283
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "hrs_EmployeesTransactions"
            Begin Extent = 
               Top = 7
               Left = 331
               Bottom = 256
               Right = 598
            End
            DisplayFlags = 280
            TopColumn = 10
         End
         Begin Table = "hrs_EmployeesTransactionsProjects"
            Begin Extent = 
               Top = 7
               Left = 646
               Bottom = 170
               Right = 898
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "hrs_EmployeesTransactionsDetails"
            Begin Extent = 
               Top = 7
               Left = 946
               Bottom = 311
               Right = 1246
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "hrs_TransactionsTypes"
            Begin Extent = 
               Top = 193
               Left = 672
               Bottom = 356
               Right = 915
            End
            DisplayFlags = 280
            TopColumn = 12
         End
         Begin Table = "sys_FiscalYearsPeriods"
            Begin Extent = 
               Top = 185
               Left = 98
               Bottom = 348
               Right = 300
            End
            DisplayFlags = 280
            TopColumn = 1
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'hrs_PaidSalaries'
GO

IF NOT EXISTS (SELECT * FROM sys.fn_listextendedproperty(N'MS_DiagramPane2' , N'SCHEMA',N'dbo', N'VIEW',N'hrs_PaidSalaries', NULL,NULL))
	EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N'      Begin ColumnWidths = 9
         Width = 284
         Width = 1200
         Width = 1104
         Width = 3420
         Width = 3420
         Width = 1284
         Width = 1200
         Width = 1200
         Width = 1200
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 12
         Column = 1440
         Alias = 1344
         Table = 2892
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1356
         SortOrder = 1416
         GroupBy = 1350
         Filter = 1356
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'hrs_PaidSalaries'
GO

IF NOT EXISTS (SELECT * FROM sys.fn_listextendedproperty(N'MS_DiagramPaneCount' , N'SCHEMA',N'dbo', N'VIEW',N'hrs_PaidSalaries', NULL,NULL))
	EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'hrs_PaidSalaries'
GO

CREATE OR ALTER PROCEDURE [dbo].[DistributedSalaries]
	  @FCode varchar(30) = ''
	, @ECode varchar(50) = ''
	, @PCode varchar(50) = ''
As
SELECT 
	EMP.Code AS EC
	, dbo.fn_GetEmpName(EMP.Code, 1) AS EArbName
	, dbo.fn_GetEmpName(EMP.Code, 2) AS EEngName
	, FYP.ArbName AS FArbName
	, FYP.EngName AS FEngName
	, FYP.Code AS FC
	, PRJ.ArbName AS PArbName
	, PRJ.EngName AS PEngName
	, PRJ.Code AS PC
	, SDE.ProjectPercentage AS PP
	, SDE.ProjectAmount AS PA
FROM     
	dbo.hrs_SalartDistExec AS SDE 
	LEFT OUTER JOIN dbo.sys_FiscalYearsPeriods AS FYP ON SDE.FiscalPeriodID = FYP.ID 
	LEFT OUTER JOIN dbo.hrs_Projects AS PRJ ON SDE.ProjectID = PRJ.ID 
	LEFT OUTER JOIN dbo.hrs_Employees AS EMP ON SDE.EmployeeID = EMP.ID
WHERE
		(ISNULL(@ECode,'')='' or EMP.Code = @ECode)
	AND (ISNULL(@PCode,'')='' or PRJ.Code = @PCode)
	AND (FYP.Code = @FCode OR FYP.EngName = @FCode OR FYP.ArbName = @FCode)
GO

IF(SELECT COUNT(*) FROM sys_ReportsGroups WHERE Code = '020') = 0
BEGIN
 INSERT INTO [dbo].sys_ReportsGroups
           (Code, ModuleID, ParentID, EngName, ArbName, ArbName4S, Rank, CompanyID, Remarks, RegUserID, RegComputerID, RegDate, CancelDate)
     VALUES
           ('020', 2, NULL,	'Salary Distribution Reports', 'تقارير توزيع الراتب' , 'تقارير توزيع الراتب', 1,	14,	NULL, NULL, NULL, GETDATE(), NULL)
END
GO

IF(SELECT COUNT(*) FROM sys_Reports WHERE Code = 'SDPW') = 0
BEGIN
 INSERT INTO [dbo].sys_Reports
           (Code, EngName, ArbName, ArbName4S, EngDescription, ArbDescription, EngTitle, ArbTitle, ReportGroupID, ReportSource, DataSource, ScaleFactor, RegDate)
     VALUES
           ('SDPW', 'Salary Distribution Project Wise', 'توزيع الراتب على مستوى المشاريع', 'توزيع الراتب على مستوى المشاريع', NULL, NULL, 'Salary Distribution Project Wise', 'توزيع الراتب على مستوى المشاريع', (SELECT TOP 1 ID FROM sys_ReportsGroups WHERE Code = '020'), 1, 'DistributedSalaries', 0,GETDATE())
END
ELSE
BEGIN
UPDATE [dbo].[sys_Reports] SET ArbName = 'توزيع الراتب على مستوى المشاريع', ArbName4S = 'توزيع الراتب على مستوى المشاريع', ArbTitle = 'توزيع الراتب على مستوى المشاريع', ReportGroupID = (SELECT TOP 1 ID FROM sys_ReportsGroups WHERE Code = '020') WHERE Code = 'SDPW'
END
GO

IF(SELECT COUNT(*) FROM sys_Reports WHERE Code = 'SDEW') = 0
BEGIN
 INSERT INTO [dbo].sys_Reports
           (Code, EngName, ArbName, ArbName4S, EngDescription, ArbDescription, EngTitle, ArbTitle, ReportGroupID, ReportSource, DataSource, ScaleFactor, RegDate)
     VALUES
           ('SDEW', 'Salary Distribution Employee Wise', 'توزيع الراتب على مستوى الموظف', 'توزيع الراتب على مستوى الموظف', NULL, NULL, 'Salary Distribution Employee Wise', 'توزيع الراتب على مستوى الموظف', (SELECT TOP 1 ID FROM sys_ReportsGroups WHERE Code = '020'), 1, 'DistributedSalaries', 0,GETDATE())
END
ELSE
BEGIN
UPDATE [dbo].[sys_Reports] SET ArbName = 'توزيع الراتب على مستوى الموظف', ArbName4S = 'توزيع الراتب على مستوى الموظف', ArbTitle = 'توزيع الراتب على مستوى الموظف', ReportGroupID = (SELECT TOP 1 ID FROM sys_ReportsGroups WHERE Code = '020') WHERE Code = 'SDEW'
END
GO

IF(SELECT COUNT(*) FROM rpw_ReportsCriteriasProperties WHERE ReportID = (SELECT TOP 1 ID FROM sys_Reports WHERE Code = 'SDPW')) = 0
BEGIN
 INSERT INTO [dbo].rpw_ReportsCriteriasProperties
           (Rank, ReportID, FieldName, DataType, Length, EngDescription, ArbDescription, Status, FieldLanguage, SearchID, RegDate)
     VALUES
           (0, (SELECT TOP 1 ID FROM sys_Reports WHERE Code = 'SDPW'), 'FCode', 'String', 30,	'Fiscal Period Code', 'كود الفترة المالية', 1, 3, 117, GETDATE())

 INSERT INTO [dbo].rpw_ReportsCriteriasProperties
           (Rank, ReportID, FieldName, DataType, Length, EngDescription, ArbDescription, Status, FieldLanguage, SearchID, RegDate)
     VALUES
           (1, (SELECT TOP 1 ID FROM sys_Reports WHERE Code = 'SDPW'), 'ECode', 'String', 50,	'Employee Code', 'كود الموظف', 1, 3, 95, GETDATE())
 
 INSERT INTO [dbo].rpw_ReportsCriteriasProperties
           (Rank, ReportID, FieldName, DataType, Length, EngDescription, ArbDescription, Status, FieldLanguage, SearchID, RegDate)
     VALUES
           (2, (SELECT TOP 1 ID FROM sys_Reports WHERE Code = 'SDPW'), 'PCode', 'String', 50,	'Project Code', 'كود المشروع', 1, 3, 11, GETDATE())
END
GO

IF(SELECT COUNT(*) FROM rpw_ReportsCriteriasProperties WHERE ReportID = (SELECT TOP 1 ID FROM sys_Reports WHERE Code = 'SDEW')) = 0
BEGIN
 INSERT INTO [dbo].rpw_ReportsCriteriasProperties
           (Rank, ReportID, FieldName, DataType, Length, EngDescription, ArbDescription, Status, FieldLanguage, SearchID, RegDate)
     VALUES
           (0, (SELECT TOP 1 ID FROM sys_Reports WHERE Code = 'SDEW'), 'FCode', 'String', 30,	'Fiscal Period Code', 'كود الفترة المالية', 1, 3, 117, GETDATE())

 INSERT INTO [dbo].rpw_ReportsCriteriasProperties
           (Rank, ReportID, FieldName, DataType, Length, EngDescription, ArbDescription, Status, FieldLanguage, SearchID, RegDate)
     VALUES
           (1, (SELECT TOP 1 ID FROM sys_Reports WHERE Code = 'SDEW'), 'ECode', 'String', 50,	'Employee Code', 'كود الموظف', 1, 3, 95, GETDATE())
 
 INSERT INTO [dbo].rpw_ReportsCriteriasProperties
           (Rank, ReportID, FieldName, DataType, Length, EngDescription, ArbDescription, Status, FieldLanguage, SearchID, RegDate)
     VALUES
           (2, (SELECT TOP 1 ID FROM sys_Reports WHERE Code = 'SDEW'), 'PCode', 'String', 50,	'Project Code', 'كود المشروعكود المشروعv', 1, 3, 11, GETDATE())
END
GO

IF(SELECT COUNT(*) FROM sys_Forms WHERE Code = 'frmSalaryDist') = 0
BEGIN
 INSERT INTO [dbo].sys_Forms
           (Code, EngName, ArbName, ArbName4S, EngDescription, ArbDescription, Rank, ModuleID, Height, Width, RegDate)
     VALUES
           ('frmSalaryDist','frmSalaryDist.aspx', 'خطة توزيع الراتب', 'خطة توزيع الراتب', 'Salary Distirbution', 'خطة توزيع الراتب', 0, 2, 650, 1100,GETDATE())
END
ELSE
BEGIN
UPDATE [dbo].sys_Forms SET ArbName = 'خطة توزيع الراتب', ArbName4S = 'خطة توزيع الراتب', ArbDescription = 'خطة توزيع الراتب' WHERE Code = 'frmSalaryDist'
END
GO

IF(SELECT COUNT(*) FROM sys_Forms WHERE Code = 'frmSalaryDistPlan') = 0
BEGIN
 INSERT INTO [dbo].sys_Forms
           (Code, EngName, ArbName, ArbName4S, EngDescription, ArbDescription, Rank, ModuleID, Height, Width, RegDate)
     VALUES
           ('frmSalaryDistPlan', 'frmSalaryDistPlan.aspx', 'اسنادات توزيع الراتب', 'اسنادات توزيع الراتب', 'Salary Distribution Appointment', 'اسنادات توزيع الراتب', 0, 2, 650, 1100, GETDATE())
END
ELSE
BEGIN
UPDATE [dbo].sys_Forms SET ArbName = 'اسنادات توزيع الراتب', ArbName4S = 'اسنادات توزيع الراتب', ArbDescription = 'اسنادات توزيع الراتب' WHERE Code = 'frmSalaryDistPlan'
END
GO

IF(SELECT COUNT(*) FROM sys_Forms WHERE Code = 'frmDistributeSalary') = 0
BEGIN
 INSERT INTO [dbo].sys_Forms
           (Code, EngName, ArbName, ArbName4S, EngDescription, ArbDescription, Rank, ModuleID, Height, Width, RegDate)
     VALUES
           ('frmDistributeSalary', 'frmEmployeesSelector.aspx?SM=Dis&', 'توزيع الراتب', 'توزيع الراتب', 'Distribute Salary', 'توزيع الراتب', 0, 2, 650, 1100, GETDATE())
END
ELSE
BEGIN
UPDATE [dbo].sys_Forms SET ArbName = 'توزيع الراتب', ArbName4S = 'توزيع الراتب', ArbDescription = 'توزيع الراتب' WHERE Code = 'frmDistributeSalary'
END
GO

IF(SELECT COUNT(*) FROM sys_Forms WHERE Code = 'frmSalaryEmployeeDistribution') = 0
BEGIN
 INSERT INTO [dbo].sys_Forms
           (Code, EngName, ArbName, ArbName4S, EngDescription, ArbDescription, Rank, ModuleID, Height, Width, RegDate)
     VALUES
           ('frmSalaryEmployeeDistribution', 'frmSalaryEmployeeDistribution.aspx', 'توزيعات موظف معين', 'توزيعات موظف معين', 'Emplyee Salary Distribution', 'توزيعات موظف معين', 0, 2, 650, 1100, GETDATE())
END
ELSE
BEGIN
UPDATE [dbo].sys_Forms SET ArbName = 'توزيعات موظف معين', ArbName4S = 'توزيعات موظف معين', ArbDescription = 'توزيعات موظف معين' WHERE Code = 'frmSalaryEmployeeDistribution'
END
GO

IF(SELECT COUNT(*) FROM sys_Menus WHERE Code = 'SalDis') = 0
BEGIN
 INSERT INTO [dbo].sys_Menus
           (Code, EngName, ArbName, ArbName4S, ParentID, Rank, FormID, ViewFormID, IsHide, ViewType, RegDate)
     VALUES
           ('SalDis', 'Salary Distributions Process', 'عمليات توزيع الرواتب', 'عمليات توزيع الرواتب', 240, 1, NULL, NULL, 0, 1, GETDATE())
END
ELSE
BEGIN
UPDATE sys_Menus SET ArbName = 'عمليات توزيع الرواتب', ArbName4S = 'عمليات توزيع الرواتب' WHERE Code = 'SalDis'
END
GO

IF(SELECT COUNT(*) FROM sys_Menus WHERE Code = 'frmSalaryDist') = 0
BEGIN
 INSERT INTO [dbo].sys_Menus
           (Code, EngName, ArbName, ArbName4S, ParentID, Rank, FormID, ViewFormID, IsHide, ViewType, RegDate)
     VALUES
           ('frmSalaryDist', 'Salary Distirbution', 'خطة توزيع الراتب', 'خطة توزيع الراتب', (SELECT TOP 1 ID FROM sys_Menus WHERE Code = 'SalDis'), 0, (SELECT TOP 1 ID FROM sys_Forms WHERE Code = 'frmSalaryDist'), (SELECT TOP 1 ID FROM sys_Forms WHERE Code = 'frmSalaryDist'), 0, 1, GETDATE())
END
ELSE
BEGIN
UPDATE sys_Menus SET ArbName = 'خطة توزيع الراتب', ArbName4S = 'خطة توزيع الراتب' WHERE Code = 'frmSalaryDist'
END
GO

IF(SELECT COUNT(*) FROM sys_Menus WHERE Code = 'frmSalaryDistPlan') = 0
BEGIN
 INSERT INTO [dbo].sys_Menus
           (Code, EngName, ArbName, ArbName4S, ParentID, Rank, FormID, ViewFormID, IsHide, ViewType, RegDate)
     VALUES
           ('frmSalaryDistPlan', 'Salary Distributions Plan', 'اسنادات توزيع الراتب', 'اسنادات توزيع الراتب', (SELECT TOP 1 ID FROM sys_Menus WHERE Code = 'SalDis'), 1, (SELECT TOP 1 ID FROM sys_Forms WHERE Code = 'frmSalaryDistPlan'), (SELECT TOP 1 ID FROM sys_Forms WHERE Code = 'frmSalaryDistPlan'), 0, 1, GETDATE())
END
ELSE
BEGIN
UPDATE sys_Menus SET ArbName = 'اسنادات توزيع الراتب', ArbName4S = 'اسنادات توزيع الراتب' WHERE Code = 'frmSalaryDistPlan'
END
GO

IF(SELECT COUNT(*) FROM sys_Menus WHERE Code = 'frmDistributeSalary') = 0
BEGIN
 INSERT INTO [dbo].sys_Menus
           (Code, EngName, ArbName, ArbName4S, ParentID, Rank, FormID, ViewFormID, IsHide, ViewType, RegDate)
     VALUES
           ('frmDistributeSalary', 'Distribute Salary', 'توزيع الراتب', 'توزيع الراتب', (SELECT TOP 1 ID FROM sys_Menus WHERE Code = 'SalDis'), 2, (SELECT TOP 1 ID FROM sys_Forms WHERE Code = 'frmDistributeSalary'), (SELECT TOP 1 ID FROM sys_Forms WHERE Code = 'frmDistributeSalary'), 0, 1, GETDATE())
END
ELSE
BEGIN
UPDATE sys_Menus SET ArbName = 'توزيع الراتب', ArbName4S = 'توزيع الراتب' WHERE Code = 'frmDistributeSalary'
END
GO

IF(SELECT COUNT(*) FROM sys_Menus WHERE Code = 'frmSalaryEmployeeDistribution') = 0
BEGIN
 INSERT INTO [dbo].sys_Menus
           (Code, EngName, ArbName, ArbName4S, ParentID, Rank, FormID, ViewFormID, IsHide, ViewType, RegDate)
     VALUES
           ('frmSalaryEmployeeDistribution', 'Emplyee Salary Distribution', 'توزيعات موظف معين', 'توزيعات موظف معين', (SELECT TOP 1 ID FROM sys_Menus WHERE Code = 'SalDis'), 1, (SELECT TOP 1 ID FROM sys_Forms WHERE Code = 'frmSalaryEmployeeDistribution'), (SELECT TOP 1 ID FROM sys_Forms WHERE Code = 'frmSalaryEmployeeDistribution'), 0, 1, GETDATE())
END
ELSE
BEGIN
UPDATE sys_Menus SET ArbName = 'توزيعات موظف معين', ArbName4S = 'توزيعات موظف معين' WHERE Code = 'frmSalaryEmployeeDistribution'
END
GO

CREATE OR ALTER FUNCTION [dbo].[fn_CheckEndOfServiceByPeriodWEnd](@EmpID AS INT,@FiscalPeriod as INT)
RETURNS INT
AS
BEGIN

		RETURN(ISNULL((
			Select top 1 Emp.ID 

			From		hrs_Employees			Emp
			INNER Join	hrs_Contracts			Cont		On Cont.EmployeeID		= Emp.ID 
			Where 	   (Emp.ID		=	@EmpID)
				 And   (Emp.CancelDate Is Null)	
				 And   (Cont.CancelDate Is Null)															   
				 And   (Cont.EndDate Is Null Or Cont.EndDate 		   >= (select ToDate from sys_FiscalYearsPeriods where ID = @FiscalPeriod))       -- Don't get ended contracts
				 And   (Emp.ExcludeDate Is Null Or Emp.ExcludeDate     >= (select FromDate from sys_FiscalYearsPeriods where ID = @FiscalPeriod))       -- Don't get ended service employees
				 And   (Emp.ExcludeDate Is Null Or Emp.ExcludeDate     > (select ToDate from sys_FiscalYearsPeriods where ID = @FiscalPeriod))       -- Don't get ended service employees
				 And   (Cont.StartDate  <= (select ToDate from sys_FiscalYearsPeriods where ID = @FiscalPeriod))       -- Don't get ended contracts
				 And   (Emp.JoinDate <= (select ToDate from sys_FiscalYearsPeriods where ID = @FiscalPeriod))       -- Don't get ended service employees
			ORDER BY Cont.EndDate DESC
		),0))

END
GO

CREATE OR ALTER PROCEDURE [dbo].[FindAllSalaryDist](@employeeID INT)
AS
BEGIN
	SELECT 
		dbo.hrs_SalaryDistPlanMember.SalaryDistPlanID AS AppointID
		, dbo.hrs_SalaryDist.EngName
		, dbo.hrs_SalaryDist.ArbName
		, (SELECT TOP 1 FROMDATE FROM sys_FiscalYearsPeriods WHERE ID = (SUBSTRING(dbo.hrs_SalaryDistPlan.PeriodIDs, 0, 4))) AS FromDate
		, (SELECT TOP 1 TODATE FROM sys_FiscalYearsPeriods WHERE ID = (SUBSTRING(dbo.hrs_SalaryDistPlan.PeriodIDs, LEN(dbo.hrs_SalaryDistPlan.PeriodIDs)-3, 3))) AS ToDate
	FROM     
		dbo.hrs_SalaryDist 
		INNER JOIN dbo.hrs_SalaryDistPlan ON dbo.hrs_SalaryDist.ID = dbo.hrs_SalaryDistPlan.SalaryDistributionID 
		INNER JOIN dbo.hrs_SalaryDistPlanMember ON dbo.hrs_SalaryDistPlan.ID = dbo.hrs_SalaryDistPlanMember.SalaryDistPlanID
    WHERE 
		hrs_SalaryDistPlanMember.EmployeeID = @employeeID
        AND hrs_SalaryDistPlanMember.CancelDate IS NULL
	ORDER BY
		hrs_SalaryDistPlanMember.RegDate DESC
END;
GO

CREATE OR ALTER VIEW [dbo].[hrs_PaidSalaries]
AS
SELECT TOP (100) PERCENT dbo.hrs_Employees.ID, dbo.hrs_Employees.Code, dbo.fn_GetEmpName(dbo.hrs_Employees.Code, 1) AS FullName, dbo.fn_GetEmpName(dbo.hrs_Employees.Code, 2) AS EmpEngName, 
                  dbo.sys_FiscalYearsPeriods.ArbName AS PeriodCode, dbo.sys_FiscalYearsPeriods.ID AS PeriodID, ROUND(SUM(dbo.hrs_TransactionsTypes.Sign * dbo.hrs_EmployeesTransactionsDetails.NumericValue), 0) AS PaidSalary
FROM     dbo.hrs_Employees INNER JOIN
                  dbo.hrs_EmployeesTransactions ON dbo.hrs_Employees.ID = dbo.hrs_EmployeesTransactions.EmployeeID INNER JOIN
                  dbo.hrs_EmployeesTransactionsProjects ON dbo.hrs_EmployeesTransactions.ID = dbo.hrs_EmployeesTransactionsProjects.EmployeeTransactionID INNER JOIN
                  dbo.hrs_EmployeesTransactionsDetails ON dbo.hrs_EmployeesTransactionsProjects.ID = dbo.hrs_EmployeesTransactionsDetails.EmpTransProjID INNER JOIN
                  dbo.hrs_TransactionsTypes ON dbo.hrs_EmployeesTransactionsDetails.TransactionTypeID = dbo.hrs_TransactionsTypes.ID INNER JOIN
                  dbo.sys_FiscalYearsPeriods ON dbo.hrs_EmployeesTransactions.FiscalYearPeriodID = dbo.sys_FiscalYearsPeriods.ID
WHERE  (dbo.hrs_EmployeesTransactions.PrepareType = 'N') AND (dbo.hrs_EmployeesTransactionsDetails.NumericValue > 0) AND (dbo.hrs_EmployeesTransactionsDetails.TextValue = 'Paid')
GROUP BY dbo.hrs_Employees.Code, dbo.hrs_Employees.ArbName + ' ' + dbo.hrs_Employees.FatherArbName + ' ' + dbo.hrs_Employees.GrandArbName + ' ' + dbo.hrs_Employees.FamilyArbName, 
                  dbo.hrs_Employees.EngName + ' ' + dbo.hrs_Employees.FatherEngName + ' ' + dbo.hrs_Employees.GrandEngName + ' ' + dbo.hrs_Employees.FamilyEngName, dbo.sys_FiscalYearsPeriods.ID, dbo.sys_FiscalYearsPeriods.ArbName, 
                  dbo.hrs_Employees.ID
ORDER BY PeriodID DESC
GO

IF NOT EXISTS (SELECT * FROM sys.fn_listextendedproperty(N'MS_DiagramPane1' , N'SCHEMA',N'dbo', N'VIEW',N'hrs_PaidSalaries', NULL,NULL))
	EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[35] 4[26] 2[13] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "hrs_Employees"
            Begin Extent = 
               Top = 7
               Left = 48
               Bottom = 170
               Right = 283
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "hrs_EmployeesTransactions"
            Begin Extent = 
               Top = 7
               Left = 331
               Bottom = 256
               Right = 598
            End
            DisplayFlags = 280
            TopColumn = 10
         End
         Begin Table = "hrs_EmployeesTransactionsProjects"
            Begin Extent = 
               Top = 7
               Left = 646
               Bottom = 170
               Right = 898
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "hrs_EmployeesTransactionsDetails"
            Begin Extent = 
               Top = 7
               Left = 946
               Bottom = 311
               Right = 1246
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "hrs_TransactionsTypes"
            Begin Extent = 
               Top = 193
               Left = 672
               Bottom = 356
               Right = 915
            End
            DisplayFlags = 280
            TopColumn = 12
         End
         Begin Table = "sys_FiscalYearsPeriods"
            Begin Extent = 
               Top = 185
               Left = 98
               Bottom = 348
               Right = 300
            End
            DisplayFlags = 280
            TopColumn = 1
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'hrs_PaidSalaries'
ELSE
BEGIN
	EXEC sys.sp_updateextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[35] 4[26] 2[13] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "hrs_Employees"
            Begin Extent = 
               Top = 7
               Left = 48
               Bottom = 170
               Right = 283
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "hrs_EmployeesTransactions"
            Begin Extent = 
               Top = 7
               Left = 331
               Bottom = 256
               Right = 598
            End
            DisplayFlags = 280
            TopColumn = 10
         End
         Begin Table = "hrs_EmployeesTransactionsProjects"
            Begin Extent = 
               Top = 7
               Left = 646
               Bottom = 170
               Right = 898
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "hrs_EmployeesTransactionsDetails"
            Begin Extent = 
               Top = 7
               Left = 946
               Bottom = 311
               Right = 1246
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "hrs_TransactionsTypes"
            Begin Extent = 
               Top = 193
               Left = 672
               Bottom = 356
               Right = 915
            End
            DisplayFlags = 280
            TopColumn = 12
         End
         Begin Table = "sys_FiscalYearsPeriods"
            Begin Extent = 
               Top = 185
               Left = 98
               Bottom = 348
               Right = 300
            End
            DisplayFlags = 280
            TopColumn = 1
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'hrs_PaidSalaries'
END
GO

IF NOT EXISTS (SELECT * FROM sys.fn_listextendedproperty(N'MS_DiagramPane2' , N'SCHEMA',N'dbo', N'VIEW',N'hrs_PaidSalaries', NULL,NULL))
	EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N'      Begin ColumnWidths = 9
         Width = 284
         Width = 1200
         Width = 1104
         Width = 3420
         Width = 3420
         Width = 1284
         Width = 1200
         Width = 1200
         Width = 1200
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 12
         Column = 1440
         Alias = 1344
         Table = 2892
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1356
         SortOrder = 1416
         GroupBy = 1350
         Filter = 1356
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'hrs_PaidSalaries'
ELSE
BEGIN
	EXEC sys.sp_updateextendedproperty @name=N'MS_DiagramPane2', @value=N'      Begin ColumnWidths = 9
         Width = 284
         Width = 1200
         Width = 1104
         Width = 3420
         Width = 3420
         Width = 1284
         Width = 1200
         Width = 1200
         Width = 1200
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 12
         Column = 1440
         Alias = 1344
         Table = 2892
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1356
         SortOrder = 1416
         GroupBy = 1350
         Filter = 1356
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'hrs_PaidSalaries'
END
GO

IF NOT EXISTS (SELECT * FROM sys.fn_listextendedproperty(N'MS_DiagramPaneCount' , N'SCHEMA',N'dbo', N'VIEW',N'hrs_PaidSalaries', NULL,NULL))
	EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'hrs_PaidSalaries'
ELSE
BEGIN
	EXEC sys.sp_updateextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'hrs_PaidSalaries'
END
GO

UPDATE hrs_EmployeesTransactionsDetails SET TextValue = 'Paid' WHERE TextValue = 'Piaid'

SET ANSI_NULLS ON
GO

CREATE OR ALTER FUNCTION [dbo].[hrs_EndOfServiceAmount] (@EmployeeID int)   
	RETURNS 	money
	As  
Begin
Return isnull((
select NumericValue  from hrs_EmployeesTransactionsDetails empdet
inner join hrs_EmployeesTransactionsProjects empproj on empproj.id=empdet.EmpTransProjID 
inner join hrs_EmployeesTransactions emptrn on emptrn.id=empproj.EmployeeTransactionID 
where	
emptrn.EmployeeID =@EmployeeID  
and emptrn.PrepareType ='E'
) ,0)
End
GO

CREATE OR ALTER PROCEDURE [dbo].[hrs_rptChartEmployeesEOS]	--exec [hrs_rptChartEmployeeseos]
	@EmployeeCode	 	Varchar(max)   = '',
	@EOSCode 		Varchar(max)   = '',
 	@ProfessionCode 		Varchar(max)   = '',
 	@NationalitieCode 		Varchar(max)	  = '',
 	@DepartmentCode		Varchar(max)		='',
 	@BrancheCode			Varchar(max)	  = '',	
	@SponsorCode    Varchar(max)	  = '',
	@JoinMonth 		Smalldatetime = '01/01/1900',
	@ToJoinMonth 		Smalldatetime = '01/01/2020'
As
Set Dateformat dmy	
  	
Select	
	hrs_Employees.Code															AS EmpCode,
	IsNull(hrs_Employees.EngName,'')+' '+IsNull(hrs_Employees.FatherEngName,'')+' '+IsNull(hrs_Employees.GrandEngName,'') +' '+ IsNull(hrs_Employees.FamilyEngName,'')				As EmpEngName,
	IsNull(hrs_Employees.ArbName,'')+' '+IsNull(hrs_Employees.FatherArbName,'')+' '+IsNull(hrs_Employees.GrandArbName,'') +' '+ IsNull(hrs_Employees.FamilyArbName,'')				As EmpArbName,
  	sys_Departments.Code as DepartmentsCode,
  	sys_Departments.EngName As DepartmentEngName,
  	sys_Departments.ArbName As DepartmentArbName,		
	sys_Nationalities.EngName AS  NationalityEngName,
	sys_Nationalities.ArbName	As NationalityArbName,
	CONVERT(date,hrs_Employees.ExcludeDate)					AS EosDate,
	sys_Branches.Code						As BranchesCode,
	sys_Branches.EngName				As BranchEngName,
	sys_Branches.ArbName				As BranchArbName,
	hrs_Sponsors.EngName				As SponsorEngName,
	hrs_Sponsors.ArbName				As SponsorArbName,
	hrs_EndOfServices.ArbName		As EOSArbName,
	hrs_EndOfServices.EngName		As EOSEngName,
	dbo.hrs_EndOfServiceAmount(hrs_Employees.id) as EOSPaidValue,
	CONVERT(date,hrs_employees.JoinDate) as joindate,
	CONVERT(date,hrs_employees.BirthDate) as birthdate,
	dbo.fn_GetTotalAdditions(c.id,hrs_Employees.ExcludeDate ) Salary,
	hrs_Positions.ArbName			As PostionArbName,
	hrs_Positions.EngName			As PostionEngName,
	hrs_Employees.SSnNo				As ssnno
From 
	hrs_Employees 
		Left Join hrs_EmployeesJoins		On hrs_Employees.ID= hrs_EmployeesJoins.EmployeeID
		Left Join hrs_EndOfServices		On hrs_EmployeesJoins.EndOfServiceID= hrs_EndOfServices.ID
		Left Join sys_Departments			On sys_Departments.ID=hrs_Employees.DepartmentID
		Left Join sys_Nationalities			On sys_Nationalities.ID= hrs_Employees.NationalityID 
		inner Join (Select Number,EmployeeID,ID,EndDate,ContractTypeID,StartDate,ContractPeriod,PositionID,ProfessionID,EmployeeClassID,GradeStepID From hrs_Contracts 
      Where CancelDate Is Null  
	  And ID = (Select Top 1 Cont.ID  From hrs_Contracts Cont 
				Where cont.StartDate <= GETDATE() 
				--and IsNull(cont.EndDate, '30/12/2070') >= GETDATE() 
				and Cont.EmployeeID = hrs_Contracts.EmployeeID 
				And cont.CancelDate Is Null 
				Order by IsNull(Cont.EndDate,'30/12/2070') Desc)
				 ) C On hrs_Employees.ID = C.EmployeeID
		Left Join hrs_Professions			On hrs_Professions.ID=C.ProfessionID 
		Left Join sys_Branches				On sys_Branches.ID = hrs_Employees.BranchID
		Left JOin hrs_Sponsors				On hrs_Sponsors.ID = hrs_Employees.SponsorID
		LEFT JOIN hrs_Contracts				On hrs_Contracts.EmployeeID = hrs_Employees.ID and hrs_Contracts.CancelDate is not null
		LEFT JOIN hrs_Positions				On hrs_Positions.ID = hrs_Contracts.PositionID
Where 
	hrs_Employees.CancelDate			Is Null and isnull(hrs_Employees.RegComputerID,0) = 0
	and (@EmployeeCode = '' or hrs_Employees.Code					Like @EmployeeCode + '%')
AND (@NationalitieCode = '' or sys_Nationalities.Code 				LIKE @NationalitieCode + '%')
And (@DepartmentCode = '' or sys_Departments.Code				Like @DepartmentCode+'%')
And (@BrancheCode = '' or sys_Branches.Code					Like @BrancheCode + '%')
And (@SponsorCode = '' or hrs_Sponsors.Code					Like @SponsorCode +'%')
And hrs_Employees.ExcludeDate between @JoinMonth and @ToJoinMonth	
And (@EOSCode = '' or hrs_EndOfServices.Code					Like @EOSCode + '%')
Order by 
Case When IsNumeric(hrs_Employees.Code) = 1 then Right(Replicate('0',51) + hrs_Employees.Code, 50) When IsNumeric(hrs_Employees.Code) = 0 then Left(hrs_Employees.Code + Replicate('',51), 50) Else hrs_Employees.Code End
GO

IF COL_LENGTH('sys_Companies', 'AllowOverVacation') IS NULL  
BEGIN
    ALTER TABLE sys_Companies
    ADD AllowOverVacation
 bit
END
GO


IF NOT EXISTS
(
    SELECT name
    FROM sysobjects
    WHERE name = 'hrs_SalaryProductionColumns'
)
BEGIN
    CREATE TABLE [dbo].[hrs_SalaryProductionColumns](
														[Id] [int] IDENTITY(1,1) NOT NULL,
														[Name] [varchar](250) NOT NULL,
														[DataSource] [varchar](1000) NOT NULL,
														[RegUserID] [int] NULL,
														[RegComputerID] [int] NULL,
														[RegDate] [smalldatetime] NOT NULL,
														[CancelDate] [smalldatetime] NULL,
														CONSTRAINT [PK_SalaryProductionfields] PRIMARY KEY CLUSTERED 
														([Id] ASC)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
													) ON [PRIMARY]
	SET IDENTITY_INSERT [dbo].[hrs_SalaryProductionColumns] ON 
	INSERT [dbo].[hrs_SalaryProductionColumns] ([Id], [Name], [DataSource], [RegUserID], [RegComputerID], [RegDate], [CancelDate]) VALUES (5, N'Employee Code', N'e.Code', NULL, NULL, CAST(N'2022-07-02T13:24:00' AS SmallDateTime), NULL)
	INSERT [dbo].[hrs_SalaryProductionColumns] ([Id], [Name], [DataSource], [RegUserID], [RegComputerID], [RegDate], [CancelDate]) VALUES (6, N'Employee ArbName', N'dbo.fn_GetEmpName(e.Code,1)', NULL, NULL, CAST(N'2022-07-02T13:24:00' AS SmallDateTime), NULL)
	INSERT [dbo].[hrs_SalaryProductionColumns] ([Id], [Name], [DataSource], [RegUserID], [RegComputerID], [RegDate], [CancelDate]) VALUES (8, N'Employee EngName', N'dbo.fn_GetEmpName(e.Code,0)', NULL, NULL, CAST(N'2022-07-02T13:25:00' AS SmallDateTime), NULL)
	INSERT [dbo].[hrs_SalaryProductionColumns] ([Id], [Name], [DataSource], [RegUserID], [RegComputerID], [RegDate], [CancelDate]) VALUES (9, N'Iqama', N'isnull(e.SSnNo,'''')', NULL, NULL, CAST(N'2022-07-02T13:25:00' AS SmallDateTime), NULL)
	INSERT [dbo].[hrs_SalaryProductionColumns] ([Id], [Name], [DataSource], [RegUserID], [RegComputerID], [RegDate], [CancelDate]) VALUES (10, N'Account Number', N'Char(39) + isnull(e.BankAccountNumber,'''')', NULL, NULL, CAST(N'2022-07-02T13:26:00' AS SmallDateTime), NULL)
	INSERT [dbo].[hrs_SalaryProductionColumns] ([Id], [Name], [DataSource], [RegUserID], [RegComputerID], [RegDate], [CancelDate]) VALUES (11, N'Bank Name', N'B.Code', NULL, NULL, CAST(N'2022-07-02T13:26:00' AS SmallDateTime), NULL)
	INSERT [dbo].[hrs_SalaryProductionColumns] ([Id], [Name], [DataSource], [RegUserID], [RegComputerID], [RegDate], [CancelDate]) VALUES (12, N'Net Salary', N'dbo.fn_GetNetSalary(e.ID,@FisicalPeriodId)', NULL, NULL, CAST(N'2022-07-02T13:26:00' AS SmallDateTime), NULL)
	INSERT [dbo].[hrs_SalaryProductionColumns] ([Id], [Name], [DataSource], [RegUserID], [RegComputerID], [RegDate], [CancelDate]) VALUES (13, N'Basic', N'dbo.fn_GetTotalBasic(e.ID,@FisicalPeriodId) ', NULL, NULL, CAST(N'2022-07-02T13:27:00' AS SmallDateTime), NULL)
	INSERT [dbo].[hrs_SalaryProductionColumns] ([Id], [Name], [DataSource], [RegUserID], [RegComputerID], [RegDate], [CancelDate]) VALUES (14, N'House', N'dbo.fn_GetTotalHousing(e.ID,@FisicalPeriodId)', NULL, NULL, CAST(N'2022-07-02T13:27:00' AS SmallDateTime), NULL)
	INSERT [dbo].[hrs_SalaryProductionColumns] ([Id], [Name], [DataSource], [RegUserID], [RegComputerID], [RegDate], [CancelDate]) VALUES (15, N'Other benfits', N'dbo.fn_GetTotalOthers(e.ID,@FisicalPeriodId)', NULL, NULL, CAST(N'2022-07-02T13:27:00' AS SmallDateTime), NULL)
	INSERT [dbo].[hrs_SalaryProductionColumns] ([Id], [Name], [DataSource], [RegUserID], [RegComputerID], [RegDate], [CancelDate]) VALUES (16, N'Dedcutions', N'dbo.fn_GetTotalDeductions(e.ID,@FisicalPeriodId)', NULL, NULL, CAST(N'2022-07-02T13:28:00' AS SmallDateTime), NULL)
	INSERT [dbo].[hrs_SalaryProductionColumns] ([Id], [Name], [DataSource], [RegUserID], [RegComputerID], [RegDate], [CancelDate]) VALUES (17, N'Branch', N'isnull((select ArbName from sys_Branches where ID = e.BranchID),'''')', NULL, NULL, CAST(N'2022-07-02T15:11:00' AS SmallDateTime), NULL)
	INSERT [dbo].[hrs_SalaryProductionColumns] ([Id], [Name], [DataSource], [RegUserID], [RegComputerID], [RegDate], [CancelDate]) VALUES (18, N'LaborOffice', N'isnull(e.LaborOfficeNo,'''')', NULL, NULL, CAST(N'2022-07-02T15:12:00' AS SmallDateTime), NULL)
	SET IDENTITY_INSERT [dbo].[hrs_SalaryProductionColumns] OFF
	ALTER TABLE [dbo].[hrs_SalaryProductionColumns] ADD  CONSTRAINT [DF_SalaryProductionfields_RegDate]  DEFAULT (getdate()) FOR [RegDate]
END
GO

IF NOT EXISTS
(
    SELECT name
    FROM sysobjects
    WHERE name = 'hrs_SalaryProductionFiles'
)
BEGIN
	CREATE TABLE [dbo].[hrs_SalaryProductionFiles](
													[Id] [int] IDENTITY(1,1) NOT NULL,
													[Code] [varchar](50) NOT NULL,
													[EngName] [varchar](250) NOT NULL,
													[ArbName] [varchar](250) NOT NULL,
													[RegUserID] [int] NULL,
													[RegComputerID] [int] NULL,
													[RegDate] [smalldatetime] NOT NULL,
													[CancelDate] [smalldatetime] NULL,
													CONSTRAINT [PK_SlaryProductionFiles] PRIMARY KEY CLUSTERED 
													([Id] ASC)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
												 ) ON [PRIMARY]
	SET IDENTITY_INSERT [dbo].[hrs_SalaryProductionFiles] ON 
	SET IDENTITY_INSERT [dbo].[hrs_SalaryProductionFiles] OFF
	ALTER TABLE [dbo].[hrs_SalaryProductionFiles] ADD  CONSTRAINT [DF_SlaryProductionFiles_RegDate]  DEFAULT (getdate()) FOR [RegDate]
END
GO

IF NOT EXISTS
(
    SELECT name
    FROM sysobjects
    WHERE name = 'hrs_SalaryProductionFilesColumns'
)
BEGIN
	CREATE TABLE [dbo].[hrs_SalaryProductionFilesColumns](
															[Id] [int] IDENTITY(1,1) NOT NULL,
															[SalaryProductionFileId] [int] NOT NULL,
															[SalaryProductionColumnId] [int] NOT NULL,
															[Name] [varchar](250) NULL,
															[RegUserID] [int] NULL,
															[RegComputerID] [int] NULL,
															[RegDate] [smalldatetime] NOT NULL,
															[CancelDate] [smalldatetime] NULL,
															CONSTRAINT [PK_SalaryProductionFilesFields] PRIMARY KEY CLUSTERED 
															([Id] ASC)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
														) ON [PRIMARY]
	SET IDENTITY_INSERT [dbo].[hrs_SalaryProductionFilesColumns] ON 
	SET IDENTITY_INSERT [dbo].[hrs_SalaryProductionFilesColumns] OFF
	ALTER TABLE [dbo].[hrs_SalaryProductionFilesColumns] ADD  CONSTRAINT [DF_SalaryProductionFilesFields_RegDate]  DEFAULT (getdate()) FOR [RegDate]
	ALTER TABLE [dbo].[hrs_SalaryProductionFilesColumns]  WITH CHECK ADD  CONSTRAINT [FK_hrs_SalaryProductionFilesColumns_hrs_SalaryProductionColumns] FOREIGN KEY([SalaryProductionColumnId])
	REFERENCES [dbo].[hrs_SalaryProductionColumns] ([Id])
	ON DELETE CASCADE
	ALTER TABLE [dbo].[hrs_SalaryProductionFilesColumns] CHECK CONSTRAINT [FK_hrs_SalaryProductionFilesColumns_hrs_SalaryProductionColumns]
	ALTER TABLE [dbo].[hrs_SalaryProductionFilesColumns]  WITH CHECK ADD  CONSTRAINT [FK_hrs_SalaryProductionFilesColumns_hrs_SalaryProductionFiles] FOREIGN KEY([SalaryProductionFileId])
	REFERENCES [dbo].[hrs_SalaryProductionFiles] ([Id])
	ON DELETE CASCADE
	ALTER TABLE [dbo].[hrs_SalaryProductionFilesColumns] CHECK CONSTRAINT [FK_hrs_SalaryProductionFilesColumns_hrs_SalaryProductionFiles]
END
GO

IF(SELECT COUNT(*) FROM sys_Forms WHERE Code = 'frmSalaryProductionFilesSetting') = 0
BEGIN
	INSERT INTO [dbo].[sys_Forms] ( [Code], [EngName], [ArbName], [ArbName4S], [EngDescription], [ArbDescription], [Rank], [ModuleID], [SearchFormID], [Height], [Width], [Remarks], [RegUserID], [RegComputerID], [RegDate], [CancelDate], [Layout], [LinkTarget], [LinkUrl], [ImageUrl], [MainID]) 
	VALUES ( 'frmSalaryProductionFilesSetting', 'frmSalaryProductionFilesSetting.aspx', NULL, NULL, 'Salary Protection File Settings', 'إعداد ملف حماية الأجور', 0, 2, NULL, 650, 1100, NULL, NULL, NULL, '20110726 13:23:00.000', NULL, NULL, NULL, NULL, NULL, NULL)
END
GO

IF(SELECT COUNT(*) FROM sys_Menus WHERE Code = 'frmSalaryProductionFilesSetting') = 0
BEGIN
	INSERT INTO [dbo].[sys_Menus] ( [Code], [EngName], [ArbName], [ArbName4S], [ParentID], [Shortcut], [Rank], [FormID], [ObjectID], [ViewFormID], [IsHide], [Image], [ViewType], [RegUserID], [RegComputerID], [RegDate], [CancelDate]) 
	VALUES ( 'frmSalaryProductionFilesSetting', 'Salary Protection File Settings', 'إعداد ملف حماية الأجور', 'إعداد ملف حماية الأجور', (SELECT ID FROM sys_Menus WHERE CODE = '0024'), NULL, 9, (SELECT ID FROM sys_Forms WHERE Code = 'frmSalaryProductionFilesSetting'), NULL, NULL, 0, NULL, 1, NULL, NULL, '20110726 14:00:00.000', NULL)
END
GO

IF(SELECT COUNT(*) FROM sys_FormsPermissions WHERE UserID = 1 AND FormID = 
			(SELECT ID FROM sys_Forms WHERE Code = 'frmSalaryProductionFilesSetting')) = 0
BEGIN
 INSERT INTO [dbo].[sys_FormsPermissions] ([FormID] ,[UserID] ,[AllowView] ,[AllowAdd] ,[AllowEdit] ,[AllowDelete] ,[AllowPrint] ,[RegUserID] ,[RegDate])
     VALUES ((SELECT ID FROM sys_Forms WHERE Code = 'frmSalaryProductionFilesSetting') ,1 ,1 ,1 ,1 ,1 ,1 ,1 ,GETDATE())
END
GO


IF(SELECT COUNT(*) FROM sys_Forms WHERE Code = 'frmSalaryProtectionSystem2') = 0
BEGIN
	INSERT INTO [dbo].[sys_Forms] ( [Code], [EngName], [ArbName], [ArbName4S], [EngDescription], [ArbDescription], [Rank], [ModuleID], [SearchFormID], [Height], [Width], [Remarks], [RegUserID], [RegComputerID], [RegDate], [CancelDate], [Layout], [LinkTarget], [LinkUrl], [ImageUrl], [MainID]) 
	VALUES ( 'frmSalaryProtectionSystem2', 'frmSalaryProtectionSystem2.aspx', NULL, NULL, 'Salary Protection Bank File', 'ملف حماية الأجور للبنوك', 0, 2, NULL, 650, 1100, NULL, NULL, NULL, '20110726 13:23:00.000', NULL, NULL, NULL, NULL, NULL, NULL)
END
GO

IF(SELECT COUNT(*) FROM sys_Menus WHERE Code = 'frmSalaryProtectionSystem2') = 0
BEGIN
	INSERT INTO [dbo].[sys_Menus] ( [Code], [EngName], [ArbName], [ArbName4S], [ParentID], [Shortcut], [Rank], [FormID], [ObjectID], [ViewFormID], [IsHide], [Image], [ViewType], [RegUserID], [RegComputerID], [RegDate], [CancelDate]) 
	VALUES ( 'frmSalaryProtectionSystem2', 'Salary Protection Bank File', 'ملف حماية الأجور للبنوك', 'ملف حماية الأجور للبنوك', (SELECT ID FROM sys_Menus WHERE CODE = '0024'), NULL, 9, (SELECT ID FROM sys_Forms WHERE Code = 'frmSalaryProtectionSystem2'), NULL, NULL, 0, NULL, 1, NULL, NULL, '20110726 14:00:00.000', NULL)
END
GO

IF(SELECT COUNT(*) FROM sys_FormsPermissions WHERE UserID = 1 AND FormID = 
			(SELECT ID FROM sys_Forms WHERE Code = 'frmSalaryProtectionSystem2')) = 0
BEGIN
 INSERT INTO [dbo].[sys_FormsPermissions] ([FormID] ,[UserID] ,[AllowView] ,[AllowAdd] ,[AllowEdit] ,[AllowDelete] ,[AllowPrint] ,[RegUserID] ,[RegDate])
     VALUES ((SELECT ID FROM sys_Forms WHERE Code = 'frmSalaryProtectionSystem2') ,1 ,1 ,1 ,1 ,1 ,1 ,1 ,GETDATE())
END
GO

IF COL_LENGTH('hrs_SalaryProductionFiles', 'CompanyID') IS NULL  
BEGIN
    ALTER TABLE hrs_SalaryProductionFiles
    ADD CompanyID int
END
GO

IF COL_LENGTH('hrs_EmployeesVacations', 'ParentVacationID') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeesVacations
    ADD ParentVacationID int
END
GO


CREATE OR ALTER PROCEDURE [dbo].[hrs_rptVacationFroms]
	@EmpVacID		INT
AS
BEGIN
	
	SET Dateformat DMY;

	Declare @VacType AS Int = (Select Top 1 ID From hrs_VacationsTypes Where IsAnnual=1)

	Select 
		Emp.Code								As EmpCode,
		Emp.SSnNo                               AS EMPIQAMA,
		dbo.fn_GetEmpName(Emp.Code,0)			As EmpEngName,
		dbo.fn_GetEmpName(Emp.Code,1)			As EmpArbName,
		CONVERT(varchar(10),Emp.JoinDate,105)				As JoinDate,
		
		CONVERT(varchar(10),ExpectedStartDate,105)	As ExpectedStartDate,
		CONVERT(varchar(10),ExpectedEndDate,105)	As ExpectedEndDate,
		CONVERT(varchar(10),ISNULL((select top 1 ActualEndDate from hrs_EmployeesVacations where CancelDate is null and EmployeeID = Emp.ID order by ActualEndDate desc),isnull((select GBalanceDate from hrs_EmployeeVacationOpenBalance where EmployeeID = emp.ID),Emp.JoinDate)),105)
		As LastVacationDate,
		CONVERT(varchar(10),EmpVac.ActualStartDate,105)	As StartDate,
		CONVERT(varchar(10),EmpVac.ActualEndDate,105)		As EndDate,
		EmpVac.TotalDays,
		EmpVac.RemainingDays,
		EmpVac.ConsumDays,
		EmpVac.Remarks,
		
		Dep.EngName								As DepEngName,
		Dep.ArbName								As DepArbName,
		
		Pos.EngName								As PosEngName,
		Pos.ArbName								As PosArbName 

		, (SELECT TOP 1 ISNULL(ConsumDays,0) FROM hrs_EmployeesVacations WHERE ParentVacationID = @EmpVacID AND CancelDate IS NULL) AS UnPaid_DAYS
		, EmpVac.vactiondays
	From hrs_Employees							Emp 
	Inner Join hrs_EmployeesVacations			EmpVac		On EmpVac.EmployeeID = Emp.ID
	Inner Join hrs_Contracts					Cont		On Cont.EmployeeID = Emp.ID 
	Left  Join sys_Departments					Dep			On Dep.ID = Emp.DepartmentID 
	Left  Join hrs_Positions					Pos			On Pos.ID = Cont.PositionID 

	Where
		EmpVac.ID = @EmpVacID
		And EmpVac.VacationTypeID = @VacType
		And EmpVac.CancelDate Is Null
		And Emp.CancelDate Is Null
End
GO

CREATE OR ALTER PROCEDURE [dbo].[GetAllEmployeePreviousVacationsForPeriod] 
	-- Add the parameters for the stored procedure here
	
	@EmployeeID AS INT
	, @PeriodID AS INT
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @SD AS Date = (SELECT FromDate FROM sys_FiscalYearsPeriods WHERE ID = @PeriodID)
	DECLARE @ED AS Date = (SELECT ToDate FROM sys_FiscalYearsPeriods WHERE ID = @PeriodID)
	SELECT 
		OV.ActualStartDate AS VS, OV.ActualEndDate AS VE, OV.ConsumDays AS VD, VT.ID as VTID, VT.EngName AS VTYPE, @SD AS FSD, @ED AS FED
	FROM
		hrs_EmployeesVacations OV
		INNER JOIN hrs_VacationsTypes VT ON OV.VacationTypeID = VT.ID
	WHERE
		OV.EmployeeID = @EmployeeID 
		AND OV.CancelDate IS NULL
		AND (OV.ActualStartDate BETWEEN @SD AND @ED OR OV.ActualEndDate BETWEEN @SD AND @ED)
END
GO

ALTER FUNCTION [dbo].[GetVacation_BalanceByDate](@EmpCode Varchar(30),@CDate date,@fromdate date=null,@IsLessThanCurrentTodate bit=false)
Returns real
As
Begin
Declare @CurrentCDateFicalPeriodID int =(select top 1 id from sys_FiscalYearsPeriods where @CDate between FromDate and ToDate)
Declare @EmployeeID int = (select ID from hrs_Employees where Code = @EmpCode)
declare @ContractID int = dbo.hrs_GetEmpCurrentContract(@EmployeeID,@CDate)
Declare @AnnualVacationID As Int = IsNull((Select Top 1 ID From hrs_VacationsTypes Where IsAnnual= 1 And CancelDate Is Null),0)
Declare @ContractStartDate As Smalldatetime = isnull((Select Top(1) StartDate From hrs_Contracts Where EmployeeID = @EmployeeID And CancelDate Is Null And ID = @ContractID),'1900-01-01')-- (isnull(@fiscalyear,'') ='' or FiscalYearPeriodID <@fiscalyear)
Declare @lastVacPaymentdate As Smalldatetime = isnull((Select Top 1 PaidDate From hrs_EmployeesTransactions Inner join Sys_FiscalYearsPeriods On Hrs_EmployeesTransactions.FiscalYearPeriodID = Sys_FiscalYearsPeriods.Id Where EmployeeId = @EmployeeID And PrepareType = 'V' and (@IsLessThanCurrentTodate=0 or  PaidDate <=@CDate )   and (@IsLessThanCurrentTodate=0 or FiscalYearPeriodID <=@CurrentCDateFicalPeriodID )  order by PaidDate desc),'1900-01-01')
Declare @PaymentTrnsID As int = isnull((Select Top 1 hrs_EmployeesTransactions.id From hrs_EmployeesTransactions Inner join Sys_FiscalYearsPeriods On Hrs_EmployeesTransactions.FiscalYearPeriodID = Sys_FiscalYearsPeriods.Id Where EmployeeId = @EmployeeID And PrepareType = 'V' order by todate desc),0)
Declare @LastVacReturn As date = isnull((select MAX(ISNULL(ActualEndDate,'2050-01-01')) from hrs_EmployeesVacations where CancelDate is null and EmployeeID = @EmployeeID and VacationTypeID = @AnnualVacationID and PaymentTrnID is not null),'1900-01-01')
Declare @LastVacRemaining As real = (select top 1 isnull(RemainingDays,0) from hrs_EmployeesVacations where CancelDate is null and EmployeeID = @EmployeeID and VacationTypeID = @AnnualVacationID order by ID desc)
Declare @OpenBalanceDate As Smalldatetime = isnull((select GBalanceDate from hrs_EmployeeVacationOpenBalance where EmployeeID = @EmployeeID),'1900-01-01')
Declare @OpenBalanceDays As real = (select [Days] from hrs_EmployeeVacationOpenBalance where RegComputerID <> 1 and EmployeeID = @EmployeeID)
Declare @TotalWDays as real = DATEDIFF(Day,@ContractStartDate,GETDATE())
declare @ReqWDays As real = (select RequiredWorkingMonths from hrs_ContractsVacations where ContractID = @ContractID and @TotalWDays between ISNULL(FromMonth,0) and ISNULL(ToMonth,999999))
declare @DesDays As real = (select DurationDays from hrs_ContractsVacations where ContractID = @ContractID and @TotalWDays between ISNULL(FromMonth,0) and ISNULL(ToMonth,999999))
declare @CalcDays as real = 0
declare @Lastvactiondays as int =  isnull((select DATEDIFF(day,ActualStartDate,ActualEndDate ) from hrs_EmployeesVacations where CancelDate is null and EmployeeID = @EmployeeID and VacationTypeID = @AnnualVacationID and PaymentTrnID =@PaymentTrnsID),0)
declare @duedays real = 0
declare @vactiotypeCalculationCode varchar(3)=(select code from hrs_VactionTypeCalculation where id in(select VactionTypeCaculation from hrs_VacationsTypes where id=@AnnualVacationID))
declare @joindate date=(select joindate from hrs_employees where id=@EmployeeID )
declare @duedate as date=@joindate
declare @WorkingDayFromstart int =dbo.Fn_GetDays360 (@joindate ,@CDate)
declare @workingDaysToDueDate int=0
declare @ToMonths int
declare @DurationDays					int =0
declare @RequiredWorkingMonths		    real=0
declare @TDays							int=0
declare @UnpaidDays						int=0
declare @VactionOpenBalance             real=0
--ADDED BY MOHANNAD
-------------------
DECLARE @START_CAL_DATE			date
Declare @Contract_StartDate		date
Declare @Contract_EndDate		date
Declare @JoindateNew			date
Declare @EndContract			date
Declare CurX Cursor  For
Select StartDate,enddate from hrs_Contracts Where EmployeeID = 17
Open 	CurX
FETCH NEXT FROM CurX into 	
			 @Contract_StartDate
			,@Contract_EndDate
Set @JoindateNew=@Contract_StartDate
Set @EndContract=@Contract_EndDate
while @@FETCH_STATUS =0
Begin
FETCH NEXT FROM CurX into 	
			 @Contract_StartDate
			,@Contract_EndDate
if @Contract_StartDate<>Dateadd(Day,1,@EndContract)
Begin
		Set @Joindate=@Contract_StartDate
End
End
Close CurX
Deallocate CurX
IF @JoindateNew > @LastVacReturn AND @JoindateNew > @OpenBalanceDate
BEGIN
SET @WorkingDayFromstart = dbo.Fn_GetDays360 (@JoindateNew ,@CDate)
set @vactionopenBalance = 0
SET @START_CAL_DATE = @JoindateNew
END
IF @LastVacReturn > @JoindateNew AND @LastVacReturn > @OpenBalanceDate
BEGIN
SET @WorkingDayFromstart = dbo.Fn_GetDays360 (@LastVacReturn ,@CDate)
set @vactionopenBalance = @LastVacRemaining
SET @START_CAL_DATE = @LastVacReturn
END
IF @OpenBalanceDate > @JoindateNew AND @OpenBalanceDate > @LastVacReturn
BEGIN
SET @WorkingDayFromstart = dbo.Fn_GetDays360 (@OpenBalanceDate ,@CDate)
set @vactionopenBalance=dbo.GetVacation_openBalance(@EmployeeID)
SET @START_CAL_DATE = @OpenBalanceDate
END
-------------------
if @vactiotypeCalculationCode ='001' and @lastVacPaymentdate <> '1900-01-01' set @duedate =@lastVacPaymentdate
if @vactiotypeCalculationCode ='002' and @lastVacPaymentdate <> '1900-01-01' set @duedate =DATEADD(Day,(@Lastvactiondays-1),@lastVacPaymentdate)
If @OpenBalanceDate <> '1900-01-01'	 and @OpenBalanceDate >@duedate			 set @duedate = DATEADD(Day,1,@OpenBalanceDate)
if isnull(@fromdate,'')<>'' and @fromdate >@duedate set @duedate =@fromdate
--ADDED BY MOHANNAD
-------------------
SET @duedate = @START_CAL_DATE
-------------------
set @UnpaidDays=dbo.fn__GetEmployeeVacationPenalty(@duedate,@CDate,@EmployeeID)
set @TDays=dbo.Fn_GetDays360(@duedate,@CDate) - @UnpaidDays
--set @workingDaysToDueDate =dbo.Fn_GetDays360 (@joindate ,@duedate)
set @workingDaysToDueDate =dbo.Fn_GetDays360 (@JoindateNew ,@duedate)
if @TDays <= 0 return 0
		
		set @duedays=0
		declare @count int =0
		declare @CursorIndex int =0
		DECLARE Vac_cursor CURSOR Static FOR
		SELECT	
				isnull(ToMonth,0),
				isnull(DurationDays,0),
				isnull(RequiredWorkingMonths,0)
		FROM	hrs_ContractsVacations
		where	ContractID = @ContractId
		OPEN Vac_cursor
		FETCH NEXT FROM Vac_cursor
		INTO @ToMonths,@DurationDays,@RequiredWorkingMonths
		WHILE @@FETCH_STATUS = 0
		BEGIN
				if @ToMonths =0 set @ToMonths =99999
				set @CursorIndex = @CursorIndex+1
				if @CursorIndex =@@CURSOR_ROWS
					begin
						If @TDays > 0 set @duedays +=( @TDays / @RequiredWorkingMonths) * @DurationDays
					end
					else
						begin
							if @WorkingDayFromstart >@ToMonths
								begin
									if @workingDaysToDueDate >@ToMonths GOto NextRow									
									If @workingDaysToDueDate + @TDays > @ToMonths
									begin
										declare @remaingduedays int=0
										set @remaingduedays = @ToMonths - @workingDaysToDueDate
										set @duedays += (@remaingduedays / @RequiredWorkingMonths) * @DurationDays
										set @TDays = @TDays - @remaingduedays
										GOto NextRow									
									end
									If @WorkingDayFromstart = @TDays + @UnpaidDays begin
										set @TDays = @TDays - @RequiredWorkingMonths
										set @duedays = @DurationDays
									end
									Else if @WorkingDayFromstart > @ToMonths begin
										set @duedays += @DurationDays
										set @TDays = @TDays - @RequiredWorkingMonths
										Goto NextRow
									end
									Else
										Goto NextRow
									--end
								end
								else
								 set @duedays += (@TDays / @RequiredWorkingMonths) * @DurationDays set @TDays = 0
								end				
	
		NextRow:
		FETCH NEXT FROM Vac_cursor
		INTO @ToMonths,@DurationDays,@RequiredWorkingMonths
		END
		CLOSE Vac_cursor;
		DEALLOCATE Vac_cursor;
return  round(@duedays+@vactionopenBalance,2)
Return 0
End
GO

ALTER FUNCTION [dbo].[GetVacation_BalanceByDate](@EmpCode Varchar(30),@CDate date,@fromdate date=null,@IsLessThanCurrentTodate bit=false)
Returns real
As
Begin
Declare @CurrentCDateFicalPeriodID int =(select top 1 id from sys_FiscalYearsPeriods where @CDate between FromDate and ToDate)
Declare @EmployeeID int = (select ID from hrs_Employees where Code = @EmpCode)
declare @ContractID int = dbo.hrs_GetEmpCurrentContract(@EmployeeID,@CDate)
Declare @AnnualVacationID As Int = IsNull((Select Top 1 ID From hrs_VacationsTypes Where IsAnnual= 1 And CancelDate Is Null),0)
Declare @ContractStartDate As Smalldatetime = isnull((Select Top(1) StartDate From hrs_Contracts Where EmployeeID = @EmployeeID And CancelDate Is Null And ID = @ContractID),'1900-01-01')-- (isnull(@fiscalyear,'') ='' or FiscalYearPeriodID <@fiscalyear)
Declare @lastVacPaymentdate As Smalldatetime = isnull((Select Top 1 PaidDate From hrs_EmployeesTransactions Inner join Sys_FiscalYearsPeriods On Hrs_EmployeesTransactions.FiscalYearPeriodID = Sys_FiscalYearsPeriods.Id Where EmployeeId = @EmployeeID And PrepareType = 'V' and (@IsLessThanCurrentTodate=0 or  PaidDate <=@CDate )   and (@IsLessThanCurrentTodate=0 or FiscalYearPeriodID <=@CurrentCDateFicalPeriodID )  order by PaidDate desc),'1900-01-01')
Declare @PaymentTrnsID As int = isnull((Select Top 1 hrs_EmployeesTransactions.id From hrs_EmployeesTransactions Inner join Sys_FiscalYearsPeriods On Hrs_EmployeesTransactions.FiscalYearPeriodID = Sys_FiscalYearsPeriods.Id Where EmployeeId = @EmployeeID And PrepareType = 'V' order by todate desc),0)
Declare @LastVacReturn As date = isnull((select MAX(ISNULL(ActualEndDate,'2050-01-01')) from hrs_EmployeesVacations where CancelDate is null and EmployeeID = @EmployeeID and VacationTypeID = @AnnualVacationID and PaymentTrnID is not null),'1900-01-01')
Declare @LastVacRemaining As real = (select top 1 isnull(RemainingDays,0) from hrs_EmployeesVacations where CancelDate is null and EmployeeID = @EmployeeID and VacationTypeID = @AnnualVacationID order by ID desc)
Declare @OpenBalanceDate As date = isnull((select GBalanceDate from hrs_EmployeeVacationOpenBalance where EmployeeID = @EmployeeID),'1900-01-01')
Declare @OpenBalanceDays As real = (select [Days] from hrs_EmployeeVacationOpenBalance where RegComputerID <> 1 and EmployeeID = @EmployeeID)
Declare @TotalWDays as real = DATEDIFF(Day,@ContractStartDate,GETDATE())
declare @ReqWDays As real = (select RequiredWorkingMonths from hrs_ContractsVacations where ContractID = @ContractID and @TotalWDays between ISNULL(FromMonth,0) and ISNULL(ToMonth,999999))
declare @DesDays As real = (select DurationDays from hrs_ContractsVacations where ContractID = @ContractID and @TotalWDays between ISNULL(FromMonth,0) and ISNULL(ToMonth,999999))
declare @CalcDays as real = 0
declare @Lastvactiondays as int =  isnull((select DATEDIFF(day,ActualStartDate,ActualEndDate ) from hrs_EmployeesVacations where CancelDate is null and EmployeeID = @EmployeeID and VacationTypeID = @AnnualVacationID and PaymentTrnID =@PaymentTrnsID),0)
declare @duedays real = 0
declare @vactiotypeCalculationCode varchar(3)=(select code from hrs_VactionTypeCalculation where id in(select VactionTypeCaculation from hrs_VacationsTypes where id=@AnnualVacationID))
declare @joindate date=(select joindate from hrs_employees where id=@EmployeeID )
declare @duedate as date=@joindate
declare @WorkingDayFromstart int =dbo.Fn_GetDays360 (@joindate ,@CDate)
declare @workingDaysToDueDate int=0
declare @ToMonths int
declare @DurationDays					int =0
declare @RequiredWorkingMonths		    real=0
declare @TDays							int=0
declare @UnpaidDays						int=0
declare @VactionOpenBalance             real=0
--ADDED BY MOHANNAD
-------------------
DECLARE @START_CAL_DATE			date
Declare @Contract_StartDate		date
Declare @Contract_EndDate		date
Declare @JoindateNew			date
Declare @EndContract			date
Declare CurX Cursor  For
Select StartDate,enddate from hrs_Contracts Where EmployeeID = 17
Open 	CurX
FETCH NEXT FROM CurX into 	
			 @Contract_StartDate
			,@Contract_EndDate
Set @JoindateNew=@Contract_StartDate
Set @EndContract=@Contract_EndDate
while @@FETCH_STATUS =0
Begin
FETCH NEXT FROM CurX into 	
			 @Contract_StartDate
			,@Contract_EndDate
if @Contract_StartDate<>Dateadd(Day,1,@EndContract)
Begin
		Set @Joindate=@Contract_StartDate
End
End
Close CurX
Deallocate CurX
IF @JoindateNew > @LastVacReturn AND @JoindateNew > @OpenBalanceDate
BEGIN
SET @WorkingDayFromstart = dbo.Fn_GetDays360 (@JoindateNew ,@CDate)
set @vactionopenBalance = 0
SET @START_CAL_DATE = @JoindateNew
END
IF @LastVacReturn > @JoindateNew AND @LastVacReturn > @OpenBalanceDate
BEGIN
SET @WorkingDayFromstart = dbo.Fn_GetDays360 (@LastVacReturn ,@CDate)
set @vactionopenBalance = @LastVacRemaining
SET @START_CAL_DATE = @LastVacReturn
END
IF @OpenBalanceDate > @JoindateNew AND @OpenBalanceDate > @LastVacReturn
BEGIN
SET @WorkingDayFromstart = dbo.Fn_GetDays360 (@OpenBalanceDate ,@CDate)
set @vactionopenBalance=dbo.GetVacation_openBalance(@EmployeeID)
SET @START_CAL_DATE = @OpenBalanceDate
END
-------------------
if @vactiotypeCalculationCode ='001' and @lastVacPaymentdate <> '1900-01-01' set @duedate =@lastVacPaymentdate
if @vactiotypeCalculationCode ='002' and @lastVacPaymentdate <> '1900-01-01' set @duedate =DATEADD(Day,(@Lastvactiondays-1),@lastVacPaymentdate)
If @OpenBalanceDate <> '1900-01-01'	 and @OpenBalanceDate >@duedate			 set @duedate = DATEADD(Day,1,@OpenBalanceDate)
if isnull(@fromdate,'')<>'' and @fromdate >@duedate set @duedate =@fromdate
--ADDED BY MOHANNAD
-------------------
SET @duedate = @START_CAL_DATE
-------------------
set @UnpaidDays=dbo.fn__GetEmployeeVacationPenalty(@duedate,@CDate,@EmployeeID)
set @TDays=dbo.Fn_GetDays360(@duedate,@CDate) - @UnpaidDays
--set @workingDaysToDueDate =dbo.Fn_GetDays360 (@joindate ,@duedate)
set @workingDaysToDueDate =dbo.Fn_GetDays360 (@JoindateNew ,@duedate)
if @TDays <= 0 return 0
		
		set @duedays=0
		declare @count int =0
		declare @CursorIndex int =0
		DECLARE Vac_cursor CURSOR Static FOR
		SELECT	
				isnull(ToMonth,0),
				isnull(DurationDays,0),
				isnull(RequiredWorkingMonths,0)
		FROM	hrs_ContractsVacations
		where	ContractID = @ContractId
		OPEN Vac_cursor
		FETCH NEXT FROM Vac_cursor
		INTO @ToMonths,@DurationDays,@RequiredWorkingMonths
		WHILE @@FETCH_STATUS = 0
		BEGIN
				if @ToMonths =0 set @ToMonths =99999
				set @CursorIndex = @CursorIndex+1
				if @CursorIndex =@@CURSOR_ROWS
					begin
						If @TDays > 0 set @duedays +=( @TDays / @RequiredWorkingMonths) * @DurationDays
					end
					else
						begin
							if @WorkingDayFromstart >@ToMonths
								begin
									if @workingDaysToDueDate >@ToMonths GOto NextRow									
									If @workingDaysToDueDate + @TDays > @ToMonths
									begin
										declare @remaingduedays int=0
										set @remaingduedays = @ToMonths - @workingDaysToDueDate
										set @duedays += (@remaingduedays / @RequiredWorkingMonths) * @DurationDays
										set @TDays = @TDays - @remaingduedays
										GOto NextRow									
									end
									If @WorkingDayFromstart = @TDays + @UnpaidDays begin
										set @TDays = @TDays - @RequiredWorkingMonths
										set @duedays = @DurationDays
									end
									Else if @WorkingDayFromstart > @ToMonths begin
										set @duedays += @DurationDays
										set @TDays = @TDays - @RequiredWorkingMonths
										Goto NextRow
									end
									Else
										Goto NextRow
									--end
								end
								else
								 set @duedays += (@TDays / @RequiredWorkingMonths) * @DurationDays set @TDays = 0
								end				
	
		NextRow:
		FETCH NEXT FROM Vac_cursor
		INTO @ToMonths,@DurationDays,@RequiredWorkingMonths
		END
		CLOSE Vac_cursor;
		DEALLOCATE Vac_cursor;
return  round(@duedays+@vactionopenBalance,2)
Return 0
End
GO


ALTER PROCEDURE [dbo].[shift_FindAllAttendWorkPlan](@employeeID INT)
AS
    BEGIN
        
        SELECT Att_AttendAppointmentMembers.AppointID AS AppointID, 
              Att_AttendShifts.Code + ' - ' +  Att_AttendShifts.EngName as EngName,  
               Att_AttendShifts.Code + ' - ' +  Att_AttendShifts.ArbName AS ArbName, 
			   Att_AttendAppointment.FromDate, 
               Att_AttendAppointment.ToDate
        FROM Att_AttendAppointmentMembers
             INNER JOIN Att_AttendAppointment ON Att_AttendAppointment.ID  = Att_AttendAppointmentMembers.AppointID 
             INNER JOIN Att_AttendShifts  ON Att_AttendShifts.id = Att_AttendAppointment.AttendaceShiftID 
        WHERE Att_AttendAppointmentMembers.EmployeeID = @employeeID
              AND Att_AttendAppointmentMembers.CancelDate IS NULL
        ORDER BY Att_AttendAppointment.fromdate DESC;
    END;
GO

IF COL_LENGTH('hrs_EmployeesVacations', 'ZeroingBalance') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeesVacations
    ADD ZeroingBalance bit
END
GO
Drop table Att_TimeRecords
Go
ALTER Proc [dbo].[hrs_FingerprintForCurrntMonth]
@FingerprintID int,
@FromDate DateTime,
@ToDate DateTime
AS
BEGIN
SET DATEFORMAT ymd
 DECLARE
	@ServerIP Varchar(50),
	@DatabaseName Varchar(50),
	@FingerprintTableName Varchar(50),
	@UserIdColumnName Varchar(50),
	@CheckInOutColumnName Varchar(50),
	@Query NVARCHAR (MAX),
	@LastDateFingerPrint DateTime,
	@UsersTableIdntity Varchar(50),
	@UserMatchColumnName Varchar(50),
	@UsersTableName Varchar(50)

SELECT 
	@ServerIP = FingerprintServerIP,
	@DatabaseName = FingerprintDatabaseName,
	@FingerprintTableName = FingerprintTableName,
	@UserIdColumnName = UserIdColumnName,
	@CheckInOutColumnName = CheckInOutColumnName,
	@UsersTableIdntity = UsersTableIdntity,
	@UserMatchColumnName = UserMatchColumnName,
	@UsersTableName = UsersTableName
FROM hrs_FingerprintSettings
WHERE ID = @FingerprintID

SET @ToDate =  DATEADD(DAY, 2, @ToDate) 

IF EXISTS
(
    SELECT name
    FROM sysobjects
    WHERE name = 'hrs_EmployeesFingerprints'
)
BEGIN
    SET DATEFORMAT ymd
	DELETE FROM hrs_EmployeesFingerprints WHERE FingerprintTime BETWEEN @FromDate AND @ToDate

	DECLARE @result TABLE ([FingerprintTime] datetime);

	INSERT INTO @result ([FingerprintTime])
	EXEC (N'SELECT TOP (1) [FingerprintTime] FROM [hrs_EmployeesFingerprints] WHERE [FingerprintID] = ' + @FingerprintID
	    + N' ORDER BY [FingerprintTime] DESC');

	SET @LastDateFingerPrint = (SELECT TOP (1) [FingerprintTime] FROM @result);

	DECLARE @ConvertFromDate varchar(20) 
	DECLARE @ConvertToDate varchar(20) 
	SELECT @ConvertFromDate  = CONVERT(VARCHAR(20), @FromDate, 120)
	SELECT @ConvertToDate  = CONVERT(VARCHAR(20), @ToDate, 120)

	--DELETE FROM hrs_EmployeesFingerprints FOR SPECIFIC PERIOD
	SET @Query = NULL
	SET @Query = N' DELETE FROM hrs_EmployeesFingerprints '
	SET @Query += N' WHERE fp.[' + @CheckInOutColumnName + N'] BETWEEN ''' + @ConvertFromDate + ''''
			    + N' AND ''' + @ConvertToDate + ''''


	-- INSERT INTO hrs_EmployeesFingerprints FOR SPECIFIC PERIOD
	SET @Query = NULL
	SET @Query = N'INSERT INTO hrs_EmployeesFingerprints ([UserID ],'
			   + N'[FingerprintTime], [UserCode], [FingerprintID])'
			   + N'SELECT fp.[' + @UserIdColumnName + N'],'
	           + N' fp.[' + @CheckInOutColumnName + N'],'
			   + N' SUBSTRING(us.[' + @UserMatchColumnName + N'],5,5), '
			   + CAST(@FingerprintID AS NVARCHAR(10))
			   + N' FROM [' + @ServerIP + '].[' + @DatabaseName + N']'
			   + N'.[dbo].[' + @FingerprintTableName + N'] AS fp'
			   + N' INNER JOIN [' + @ServerIP + '].[' + @DatabaseName + N'].[dbo].[' + @UsersTableName + N'] AS us'
			   + N' ON fp.[' + @UserIdColumnName + N'] = us.[' + @UsersTableIdntity + N']'


	SET @Query += N' WHERE fp.[' + @CheckInOutColumnName + N'] BETWEEN ''' + @ConvertFromDate + ''''
			    + N' AND ''' + @ConvertToDate + ''''

	EXEC (@Query)

	--DELETE FROM Att_TimeRecords FOR SPECIFIC PERIOD
	--SET @Query = NULL
	--SET @Query = N' DELETE FROM Att_TimeRecords '
	--SET @Query += N' WHERE Reg_Time BETWEEN ''' + @ConvertFromDate + ''''
	--		    + N' AND ''' + @ConvertToDate + ''''

	--EXEC (@Query)

	--INSERT INTO Att_TimeRecords FOR SPECIFIC PERIOD
	SET @Query = NULL
	--SET @Query = N'INSERT INTO Att_TimeRecords ([MachineCode],'
			 --  + N'[Reg_Time])'
			   --+ N'SELECT SUBSTRING(us.[' + @UserMatchColumnName + N'],5,5),'
	        --   + N' fp.[' + @CheckInOutColumnName + N']'
		--	   + N' FROM [' + @ServerIP + '].[' + @DatabaseName + N']'
		--	   + N'.[dbo].[' + @FingerprintTableName + N'] AS fp'
		--	   + N' INNER JOIN [' + @ServerIP + '].[' + @DatabaseName + N'].[dbo].[' + @UsersTableName + N'] AS us'
		--	   + N' ON fp.[' + @UserIdColumnName + N'] = us.[' + @UsersTableIdntity + N']'

--	SET @Query += N' WHERE fp.[' + @CheckInOutColumnName + N'] BETWEEN ''' + @ConvertFromDate + ''''
--			    + N' AND ''' + @ConvertToDate + ''''

--		EXEC (@Query)

    END
END
GO

ALTER FUNCTION [dbo].[GetVacation_BalanceByDate](@EmpCode Varchar(30),@CDate date,@fromdate date=null,@IsLessThanCurrentTodate bit=false)
Returns real
As
Begin
Declare @CurrentCDateFicalPeriodID int =(select top 1 id from sys_FiscalYearsPeriods where @CDate between FromDate and ToDate)
Declare @EmployeeID int = (select ID from hrs_Employees where Code = @EmpCode)
declare @ContractID int = dbo.hrs_GetEmpCurrentContract(@EmployeeID,@CDate)
Declare @AnnualVacationID As Int = IsNull((Select Top 1 ID From hrs_VacationsTypes Where IsAnnual= 1 And CancelDate Is Null),0)
Declare @ContractStartDate As Smalldatetime = isnull((Select Top(1) StartDate From hrs_Contracts Where EmployeeID = @EmployeeID And CancelDate Is Null And ID = @ContractID),'1900-01-01')-- (isnull(@fiscalyear,'') ='' or FiscalYearPeriodID <@fiscalyear)
Declare @lastVacPaymentdate As Smalldatetime = isnull((Select Top 1 PaidDate From hrs_EmployeesTransactions Inner join Sys_FiscalYearsPeriods On Hrs_EmployeesTransactions.FiscalYearPeriodID = Sys_FiscalYearsPeriods.Id Where EmployeeId = @EmployeeID And PrepareType = 'V' and (@IsLessThanCurrentTodate=0 or  PaidDate <=@CDate )   and (@IsLessThanCurrentTodate=0 or FiscalYearPeriodID <=@CurrentCDateFicalPeriodID )  order by PaidDate desc),'1900-01-01')
Declare @PaymentTrnsID As int = isnull((Select Top 1 hrs_EmployeesTransactions.id From hrs_EmployeesTransactions Inner join Sys_FiscalYearsPeriods On Hrs_EmployeesTransactions.FiscalYearPeriodID = Sys_FiscalYearsPeriods.Id Where EmployeeId = @EmployeeID And PrepareType = 'V' order by todate desc),0)
Declare @LastVacReturn As date = isnull((select MAX(ISNULL(ActualEndDate,'2050-01-01')) from hrs_EmployeesVacations where CancelDate is null and EmployeeID = @EmployeeID and VacationTypeID = @AnnualVacationID and PaymentTrnID is not null),'1900-01-01')
Declare @LastVacRemaining As real = (select top 1 isnull(RemainingDays,0) from hrs_EmployeesVacations where CancelDate is null and EmployeeID = @EmployeeID and VacationTypeID = @AnnualVacationID order by ID desc)
Declare @OpenBalanceDate As date = isnull((select GBalanceDate from hrs_EmployeeVacationOpenBalance where EmployeeID = @EmployeeID),'1900-01-01')
Declare @OpenBalanceDays As real = (select [Days] from hrs_EmployeeVacationOpenBalance where RegComputerID <> 1 and EmployeeID = @EmployeeID)
Declare @TotalWDays as real = DATEDIFF(Day,@ContractStartDate,GETDATE())
declare @ReqWDays As real = (select RequiredWorkingMonths from hrs_ContractsVacations where ContractID = @ContractID and @TotalWDays between ISNULL(FromMonth,0) and ISNULL(ToMonth,999999))
declare @DesDays As real = (select DurationDays from hrs_ContractsVacations where ContractID = @ContractID and @TotalWDays between ISNULL(FromMonth,0) and ISNULL(ToMonth,999999))
declare @CalcDays as real = 0
declare @Lastvactiondays as int =  isnull((select DATEDIFF(day,ActualStartDate,ActualEndDate ) from hrs_EmployeesVacations where CancelDate is null and EmployeeID = @EmployeeID and VacationTypeID = @AnnualVacationID and PaymentTrnID =@PaymentTrnsID),0)
declare @duedays real = 0
declare @vactiotypeCalculationCode varchar(3)=(select code from hrs_VactionTypeCalculation where id in(select VactionTypeCaculation from hrs_VacationsTypes where id=@AnnualVacationID))
declare @joindate date=(select joindate from hrs_employees where id=@EmployeeID )
declare @duedate as date=@joindate
declare @WorkingDayFromstart int =dbo.Fn_GetDays360 (@joindate ,@CDate)
declare @workingDaysToDueDate int=0
declare @ToMonths int
declare @DurationDays					int =0
declare @RequiredWorkingMonths		    real=0
declare @TDays							int=0
declare @UnpaidDays						int=0
declare @VactionOpenBalance             real=0
--ADDED BY MOHANNAD
-------------------
DECLARE @START_CAL_DATE			date
Declare @Contract_StartDate		date
Declare @Contract_EndDate		date
Declare @JoindateNew			date
Declare @EndContract			date
Declare CurX Cursor  For
Select StartDate,enddate from hrs_Contracts Where EmployeeID = @EmployeeID
Open 	CurX
FETCH NEXT FROM CurX into 	
			 @Contract_StartDate
			,@Contract_EndDate
Set @JoindateNew=@Contract_StartDate
Set @EndContract=@Contract_EndDate
while @@FETCH_STATUS =0
Begin
FETCH NEXT FROM CurX into 	
			 @Contract_StartDate
			,@Contract_EndDate
if @Contract_StartDate<>Dateadd(Day,1,@EndContract)
Begin
		Set @Joindate=@Contract_StartDate
End
End
Close CurX
Deallocate CurX
IF @JoindateNew > @LastVacReturn AND @JoindateNew > @OpenBalanceDate
BEGIN
SET @WorkingDayFromstart = dbo.Fn_GetDays360 (@JoindateNew ,@CDate)
set @vactionopenBalance = 0
SET @START_CAL_DATE = @JoindateNew
END
IF @LastVacReturn > @JoindateNew AND @LastVacReturn > @OpenBalanceDate
BEGIN
SET @WorkingDayFromstart = dbo.Fn_GetDays360 (@LastVacReturn ,@CDate)
set @vactionopenBalance = @LastVacRemaining
SET @START_CAL_DATE = @LastVacReturn
END
IF @OpenBalanceDate > @JoindateNew AND @OpenBalanceDate > @LastVacReturn
BEGIN
SET @WorkingDayFromstart = dbo.Fn_GetDays360 (@OpenBalanceDate ,@CDate)
set @vactionopenBalance=dbo.GetVacation_openBalance(@EmployeeID)
SET @START_CAL_DATE = @OpenBalanceDate
END
-------------------
if @vactiotypeCalculationCode ='001' and @lastVacPaymentdate <> '1900-01-01' set @duedate =@lastVacPaymentdate
if @vactiotypeCalculationCode ='002' and @lastVacPaymentdate <> '1900-01-01' set @duedate =DATEADD(Day,(@Lastvactiondays-1),@lastVacPaymentdate)
If @OpenBalanceDate <> '1900-01-01'	 and @OpenBalanceDate >@duedate			 set @duedate = DATEADD(Day,1,@OpenBalanceDate)
if isnull(@fromdate,'')<>'' and @fromdate >@duedate set @duedate =@fromdate
--ADDED BY MOHANNAD
-------------------
SET @duedate = @START_CAL_DATE
-------------------
set @UnpaidDays=dbo.fn__GetEmployeeVacationPenalty(@duedate,@CDate,@EmployeeID)
set @TDays=dbo.Fn_GetDays360(@duedate,@CDate) - @UnpaidDays
--set @workingDaysToDueDate =dbo.Fn_GetDays360 (@joindate ,@duedate)
set @workingDaysToDueDate =dbo.Fn_GetDays360 (@JoindateNew ,@duedate)
if @TDays <= 0 return 0
		
		set @duedays=0
		declare @count int =0
		declare @CursorIndex int =0
		DECLARE Vac_cursor CURSOR Static FOR
		SELECT	
				isnull(ToMonth,0),
				isnull(DurationDays,0),
				isnull(RequiredWorkingMonths,0)
		FROM	hrs_ContractsVacations
		where	ContractID = @ContractId
		OPEN Vac_cursor
		FETCH NEXT FROM Vac_cursor
		INTO @ToMonths,@DurationDays,@RequiredWorkingMonths
		WHILE @@FETCH_STATUS = 0
		BEGIN
				if @ToMonths =0 set @ToMonths =99999
				set @CursorIndex = @CursorIndex+1
				if @CursorIndex =@@CURSOR_ROWS
					begin
						If @TDays > 0 set @duedays +=( @TDays / @RequiredWorkingMonths) * @DurationDays
					end
					else
						begin
							if @WorkingDayFromstart >@ToMonths
								begin
									if @workingDaysToDueDate >@ToMonths GOto NextRow									
									If @workingDaysToDueDate + @TDays > @ToMonths
									begin
										declare @remaingduedays int=0
										set @remaingduedays = @ToMonths - @workingDaysToDueDate
										set @duedays += (@remaingduedays / @RequiredWorkingMonths) * @DurationDays
										set @TDays = @TDays - @remaingduedays
										GOto NextRow									
									end
									If @WorkingDayFromstart = @TDays + @UnpaidDays begin
										set @TDays = @TDays - @RequiredWorkingMonths
										set @duedays = @DurationDays
									end
									Else if @WorkingDayFromstart > @ToMonths begin
										set @duedays += @DurationDays
										set @TDays = @TDays - @RequiredWorkingMonths
										Goto NextRow
									end
									Else
										Goto NextRow
									--end
								end
								else
								 set @duedays += (@TDays / @RequiredWorkingMonths) * @DurationDays set @TDays = 0
								end				
	
		NextRow:
		FETCH NEXT FROM Vac_cursor
		INTO @ToMonths,@DurationDays,@RequiredWorkingMonths
		END
		CLOSE Vac_cursor;
		DEALLOCATE Vac_cursor;
return  round(@duedays+@vactionopenBalance,2)
Return 0
End
GO



ALTER procedure [dbo].[GetEosDetails] --exec GetEosDetails 160

@Employeeid as int
as 
begin 


SELECT			
				TT.ID						AS	TransactionTypeID,
				ETD.NumericValue			AS	Amount ,
				ET.FinancialWorkingUnits ,
				ET.PrepareType				AS	PrepareType,
				TT.ArbName					AS	TransactionArbname,
				TT.Sign						AS	Sign,
				ETD.TextValue				AS Description
FROM			hrs_EmployeesTransactionsDetails  ETD
INNER JOIN		hrs_EmployeesTransactionsProjects ETP		on ETP.id=ETD.EmpTransProjID
INNER JOIN		hrs_EmployeesTransactions ET				on ET.id=ETP.EmployeeTransactionID
INNER JOIN		hrs_employees EMP							on EMP.id=ET.EmployeeID
INNER JOIN		hrs_TransactionsTypes TT					on TT.id=ETD.TransactionTypeID

where EMP.id=@Employeeid
and ET.PrepareType in('E','EN','EV','EL','ET')
--AND ET.ID = (SELECT TOP 1 ID FROM hrs_EmployeesTransactions WHERE EmployeeID = @Employeeid AND PrepareType in('E','EN','EV','EL','ET') ORDER BY ID DESC)

end
GO

-------Rabie 28-12-2022---------------------------------------
ALTER   PROCEDURE [dbo].[GetAllEmployeePreviousVacationsForPeriod] 
	-- Add the parameters for the stored procedure here
	
	@EmployeeID AS INT
	, @PeriodID AS INT
AS
BEGIN
	SET NOCOUNT ON;
	Declare @PrepareDay as int =(select distinct PrepareDay from sys_Branches)
	DECLARE @SD AS Date = (SELECT FromDate FROM sys_FiscalYearsPeriods WHERE ID = @PeriodID)
	DECLARE @ED AS Date = (SELECT ToDate FROM sys_FiscalYearsPeriods WHERE ID = @PeriodID)
	Declare @Previousmonth as int =month(@SD)-1
	if  @Previousmonth=0
	begin
	set @Previousmonth=1
	end
	Declare @year  int 
	if @Previousmonth=1
begin
set @year=year(@SD)-1
end
else
begin
set @year=year(@SD)
end
set @SD=DATEFROMPARTS( @year,@Previousmonth,(@PrepareDay+1) )
	SELECT 
		OV.ActualStartDate AS VS, OV.ActualEndDate AS VE, OV.ConsumDays AS VD, VT.ID as VTID, VT.EngName AS VTYPE, @SD AS FSD,@ED AS FED
	FROM
		hrs_EmployeesVacations OV
		INNER JOIN hrs_VacationsTypes VT ON OV.VacationTypeID = VT.ID
	WHERE
		OV.EmployeeID = @EmployeeID 
		AND OV.CancelDate IS NULL
		AND (OV.ActualStartDate BETWEEN @SD AND @ED OR OV.ActualEndDate BETWEEN @SD AND @ED)
END
Go
---Rabie 4-1-2023

IF Not EXISTS(SELECT 1 FROM sys.columns 
          WHERE Name = N'HasFlexableFingerPrint'
          AND Object_ID = Object_ID(N'dbo.hrs_EmployeesClasses'))
BEGIN
  alter table  hrs_EmployeesClasses add HasFlexableFingerPrint bit null
END
Go





--===========================================================


CREATE TABLE [dbo].[hrs_HmsCommissionTransfer](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[FiscalPeridID] [int] NOT NULL,
	[CommissionCatageryID] [int] NOT NULL,
	[EmployeeId] [int] NOT NULL,
	[Amount] [float] NULL,
	[Dedcution1] [float] NULL,
	[Deduction2] [float] NULL,
	[NetAmount] [float] NULL,
	[CommissionPc] [float] NULL,
	[DueAmount] [float] NULL,
 CONSTRAINT [PK_hrs_HmsCommissionTransfer] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
 CONSTRAINT [IX_hrs_HmsCommissionTransfer] UNIQUE NONCLUSTERED 
(
	[EmployeeId] ASC,
	[FiscalPeridID] ASC,
	[CommissionCatageryID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[hrs_HmsCommissionTransfer]  WITH CHECK ADD  CONSTRAINT [FK_hrs_HmsCommissionTransfer_hrs_Employees] FOREIGN KEY([EmployeeId])
REFERENCES [dbo].[hrs_Employees] ([ID])
GO

ALTER TABLE [dbo].[hrs_HmsCommissionTransfer] CHECK CONSTRAINT [FK_hrs_HmsCommissionTransfer_hrs_Employees]
GO

ALTER TABLE [dbo].[hrs_HmsCommissionTransfer]  WITH CHECK ADD  CONSTRAINT [FK_hrs_HmsCommissionTransfer_hrs_HmsCommissionCategories] FOREIGN KEY([CommissionCatageryID])
REFERENCES [dbo].[hrs_HmsCommissionCategories] ([ID])
GO

ALTER TABLE [dbo].[hrs_HmsCommissionTransfer] CHECK CONSTRAINT [FK_hrs_HmsCommissionTransfer_hrs_HmsCommissionCategories]
GO

ALTER TABLE [dbo].[hrs_HmsCommissionTransfer]  WITH CHECK ADD  CONSTRAINT [FK_hrs_HmsCommissionTransfer_sys_FiscalYearsPeriods] FOREIGN KEY([FiscalPeridID])
REFERENCES [dbo].[sys_FiscalYearsPeriods] ([ID])
GO

ALTER TABLE [dbo].[hrs_HmsCommissionTransfer] CHECK CONSTRAINT [FK_hrs_HmsCommissionTransfer_sys_FiscalYearsPeriods]
GO
CREATE TABLE [dbo].[hrs_HmsCommissionCategories](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[Code] [varchar](50) NULL,
	[Arbname] [varchar](300) NOT NULL,
	[Engname] [varchar](300) NULL,
	[IsLineCommission] [bit] NULL,
	[TotalCommision] [float] NULL,
	[DedcutionPc] [float] NULL,
	[SalaryTransactionID] [int] NOT NULL,
	[Remarks] [varchar](max) NULL,
	[RegUserID] [int] NOT NULL,
	[RegDate] [smalldatetime] NOT NULL,
	[CancelDate] [smalldatetime] NULL,
 CONSTRAINT [PK_hrs_HmsCommissionCategories] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
 CONSTRAINT [IX_hrs_HmsCommissionCategories] UNIQUE NONCLUSTERED 
(
	[Code] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

ALTER TABLE [dbo].[hrs_HmsCommissionCategories] ADD  CONSTRAINT [DF_hrs_HmsPercentageCategories_RegDate]  DEFAULT (getdate()) FOR [RegDate]
GO

alter table  hrs_Employees add Hasflexiblesalarydist bit  null
Go

alter table hrs_SalartDistExec add BasicAmount     decimal(18, 3) null
Go
alter table hrs_SalartDistExec add ExtraAmount     decimal(18, 3) null
Go
alter table hrs_SalartDistExec add TransactionCode decimal(18, 3) null
Go

alter table [dbo].[sys_Departments] add CostCenterCode varchar(50)
go

UPDATE    hrs_EmployeeExtraItems SET ProjectID = N'101'
GO


IF Not EXISTS(SELECT 1 FROM sys.columns 
          WHERE Name = N'IsDGSignature'
          AND Object_ID = Object_ID(N'dbo.sys_ObjectsAttachments'))
BEGIN

alter table sys_ObjectsAttachments add IsDGSignature bit null
END
Go

alter table [dbo].[hrs_EmployeesExcuses] add ExcuseCalcType varchar(50)
go

create FUNCTION  PeriodDateRange ( @minDate_Str NVARCHAR(30), @maxDate_Str NVARCHAR(30))

RETURNS  @Result TABLE(Date NVARCHAR(30) NOT NULL, DateNameEnglish NVARCHAR(30) NOT NULL,DateNameArabic NVARCHAR(30) NOT NULL)

AS

begin

    DECLARE @minDate DATETIME, @maxDate DATETIME
    SET @minDate = CONVERT(Datetime, @minDate_Str,103)
    SET @maxDate = CONVERT(Datetime, @maxDate_Str,103)





    WHILE @maxDate >= @minDate
    BEGIN
      
        INSERT INTO @Result(Date, DateNameEnglish,DateNameArabic )
        SELECT CONVERT(NVARCHAR(10),@minDate,103), CONVERT(NVARCHAR(30),DATENAME(dw,@minDate)),case when  DATENAME(dw,@minDate)= 'Saturday' then 'السبت' when DATENAME(dw,@minDate)= 'Sunday' then  'الأحد'  when DATENAME(dw,@minDate)= 'Monday' then 'الأثنين' when DATENAME(dw,@minDate)= 'Tuesday' then 'الثلاثاء' when DATENAME(dw,@minDate)= 'Wednesday' then 'الاربعاء' when DATENAME(dw,@minDate)= 'Thursday' then 'الخميس' when DATENAME(dw,@minDate)= 'Friday' then 'الجمعة' end  xx
		  SET @minDate = (SELECT DATEADD(dd,1,@minDate))
    END




    return

end 


Go

ALTER PROCEDURE [dbo].[shift_FindAllAttendWorkPlan](@employeeID INT)
AS
    BEGIN
        
        SELECT Att_AttendAppointmentMembers.AppointID AS AppointID, 
              Att_AttendShifts.Code + ' - ' +  Att_AttendShifts.EngName as EngName,  
               Att_AttendShifts.Code + ' - ' +  Att_AttendShifts.ArbName AS ArbName, 
			   Att_AttendAppointment.FromDate, 
               Att_AttendAppointment.ToDate
        FROM Att_AttendAppointmentMembers
             INNER JOIN Att_AttendAppointment ON Att_AttendAppointment.ID  = Att_AttendAppointmentMembers.AppointID 
             INNER JOIN Att_AttendShifts  ON Att_AttendShifts.id = Att_AttendAppointment.AttendaceShiftID 
        WHERE Att_AttendAppointmentMembers.EmployeeID = @employeeID
              AND Att_AttendAppointmentMembers.CancelDate IS NULL
        ORDER BY Att_AttendAppointment.RegDate DESC;
    END;
Go



CREATE TABLE [dbo].[Hrs_PaymentTypes](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[Code] [varchar](50) NULL,
	[EngName] [varchar](50) NULL,
	[ArbName] [varchar](50) NULL,
	[CancelDate] [date] NULL,
 CONSTRAINT [PK_Hrs_PaymentTypes] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO  


IF COL_LENGTH('hrs_Employees', 'paymenttype') IS NULL
BEGIN
    ALTER TABLE hrs_Employees
    ADD paymenttype int
END
GO
IF COL_LENGTH('hrs_VacationsTypes', 'HasPayment') IS NULL
BEGIN
    ALTER TABLE hrs_VacationsTypes
    ADD HasPayment bit
END
GO


IF COL_LENGTH('sys_Companies', 'VacationFromPrepareDay') IS NULL
BEGIN
    ALTER TABLE sys_Companies
    ADD VacationFromPrepareDay bit
END
GO
create or ALTER    PROCEDURE [dbo].[Att_GetCustomAttandace]
 @EmployeeID     AS INT, 
 @Attandancedate AS DATE
AS
SET DATEFIRST 6

IF((SELECT COUNT(*) FROM hrs_EmployeesClassesWeeklyCustomize WHERE EmployeeID = @EmployeeID
	AND @Attandancedate BETWEEN BeginDate AND EndDate) > 0)
BEGIN
SET DATEFORMAT dmy
     SELECT AttShD. DayNo                                AS DayNo,                             
            AttShD.TimeIn1                               AS TimeIn, 
            AttShD.TimeOut1                              AS TimeOut, 
            AttShD.TimeIn2                               AS TimeIn2nd, 
            AttShD.TimeOut2                              AS TimeOut2nd, 
            AttShD.IsDayOff                              AS IsDayOff
			--AttSh.FirstShiftTimeInFingerprintStart       AS FirstShiftTimeInFingerprintStart,
			--AttSh.FirstShiftEntryTimeInClose             AS FirstShiftEntryTimeInClose,
			--AttSh.FirstShiftTimeOutFingerprintClose      AS FirstShiftTimeOutFingerprintClose,
			--AttSh.SecondShiftTimeInFingerprintStart      AS SecondShiftTimeInFingerprintStart,
			--AttSh.SecondShiftEntryTimeInClose            AS SecondShiftEntryTimeInClose,
			--AttSh.SecondShiftTimeOutFingerprintClose     AS SecondShiftTimeOutFingerprintClose
     FROM hrs_EmployeesClassesWeeklyCustomizeDays AttShD
          INNER JOIN hrs_EmployeesClassesWeeklyCustomize AttSh ON Attsh.id = AttShD.CustomizeID

     WHERE AttSh.EmployeeID = @EmployeeID
           AND @Attandancedate BETWEEN AttSh.BeginDate AND AttSh.EndDate
		   AND  DATEPART(dw, @Attandancedate) = DayNo
		   AND AttSh.CancelDate IS NULL
     ORDER BY AttSh.RegDate DESC
END
ELSE IF((SELECT COUNT(*) FROM hrs_EmployeesClassesWeeklyCustomizeDays AttShD
          INNER JOIN hrs_EmployeesClassesWeeklyCustomize AttSh ON Attsh.id = Attshd.CustomizeID
          INNER JOIN Att_AttendAppointment AttApp ON AttApp.AttendaceShiftID = attsh.EmployeeClassID
          INNER JOIN Att_AttendAppointmentMembers AttAppM ON AttappM.AppointID = AttApp.ID
     WHERE AttAppM.EmployeeID = @EmployeeID
           AND @Attandancedate BETWEEN AttApp.FromDate AND AttApp.ToDate
		   AND  DATEPART(dw, @Attandancedate) = DayNo
		   AND AttAppM.CancelDate IS NULL) > 0)
BEGIN
 SET DATEFORMAT dmy
     SELECT AttShD. DayNo                                AS DayNo,                             
            AttShD.TimeIn1                               AS TimeIn, 
            AttShD.TimeOut1                              AS TimeOut, 
            AttShD.TimeIn2                               AS TimeIn2nd, 
            AttShD.TimeOut2                              AS TimeOut2nd, 
            AttShD.IsDayOff                              AS IsDayOff,
			AttShD.FirstShiftTimeInFingerprintStart       AS FirstShiftTimeInFingerprintStart,
			AttShD.FirstShiftEntryTimeInClose             AS FirstShiftEntryTimeInClose,
			AttShD.FirstShiftTimeOutFingerprintClose      AS FirstShiftTimeOutFingerprintClose,
			AttShD.SecondShiftTimeInFingerprintStart      AS SecondShiftTimeInFingerprintStart,
			AttShD.SecondShiftEntryTimeInClose            AS SecondShiftEntryTimeInClose,
			AttShD.SecondShiftTimeOutFingerprintClose     AS SecondShiftTimeOutFingerprintClose
     FROM hrs_EmployeesClassesWeeklyCustomizeDays AttShD
          INNER JOIN hrs_EmployeesClassesWeeklyCustomize AttSh ON Attsh.id = Attshd.CustomizeID
          INNER JOIN Att_AttendAppointment AttApp ON AttApp.AttendaceShiftID = attsh.EmployeeClassID
          INNER JOIN Att_AttendAppointmentMembers AttAppM ON AttappM.AppointID = AttApp.ID
     WHERE AttAppM.EmployeeID = @EmployeeID
           AND @Attandancedate BETWEEN AttApp.FromDate AND AttApp.ToDate
		   AND  DATEPART(dw, @Attandancedate) = DayNo
		   AND AttAppM.CancelDate IS NULL
     ORDER BY AttApp.RegDate DESC
END
ELSE 
BEGIN
SET DATEFORMAT dmy
     SELECT AttShD. DayNo                                AS DayNo,                             
            AttShD.TimeIn                                AS TimeIn, 
            AttShD.TimeOut                               AS TimeOut, 
            AttShD.TimeIn2nd                             AS TimeIn2nd, 
            AttShD.TimeOut2nd                            AS TimeOut2nd, 
            AttShD.IsDayOff                              AS IsDayOff,
			AttSh.FirstShiftTimeInFingerprintStart       AS FirstShiftTimeInFingerprintStart,
			AttSh.FirstShiftEntryTimeInClose             AS FirstShiftEntryTimeInClose,
			AttSh.FirstShiftTimeOutFingerprintClose      AS FirstShiftTimeOutFingerprintClose,
			AttSh.SecondShiftTimeInFingerprintStart      AS SecondShiftTimeInFingerprintStart,
			AttSh.SecondShiftEntryTimeInClose            AS SecondShiftEntryTimeInClose,
			AttSh.SecondShiftTimeOutFingerprintClose     AS SecondShiftTimeOutFingerprintClose
     FROM Att_AttendShiftDays AttShD
          INNER JOIN Att_AttendShifts AttSh ON Attsh.id = Attshd.AttendShiftID
          INNER JOIN Att_AttendAppointment AttApp ON AttApp.AttendaceShiftID = attsh.id
          INNER JOIN Att_AttendAppointmentMembers AttAppM ON AttappM.AppointID = AttApp.ID
     WHERE AttAppM.EmployeeID = @EmployeeID
           AND @Attandancedate BETWEEN AttApp.FromDate AND AttApp.ToDate
		   AND  DATEPART(dw, @Attandancedate) = DayNo
		   AND AttAppM.CancelDate IS NULL
     ORDER BY AttApp.RegDate DESC
END
Go



IF COL_LENGTH('hrs_Employees', 'WorkE_Mail') IS NULL
BEGIN
    ALTER TABLE hrs_Employees
    add WorkE_Mail varchar(255) null
END
GO

IF COL_LENGTH('hrs_SalaryProductionFiles', 'IsTextFile') IS NULL
BEGIN
   alter table hrs_SalaryProductionFiles
add IsTextFile bit null
END
GO

IF COL_LENGTH('hrs_Projects', 'DepartmentID') IS NULL
BEGIN
   alter table hrs_Projects
add DepartmentID int null
END
GO

CREATE TABLE [dbo].[Hrs_NewEmployee](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[SSNO] [varchar](50) NOT NULL,
	[FirstNameEnglish] [varchar](50) NULL,
	[FatherNameEnglish] [varchar](50) NULL,
	[GrandfatherNameEnglish] [varchar](50) NULL,
	[FamilyNameEnglish] [varchar](50) NULL,
	[FirstNameArabic] [varchar](50) NULL,
	[FatherNameArabic] [varchar](50) NULL,
	[GrandfatherNameArabic] [varchar](50) NULL,
	[FamilyNameArabic] [varchar](50) NULL,
	[BirthDate] [date] NULL,
	[BirthCityID] [int] NULL,
	[NationalityID] [int] NULL,
	[ReligionID] [int] NULL,
	[GenderID] [int] NULL,
	[MaritalStatusID] [int] NULL,
	[BloodGroupID] [int] NULL,
	[PersonalEmail] [varchar](50) NULL,
	[Mobile] [varchar](50) NULL,
	[PassportNo] [varchar](50) NULL,
	[BankID] [int] NULL,
	[IBANNo] [nchar](10) NULL,
	[LastEducationCertificateID] [int] NULL,
	[GraduationDate] [date] NULL,
	[Remarks] [varchar](max) NULL,
	[RegisterDate] [datetime] NULL,
	[IsTransfered] [bit] NULL,
	[TransfereDate] [datetime] NULL,
 CONSTRAINT [PK_Hrs_NewEmployee] PRIMARY KEY CLUSTERED 
(
	[SSNO] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

CREATE TABLE [dbo].[hrs_EmployeesDecisions](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[EmpId] [nchar](10) NOT NULL,
	[Code] [varchar](50) NOT NULL,
	[MaritalStatusID] [int] NULL,
	[BankID] [int] NULL,
	[NationalityID] [int] NULL,
	[BankAccountNumber] [varchar](100) NULL,
	[DepartmentID] [int] NULL,
	[CompanyID] [int] NOT NULL,
	[Remarks] [varchar](2048) NULL,
	[BranchID] [int] NULL,
	[SponsorID] [int] NULL,
	[E_Mail] [varchar](255) NULL,
	[Phone] [varchar](100) NULL,
	[Mobile] [varchar](100) NULL,
	[ManagerID] [int] NULL,
	[SectorID] [int] NULL,
	[PassPortNo] [nvarchar](20) NULL,
	[Cost1] [int] NULL,
	[Cost2] [int] NULL,
	[Cost3] [int] NULL,
	[Cost4] [int] NULL,
	[LocationID] [int] NULL,
	[WorkE_Mail] [varchar](255) NULL,
	[ContractType] [int] NULL,
	[Professions] [int] NULL,
	[Position] [int] NULL,
	[EmployeeClass] [int] NULL,
	[LastEducations] [int] NULL,
	[GraduationDate] [date] NULL,
	[PreviousMaritalStatusID] [int] NULL,
	[PreviousBankID] [int] NULL,
	[PreviousNationalityID] [int] NULL,
	[PreviousBankAccountNumber] [varchar](100) NULL,
	[PreviousDepartmentID] [int] NULL,
	[PreviousCompanyID] [int] NULL,
	[PreviousRemarks] [varchar](2048) NULL,
	[PreviousBranchID] [int] NULL,
	[PreviousSponsorID] [int] NULL,
	[PreviousE_Mail] [varchar](255) NULL,
	[PreviousPhone] [varchar](100) NULL,
	[PreviousMobile] [varchar](100) NULL,
	[PreviousManagerID] [int] NULL,
	[PreviousSectorID] [int] NULL,
	[PreviousPassPortNo] [nvarchar](20) NULL,
	[PreviousCost1] [int] NULL,
	[PreviousCost2] [int] NULL,
	[PreviousCost3] [int] NULL,
	[PreviousCost4] [int] NULL,
	[PreviousLocationID] [int] NULL,
	[PreviousWorkE_Mail] [varchar](255) NULL,
	[PreviousContractType] [int] NULL,
	[PreviousProfessions] [int] NULL,
	[PreviousPosition] [int] NULL,
	[PreviousEmployeeClass] [int] NULL,
	[PreviousLastEducations] [int] NULL,
	[PreviousGraduationDate] [date] NULL,
 CONSTRAINT [PK_hrs_EmployeesDecisions] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

Go

IF COL_LENGTH('hrs_Positions', 'EmployeesNo') IS NULL  
BEGIN
    ALTER TABLE hrs_Positions
    ADD EmployeesNo int
END
GO

IF COL_LENGTH('hrs_Positions', 'ApplyValidation') IS NULL  
BEGIN
    ALTER TABLE hrs_Positions
    ADD ApplyValidation bit
END
GO
IF COL_LENGTH('hrs_Positions', 'PositionBudget') IS NULL  
BEGIN
    ALTER TABLE hrs_Positions
    ADD PositionBudget varchar(5)
END
GO

IF COL_LENGTH('hrs_VacationsTypes', 'RoundAnnualVacBalance') IS NULL  
BEGIN
    ALTER TABLE hrs_VacationsTypes
    ADD RoundAnnualVacBalance bit
END
GO
ALTER TABLE dbo.hrs_EmployeesDecisions ADD
	RegUserID int NULL,
	RegComputerID int NULL,
	RegDate smalldatetime NOT NULL CONSTRAINT DF_hrs_EmployeesDecisions_RegDate DEFAULT (getdate())
GO

IF COL_LENGTH('hrs_VacationsTypes', 'Religion') IS NULL  
BEGIN
    ALTER TABLE hrs_VacationsTypes
    ADD Religion varchar(10)
END
GO
IF COL_LENGTH('Hrs_NewEmployee', 'SSNOIssueDate') IS NULL  
BEGIN
    ALTER TABLE Hrs_NewEmployee
    ADD SSNOIssueDate varchar(50)
END
GO

IF COL_LENGTH('Hrs_NewEmployee', 'SSNOExpireDate') IS NULL  
BEGIN
    ALTER TABLE Hrs_NewEmployee
    ADD SSNOExpireDate varchar(50)
END
GO
IF COL_LENGTH('Hrs_NewEmployee', 'PassportIssueDate') IS NULL  
BEGIN
    ALTER TABLE Hrs_NewEmployee
    ADD PassportIssueDate varchar(50)
END
GO

IF COL_LENGTH('Hrs_NewEmployee', 'PassportExpireDate') IS NULL  
BEGIN
    ALTER TABLE Hrs_NewEmployee
    ADD PassportExpireDate varchar(50)
END
GO
IF COL_LENGTH('Hrs_NewEmployee', 'ProfissionID') IS NULL  
BEGIN
    ALTER TABLE Hrs_NewEmployee
    ADD ProfissionID int
END
GO
IF COL_LENGTH('Hrs_NewEmployee', 'AddressAsPerContract') IS NULL  
BEGIN
    ALTER TABLE Hrs_NewEmployee
    ADD AddressAsPerContract varchar(500)
END
GO
IF COL_LENGTH('hrs_EmployeesDecisions', 'RegUserID') IS NULL  
BEGIN
    ALTER TABLE hrs_EmployeesDecisions
    ADD RegUserID varchar(50)
END
GO

ALTER Proc [dbo].[hrs_FingerprintForCurrntMonth]
@FingerprintID int,
@FromDate DateTime,
@ToDate DateTime
AS
BEGIN
SET DATEFORMAT ymd
 DECLARE
	@ServerIP Varchar(50),
	@DatabaseName Varchar(50),
	@FingerprintTableName Varchar(50),
	@UserIdColumnName Varchar(50),
	@CheckInOutColumnName Varchar(50),
	@Query NVARCHAR (MAX),
	@LastDateFingerPrint DateTime,
	@UsersTableIdntity Varchar(50),
	@UserMatchColumnName Varchar(50),
	@UsersTableName Varchar(50)

SELECT 
	@ServerIP = FingerprintServerIP,
	@DatabaseName = FingerprintDatabaseName,
	@FingerprintTableName = FingerprintTableName,
	@UserIdColumnName = UserIdColumnName,
	@CheckInOutColumnName = CheckInOutColumnName,
	@UsersTableIdntity = UsersTableIdntity,
	@UserMatchColumnName = UserMatchColumnName,
	@UsersTableName = UsersTableName
FROM hrs_FingerprintSettings
WHERE ID = @FingerprintID

SET @ToDate =  DATEADD(DAY, 2, @ToDate) 

IF EXISTS
(
    SELECT name
    FROM sysobjects
    WHERE name = 'hrs_EmployeesFingerprints'
)
BEGIN
    SET DATEFORMAT ymd
	DELETE FROM hrs_EmployeesFingerprints WHERE FingerprintTime BETWEEN @FromDate AND @ToDate

	DECLARE @result TABLE ([FingerprintTime] datetime);

	INSERT INTO @result ([FingerprintTime])
	EXEC (N'SELECT TOP (1) [FingerprintTime] FROM [hrs_EmployeesFingerprints] WHERE [FingerprintID] = ' + @FingerprintID
	    + N' ORDER BY [FingerprintTime] DESC');

	SET @LastDateFingerPrint = (SELECT TOP (1) [FingerprintTime] FROM @result);

	DECLARE @ConvertFromDate varchar(20) 
	DECLARE @ConvertToDate varchar(20) 
	SELECT @ConvertFromDate  = CONVERT(VARCHAR(20), @FromDate, 120)
	SELECT @ConvertToDate  = CONVERT(VARCHAR(20), @ToDate, 120)

	--DELETE FROM hrs_EmployeesFingerprints FOR SPECIFIC PERIOD
	SET @Query = NULL
	SET @Query = N' DELETE FROM hrs_EmployeesFingerprints '
	SET @Query += N' WHERE fp.[' + @CheckInOutColumnName + N'] BETWEEN ''' + @ConvertFromDate + ''''
			    + N' AND ''' + @ConvertToDate + ''''
--	select UserIdColumnName,CheckInOutColumnName,UserMatchColumnName,1 from hrs_FingerprintSettings


	-- INSERT INTO hrs_EmployeesFingerprints FOR SPECIFIC PERIOD
	SET @Query = NULL
	SET @Query = N'INSERT INTO hrs_EmployeesFingerprints ([UserID ],'
			   + N'[FingerprintTime], [UserCode], [FingerprintID])'
			   + N'SELECT  fp.USERID,CHECKTIME,fp.BADGENUMBER,1'
			   + N' FROM [' + @ServerIP + '].[' + @DatabaseName + N']'
			   + N'.[dbo].[' + @FingerprintTableName + N'] AS fp'
			   + N' INNER JOIN [' + @ServerIP + '].[' + @DatabaseName + N'].[dbo].[' + @UsersTableName + N'] AS us'
			   + N' ON fp.[' + @UserIdColumnName + N'] = us.[' + @UsersTableIdntity + N']'


	SET @Query += N' WHERE fp.[' + @CheckInOutColumnName + N'] BETWEEN ''' + @ConvertFromDate + ''''
			    + N' AND ''' + @ConvertToDate + ''''

	EXEC (@Query)

	
    END
END
Go

CREATE TABLE [dbo].[hrs_employeesDecisionsFields](
	[DecisionField] [nvarchar](50) NULL,
	[DecisionAraName] [nvarchar](50) NULL,
	[DecisionEngName] [nvarchar](50) NULL
) ON [PRIMARY]
GO

alter table [dbo].[Hrs_NewEmployee]
add ProfissionID int,
SSNOIssueDate date,
SSNOExpireDate date,
PassportIssueDate date,
PassportExpireDate date,
AddressAsPerContract varchar(50)
Go
alter table [dbo].[hrs_Employees]
add
SSNOIssueDate date,
SSNOExpireDate date,
PassportIssueDate date,
PassportExpireDate date,
AddressAsPerContract varchar(50)
Go
